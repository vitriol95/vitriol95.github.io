<!DOCTYPE html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="스프링 배치 - 6 ItemReader" /><meta property="og:locale" content="ko" /><meta name="description" content="ItemReader" /><meta property="og:description" content="ItemReader" /><link rel="canonical" href="https://vitriol95.github.io/posts/batchbase6/" /><meta property="og:url" content="https://vitriol95.github.io/posts/batchbase6/" /><meta property="og:site_name" content="Vitriol" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-11-06T12:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="스프링 배치 - 6 ItemReader" /><meta name="twitter:site" content="@" /><meta name="google-site-verification" content="QsbP4NOwVkaE8CnHpYOl-qNGhxB9m1RbsrBEefA92ao" /> <script type="application/ld+json"> {"headline":"스프링 배치 - 6 ItemReader","dateModified":"2022-01-02T15:01:10+09:00","datePublished":"2021-11-06T12:00:00+09:00","description":"ItemReader","url":"https://vitriol95.github.io/posts/batchbase6/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://vitriol95.github.io/posts/batchbase6/"},"@context":"https://schema.org"}</script><title>스프링 배치 - 6 ItemReader | Vitriol</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Vitriol"><meta name="application-name" content="Vitriol"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-WSY4XYN711"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-WSY4XYN711'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Vitriol</a></div><div class="site-subtitle font-italic">기억을 적는 시간</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/vitriol95" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['vitriol951','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>스프링 배치 - 6 ItemReader</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>스프링 배치 - 6 ItemReader</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> vitriol </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Nov 6, 2021, 12:00 PM +0900" prep="on" > Nov 6, 2021 <i class="unloaded">2021-11-06T12:00:00+09:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Jan 2, 2022, 3:01 PM +0900" prefix="Updated " > Jan 2 <i class="unloaded">2022-01-02T15:01:10+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4133 words">22 min</span></div></div><div class="post-content"><h1 id="itemreader">ItemReader</h1><p>이전시간에 청크 지향방식 태스크에 대해 이야기를 해보았는데, 총 3가지 과정으로 나누어지는 것을 확인했다. 이번엔 이중 <code class="language-plaintext highlighter-rouge">Reader</code>에 대해 좀 더 들어가보자.</p><h2 id="기본-개념">기본 개념</h2><p>다양한 입력으로부터 데이터를 읽어 제공하는 인터페이스에 해당한다. 지원하는 종류는 다음과 같다.</p><ul><li>FlatFile (csv,txt)<li>XML, JSON<li><strong>DataBase</strong><li>JMS, RabbitMQ 같은 MQ<li>Custom Reader</ul><p>일종의 큰 맥락을 보면 아래 그림과 같이 정리된다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/batch/20.png" /></p><p>굉장히 방대하고 양도 많다.. 여기서 <code class="language-plaintext highlighter-rouge">ItemReader&lt;T&gt;</code>는 <code class="language-plaintext highlighter-rouge">read()</code>메서드 하나를 가지고있으며 <code class="language-plaintext highlighter-rouge">ItemStream</code> 인터페이스는 스트림을 열고 닫으며 업데이트하는 핸들러들을 제공한다.</p><p><br /></p><p>다수의 구현체들이 두가지 인터페이스를 모두 구현하고 있으며 앞서 지원한 파일형태나 DB에 연결하기 위한 커넥션, 스트림열기, 입력장치 초기화등을 모두 지원한다. 이들중 우리가 눈여겨 보아야할 것은 두개가 존재한다</p><ul><li><code class="language-plaintext highlighter-rouge">****CursorItemReader</code><li><code class="language-plaintext highlighter-rouge">****PagingItemReader</code></ul><p>이 두가지 Reader가 이번 주제의 메인 디쉬가 될 것이다.</p><h2 id="abstractitemcountingitemstreamreader">AbstractItemCountingItemStreamReader</h2><p>앞선 포스트에서 <code class="language-plaintext highlighter-rouge">ChunkProvider</code>를 보면, 결국 마지막에는 등록한 ItemReader에게 read작업을 위임해주고 있다. 이 ItemReader의 종류에 따라 읽는 방식이 달라진다는 것을 의미하는데, 이중 쓰이는 대표적인 추상클래스중 하나인 <code class="language-plaintext highlighter-rouge">AbstractItemCountingItemStreamReader</code>를 살펴볼 것이다.</p><blockquote><p>앞선 그림 계층도를 보면 우리가 쓸 대부분의 클래스들이 해당 추상클래스를 구현하고 있다. 따라서 기본 동작구조를 알아볼 생각이다.</p></blockquote><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractItemCountingItemStreamItemReader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">AbstractItemStreamItemReader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>

	<span class="c1">// ... </span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">currentItemCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">maxItemCount</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>

    <span class="nd">@Nullable</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="no">T</span> <span class="nf">read</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">,</span> <span class="nc">UnexpectedInputException</span><span class="o">,</span> <span class="nc">ParseException</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">currentItemCount</span> <span class="o">&gt;=</span> <span class="n">maxItemCount</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="n">currentItemCount</span><span class="o">++;</span>
		<span class="no">T</span> <span class="n">item</span> <span class="o">=</span> <span class="n">doRead</span><span class="o">();</span>
		<span class="k">if</span><span class="o">(</span><span class="n">item</span> <span class="k">instanceof</span> <span class="nc">ItemCountAware</span><span class="o">)</span> <span class="o">{</span>
			<span class="o">((</span><span class="nc">ItemCountAware</span><span class="o">)</span> <span class="n">item</span><span class="o">).</span><span class="na">setItemCount</span><span class="o">(</span><span class="n">currentItemCount</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">item</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="nd">@Nullable</span>
	<span class="kd">protected</span> <span class="kd">abstract</span> <span class="no">T</span> <span class="nf">doRead</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>
</pre></table></code></div></div><p>템플릿 메서드 패턴처럼 <code class="language-plaintext highlighter-rouge">doRead()</code>는 구현체에게 넘기고있다. 이제 읽는 2가지 방식을 알아보고 대표적인 구체클래스들로 넘어가보자.</p><h2 id="cursor-vs-paging">Cursor vs Paging</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/batch/21.png" /></p><p>대표적인 DB ItemReader로는 <strong>Cursor Based</strong>와 <strong>Paging Based</strong>가 존재한다. 여기서 <code class="language-plaintext highlighter-rouge">PageSize</code>와 <code class="language-plaintext highlighter-rouge">ChunkSize</code>는 서로 의미하는 것이 다르다는 것을 알아야한다.</p><ul><li><code class="language-plaintext highlighter-rouge">ChunkSize</code>는 한번에 처리될 트랜잭션의 단위를 의미하며<li><code class="language-plaintext highlighter-rouge">PageSize</code>는 한번에 조회할 Item의 양을 의미한다.<blockquote><p>따라서 하나의 청크 안에서도 여러 페이지가 존재할 수 있다.</p></blockquote></ul><p>가장먼저, Cursor로 작동하는 대표적인 Reader인 <code class="language-plaintext highlighter-rouge">JdbcCusorItemReader&lt;T&gt;</code>를 살펴볼 것이다.</p><h2 id="cusoritemreader">CusorItemReader</h2><h3 id="jdbccursoritemreader">JdbcCursorItemReader</h3><p>계층도를 살펴보니 <code class="language-plaintext highlighter-rouge">AbstractCursorItemReader&lt;T&gt;</code>를 상속하고 있다. 이를 먼저 확인해야겠다. <code class="language-plaintext highlighter-rouge">doRead()</code>메서드를 기준으로 보면된다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractCursorItemReader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">AbstractItemCountingItemStreamItemReader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span>
<span class="kd">implements</span> <span class="nc">InitializingBean</span> <span class="o">{</span>
    
    <span class="c1">//...</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="no">T</span> <span class="nf">doRead</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">rs</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ReaderNotOpenException</span><span class="o">(</span><span class="s">"Reader must be open before it can be read."</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(!</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="kt">int</span> <span class="n">currentRow</span> <span class="o">=</span> <span class="n">getCurrentItemCount</span><span class="o">();</span>
			<span class="no">T</span> <span class="n">item</span> <span class="o">=</span> <span class="n">readCursor</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">currentRow</span><span class="o">);</span>
			<span class="n">verifyCursorPosition</span><span class="o">(</span><span class="n">currentRow</span><span class="o">);</span>
			<span class="k">return</span> <span class="n">item</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">se</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="nf">getExceptionTranslator</span><span class="o">().</span><span class="na">translate</span><span class="o">(</span><span class="s">"Attempt to process next row failed"</span><span class="o">,</span> <span class="n">getSql</span><span class="o">(),</span> <span class="n">se</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="kd">abstract</span> <span class="no">T</span> <span class="nf">readCursor</span><span class="o">(</span><span class="nc">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">currentRow</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>rs(ResultSet)을 기준으로 <code class="language-plaintext highlighter-rouge">next()</code>를 호출하여 다음 튜플을 확인하고 커서를 옮기어 <code class="language-plaintext highlighter-rouge">currentRow</code>를 하나씩 가져오고 있음을 알 수 있다. 그리고 <code class="language-plaintext highlighter-rouge">readCursor()</code>메서드를 세부 구현체에 넘기고 있다.</p><p><br /></p><p>이외에도 코드엔 포함되지 않았지만 해당 클래스는 많은 일을 해준다. ItemStream의 메서드들(<code class="language-plaintext highlighter-rouge">doOpen()</code>,<code class="language-plaintext highlighter-rouge">doClose()</code>) 등을 구현하여 커넥션에 대한 기초작업또한 진행해준다. 이제 <code class="language-plaintext highlighter-rouge">JdbcCusorItemReader</code>를 만나러 가보자.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcCursorItemReader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">AbstractCursorItemReader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;{</span>
    <span class="c1">// ...</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="no">T</span> <span class="nf">readCursor</span><span class="o">(</span><span class="nc">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">currentRow</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">rowMapper</span><span class="o">.</span><span class="na">mapRow</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">currentRow</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><p>생각보다 정말 단순하다. <code class="language-plaintext highlighter-rouge">readCursor()</code>는 <strong>rowMapper</strong>를 이용해 설정한 지네릭타입으로 값을 리턴해주고있었다. 앞선 코드와 함께 보면 유기적으로 이해가 될 것이다.</p><h3 id="예시코드">예시코드</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">ItemReader</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="nf">customItemReader</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">JdbcCursorItemReaderBuilder</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"jdbcCursorItemReader"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">fetchSize</span><span class="o">(</span><span class="n">chunk_size</span><span class="o">)</span>
            <span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select id, firstName, lastName, birthdate from customer where firstName like ? order by lastName, firstName"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">beanRowMapper</span><span class="o">(</span><span class="nc">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">queryArguments</span><span class="o">(</span><span class="s">"A%"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">dataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p>다음은 <code class="language-plaintext highlighter-rouge">JdbcCursorItemReader</code>를 이용해 구현해본 ItemReader에 해당한다. 여기서 <code class="language-plaintext highlighter-rouge">fetchSize</code>는 청크사이즈와 같게해야하며, 리턴타입 및 sql등을 줄 수 있다.</p><blockquote><p>fetchSize는 메모리에 올려둘 사이즈에 해당한다. 대부분은 청크사이즈와 크기를 동일시하여 설정한다.</p></blockquote><h3 id="jpacursoritemreader">JpaCursorItemReader</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/batch/22.png" /></p><p>앞선 Jdbc와 별다를 것은 없다. 하지만, Jpa의 경우 <code class="language-plaintext highlighter-rouge">EntityManager</code>기반으로 일종의 상태관리를 진행하므로 이에대한 설정들이 포함되어있다. 내부적으로 동작하는 것은 Jdbc기반이므로 똑같다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">ItemReader</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="nf">customItemReader</span><span class="o">()</span> <span class="o">{</span>

    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"firstName"</span><span class="o">,</span> <span class="s">"A%"</span><span class="o">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nc">JpaCursorItemReaderBuilder</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"jpaCursorItemBuilder"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">entityManagerFactory</span><span class="o">(</span><span class="n">emf</span><span class="o">)</span>
            <span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="s">"select c from Customer c where firstname like :firstname"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">parameterValues</span><span class="o">(</span><span class="n">params</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p>이처럼 <code class="language-plaintext highlighter-rouge">.entityManagerFactory()</code>를 따로 설정해주면 되며, sql의 경우 JPQL을 사용해도 된다!</p><h2 id="pagingitemreader">PagingItemReader</h2><p>이제 Paging차례이다. 가장 먼저 기본이 되는 <code class="language-plaintext highlighter-rouge">AbstractPagingItemReader&lt;T&gt;</code>를 살펴보는 것부터 시작해보자.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractPagingItemReader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">AbstractItemCountingItemStreamItemReader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> 
        <span class="kd">implements</span> <span class="nc">InitializingBean</span> <span class="o">{</span>

    <span class="nd">@Nullable</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="no">T</span> <span class="nf">doRead</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

		<span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>

			<span class="k">if</span> <span class="o">(</span><span class="n">results</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">current</span> <span class="o">&gt;=</span> <span class="n">pageSize</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Reading page "</span> <span class="o">+</span> <span class="n">getPage</span><span class="o">());</span>
				<span class="o">}</span>

				<span class="n">doReadPage</span><span class="o">();</span>
				<span class="n">page</span><span class="o">++;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">&gt;=</span> <span class="n">pageSize</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">current</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
				<span class="o">}</span>

			<span class="o">}</span>

			<span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="n">current</span><span class="o">++;</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">&lt;</span> <span class="n">results</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">next</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
			<span class="o">}</span>

		<span class="o">}</span>

	<span class="o">}</span>

	<span class="kd">abstract</span> <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doReadPage</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p>뭔가 재밌는걸 눈치 챘을 것이다. 바로 <code class="language-plaintext highlighter-rouge">synchronized()</code>로 블록처리가 되어 동시성제어를 진행하고 있다는 것이다. 해당 메서드 외에도 여러 구체메서드에는 <code class="language-plaintext highlighter-rouge">synchronized()</code>가 걸려있기에 Thread 안정성을 보장해주고 있다.</p><p><br /></p><p>이후, 실제 읽어오는 부분은 <code class="language-plaintext highlighter-rouge">doReadPage()</code>로 구체 클래스에게 맡기고있다.</p><h3 id="jdbcpagingitemreader">JdbcPagingItemReader</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcPagingItemReader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">AbstractPagingItemReader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">InitializingBean</span> <span class="o">{</span>
    <span class="nd">@Override</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doReadPage</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">results</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">results</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;&gt;();</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="n">results</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="nc">PagingRowMapper</span> <span class="n">rowCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PagingRowMapper</span><span class="o">();</span>

		<span class="nc">List</span><span class="o">&lt;?&gt;</span> <span class="n">query</span><span class="o">;</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">getPage</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"SQL used for reading first page: ["</span> <span class="o">+</span> <span class="n">firstPageSql</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">parameterValues</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">parameterValues</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">queryProvider</span><span class="o">.</span><span class="na">isUsingNamedParameters</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">query</span> <span class="o">=</span> <span class="n">namedParameterJdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">firstPageSql</span><span class="o">,</span>
							<span class="n">getParameterMap</span><span class="o">(</span><span class="n">parameterValues</span><span class="o">,</span> <span class="kc">null</span><span class="o">),</span> <span class="n">rowCallback</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="n">query</span> <span class="o">=</span> <span class="n">getJdbcTemplate</span><span class="o">().</span><span class="na">query</span><span class="o">(</span><span class="n">firstPageSql</span><span class="o">,</span>
							<span class="n">getParameterList</span><span class="o">(</span><span class="n">parameterValues</span><span class="o">,</span> <span class="kc">null</span><span class="o">).</span><span class="na">toArray</span><span class="o">(),</span> <span class="n">rowCallback</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="n">query</span> <span class="o">=</span> <span class="n">getJdbcTemplate</span><span class="o">().</span><span class="na">query</span><span class="o">(</span><span class="n">firstPageSql</span><span class="o">,</span> <span class="n">rowCallback</span><span class="o">);</span>
			<span class="o">}</span>

		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="n">previousStartAfterValues</span> <span class="o">=</span> <span class="n">startAfterValues</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"SQL used for reading remaining pages: ["</span> <span class="o">+</span> <span class="n">remainingPagesSql</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">queryProvider</span><span class="o">.</span><span class="na">isUsingNamedParameters</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">query</span> <span class="o">=</span> <span class="n">namedParameterJdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">remainingPagesSql</span><span class="o">,</span>
						<span class="n">getParameterMap</span><span class="o">(</span><span class="n">parameterValues</span><span class="o">,</span> <span class="n">startAfterValues</span><span class="o">),</span> <span class="n">rowCallback</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="n">query</span> <span class="o">=</span> <span class="n">getJdbcTemplate</span><span class="o">().</span><span class="na">query</span><span class="o">(</span><span class="n">remainingPagesSql</span><span class="o">,</span>
						<span class="n">getParameterList</span><span class="o">(</span><span class="n">parameterValues</span><span class="o">,</span> <span class="n">startAfterValues</span><span class="o">).</span><span class="na">toArray</span><span class="o">(),</span> <span class="n">rowCallback</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="nc">Collection</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;)</span> <span class="n">query</span><span class="o">;</span>
		<span class="n">results</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>위 흐름을 좀 더 깔끔한 그림으로 정리해보면 다음과 같다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/batch/23.png" /></p><p><code class="language-plaintext highlighter-rouge">JdbcTemplate</code>를 이용하여 resultSet의 페이지크기만큼 가져와 이를 돌려주고 있는 방식이다.</p><blockquote><p>사실 코드 읽는것이 좀 어려웠다.. 직접 사용처에서 코드를 보자.</p></blockquote><h3 id="예시코드-1">예시코드</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">JdbcPagingItemReader</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="nf">pagingItemReader</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"firstname"</span><span class="o">,</span><span class="s">"Rose"</span><span class="o">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nc">JdbcPagingItemReaderBuilder</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;()</span>
        <span class="o">.</span><span class="na">pageSize</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
        <span class="o">.</span><span class="na">fetchSize</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
        <span class="o">.</span><span class="na">dataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">)</span>
        <span class="o">.</span><span class="na">rowMapper</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanPropertyRowMapper</span><span class="o">&lt;&gt;(</span><span class="nc">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
        <span class="o">.</span><span class="na">queryProvider</span><span class="o">(</span><span class="n">createQueryProvider</span><span class="o">())</span>
        <span class="o">.</span><span class="na">parameterValues</span><span class="o">(</span><span class="n">params</span><span class="o">)</span>
        <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"myJdbcPageReader"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">PagingQueryProvider</span> <span class="nf">createQueryProvider</span><span class="o">(){</span>
    <span class="nc">SqlPagingProviderFactoryBean</span> <span class="n">queryProvider</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SqlPagingProviderFactoryBean</span><span class="o">();</span>
    <span class="n">queryProvider</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="n">queryProvider</span><span class="o">.</span><span class="na">setSelectClause</span><span class="o">(</span><span class="s">"id, firstname, lastName, birthdate"</span><span class="o">);</span>
    <span class="n">queryProvider</span><span class="o">.</span><span class="na">setFromClause</span><span class="o">(</span><span class="s">"from customer"</span><span class="o">);</span>
    <span class="n">queryProvider</span><span class="o">.</span><span class="na">setWhereClause</span><span class="o">(</span><span class="s">"where firstname &gt;= :firstname"</span><span class="o">);</span>

    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">sortKeys</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">sortKeys</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span><span class="nc">Order</span><span class="o">.</span><span class="na">ASCENDING</span><span class="o">);</span>

    <span class="n">qeuryProvider</span><span class="o">.</span><span class="na">setSortKeys</span><span class="o">(</span><span class="n">sortKeys</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">queryProvider</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">.queryProvider()</code> API를 이용하여 좀 더 쉽게 쿼리를 처리해주는 기능도 제공하니 편리하다. 여기서는 페이지 사이즈와 청크사이즈를 같게하여 진행했는데, 이는 꼭 필수사항은 아니다.</p><blockquote><p>하지만 Jpa를 사용할땐 주의해야한다. 이는 나중에 설명하겠다.</p></blockquote><p>위 설정으로 Read를 진행한다면 다음과 같은 쿼리가 나갈 것이다.</p><div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">firstname</span><span class="p">,</span> <span class="n">lastname</span><span class="p">,</span> <span class="n">birthdate</span>
<span class="k">FROM</span> <span class="n">customer</span>
<span class="k">WHERE</span> <span class="n">firstname</span> <span class="o">&gt;=</span> <span class="s1">'Rose'</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">id</span> <span class="k">ASC</span> <span class="k">LIMIT</span> <span class="mi">100</span>
</pre></table></code></div></div><p>그리고 dataSource를 등록해주고 있는것을 확인할 수 있는데, 이는 당연한것인게 DB 별로 페이징 쿼리가 다르기 때문이다. (Oracle, MySQL 등등..) 해당 Reader는 이런 DB종류에 따른 페이징 쿼리를 맞게 짜준다.</p><h3 id="jpapagingitemreader">JpaPagingItemReader</h3><p>Jdbc보다 코드 읽는게 쉬워서 해당 클래스의 <code class="language-plaintext highlighter-rouge">doRead()</code>를 보며 흐름을 파악하는게 더 수월했다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doReadPage</span><span class="o">()</span> <span class="o">{</span>

		<span class="nc">EntityTransaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		
		<span class="k">if</span> <span class="o">(</span><span class="n">transacted</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">tx</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">();</span>
			<span class="n">tx</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
			
			<span class="n">entityManager</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
			<span class="n">entityManager</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">createQuery</span><span class="o">().</span><span class="na">setFirstResult</span><span class="o">(</span><span class="n">getPage</span><span class="o">()</span> <span class="o">*</span> <span class="n">getPageSize</span><span class="o">()).</span><span class="na">setMaxResults</span><span class="o">(</span><span class="n">getPageSize</span><span class="o">());</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">parameterValues</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">me</span> <span class="o">:</span> <span class="n">parameterValues</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="n">me</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">me</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">results</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">results</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;&gt;();</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="n">results</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
		<span class="o">}</span>
		
		<span class="k">if</span> <span class="o">(!</span><span class="n">transacted</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">queryResult</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
			<span class="k">for</span> <span class="o">(</span><span class="no">T</span> <span class="n">entity</span> <span class="o">:</span> <span class="n">queryResult</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">entityManager</span><span class="o">.</span><span class="na">detach</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
				<span class="n">results</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">results</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">());</span>
			<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">Query query = createQuery().setFirstResult(getPage() * getPageSize()).setMaxResults(getPageSize());</code> 부분을 보면 Page만큼 추가 조회를 하는것을 알 수 있고, <code class="language-plaintext highlighter-rouge">results.addAll(query.getResultList());</code>를 통해 청크안에 페이지단위로 아이템을 집어넣어준다.</p><h2 id="추가-이슈">추가 이슈</h2><p>PageSize와 ChunkSize가 다른경우도 존재할 수 있다. 만약 후자가 100이고, 전자가 10이라면 <code class="language-plaintext highlighter-rouge">ItemReader</code>에서 Page조회가 10번 일어나야 한번의 트랜잭션이 발생해 Chunk처리가 된다.</p><p><br /></p><p>이렇게 한번의 트랜잭션 처리를 위해서 10번의 조회하는 쿼리가 발생하기에 성능이슈가 일어날 수 있다. 따라서 <code class="language-plaintext highlighter-rouge">PagingItemReader</code>의 클래스엔 다음과 같은 주석이 있는 것을 확인할 수 있다.</p><p><br /></p><p><strong><code class="language-plaintext highlighter-rouge">Setting a fairly large page size and using a commit interval that matches the page size should provide better performance.</code></strong></p><p><br /></p><p>결국 청크사이즈와 일치하는 페이지 크기를 사용하면 성능향상을 기대할 수 있다는 말이다. 이외에도 JPA와 함께 사용할 경우 영속성 컨텍스트관련 이슈또한 만날 수 있다.</p><h3 id="jpa-영속성이슈-with-pagingitemreader">JPA 영속성이슈 with PagingItemReader</h3><p>JPA의 경우 <code class="language-plaintext highlighter-rouge">EntityManager</code>를 통해 엔티티들의 영속성을 관리해주며 이 과정은 당연히 배치에도 적용이 된다. 다음의 코드를 보자.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JobInstConfiguration</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JobBuilderFactory</span> <span class="n">jobBuilderFactory</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">StepBuilderFactory</span> <span class="n">stepBuilderFactory</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">EntityManagerFactory</span> <span class="n">emf</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Job</span> <span class="nf">batchJob1</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"batchJob1"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">step1</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Step</span> <span class="nf">step1</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">stepBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"step1"</span><span class="o">)</span>
                <span class="o">.&lt;</span><span class="nc">Customer</span><span class="o">,</span> <span class="nc">History</span><span class="o">&gt;</span><span class="n">chunk</span><span class="o">(</span><span class="n">chunk_size</span><span class="o">)</span>
                <span class="o">.</span><span class="na">reader</span><span class="o">(</span><span class="n">customItemReader</span><span class="o">())</span>
                <span class="o">.</span><span class="na">processor</span><span class="o">(</span><span class="n">customProcessor</span><span class="o">())</span>
                <span class="o">.</span><span class="na">writer</span><span class="o">(</span><span class="n">customItemWriter</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ItemReader</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="nf">customItemReader</span><span class="o">()</span> <span class="o">{</span>

        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"firstName"</span><span class="o">,</span> <span class="s">"A%"</span><span class="o">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nc">JpaCursorItemReaderBuilder</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;()</span>
                <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"jpaCursorItemBuilder"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">entityManagerFactory</span><span class="o">(</span><span class="n">emf</span><span class="o">)</span>
                <span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="s">"select c from Customer c where firstname like :firstname"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">parameterValues</span><span class="o">(</span><span class="n">params</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
                <span class="c1">// 기본 페이지 사이즈는 10건</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ItemProcessor</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">,</span><span class="nc">History</span><span class="o">&gt;</span> <span class="nf">customProcessor</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">customer</span> <span class="o">-&gt;</span> <span class="nc">History</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">customerId</span><span class="o">(</span><span class="n">customer</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
            <span class="o">.</span><span class="na">purchaseList</span><span class="o">(</span><span class="n">customer</span><span class="o">.</span><span class="na">getPurchaseList</span><span class="o">())</span>
            <span class="o">.</span><span class="na">build</span><span class="o">()</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ItemWriter</span><span class="o">&lt;</span><span class="nc">History</span><span class="o">&gt;</span> <span class="nf">customItemWriter</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">items</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Customer</span> <span class="n">item</span> <span class="o">:</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
            <span class="o">}</span> <span class="c1">// 그냥 출력만</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>청크사이즈는 100이며 페이지 사이즈는 10이므로 10번이 한번의 청크를 이룬다. 여기서 Customer과 History라는 도메인이 등장한다. History의 경우 기록용 클래스이므로 무시하고, Customer는 다음과 같은 필드를 가지고있다고 하자.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="nd">@Getter</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Customer</span> <span class="o">{</span>

    <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">firstname</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lastname</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">birthdate</span><span class="o">;</span>

    <span class="nd">@OneToMany</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Purchase</span><span class="o">&gt;</span> <span class="n">purchaseList</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Purchase라는 새로운 도메인과 1:M매핑이 되어있다. 여기서 <code class="language-plaintext highlighter-rouge">reader</code>로부터 <code class="language-plaintext highlighter-rouge">processor</code>까지 넘어갈때 영속성이 유지되어야 해당 <code class="language-plaintext highlighter-rouge">@OneToMany</code>인 purchaseList속성이 History클래스로 매핑될 수 있다. <strong>하지만 이 과정이 정말 잘 될까?</strong></p><p><br /></p><p>위와 같은 배치를 실제로 실행시켜보면 다음과 같은 오류를 만난다. <code class="language-plaintext highlighter-rouge">org.hibernate.LazyInitializationException: failed to lazily initialize a collection of role:~~</code> Processor의 Customer -&gt; History로 transform 하는 과정중에 <code class="language-plaintext highlighter-rouge">getPurchaseList()</code>에서 LazyInitialize가 되지 않기 때문이다.</p><h3 id="이유는">이유는?</h3><p>기본적으로 위 이슈가 발현된 이유는 우리가 설정해준 <code class="language-plaintext highlighter-rouge">ChunkSize</code>와 <code class="language-plaintext highlighter-rouge">PageSize</code>가 다르기 때문이다.</p><blockquote><p>위에서 <strong>PageSize 조절하는 코드는 못봤는데요</strong>? 라고 물을 수 있지만 <code class="language-plaintext highlighter-rouge">AbstractPagingItemReader&lt;T&gt;</code>를 확인하면 기본 <code class="language-plaintext highlighter-rouge">pageSize</code>는 10으로 되어있다. 이 값이 Default에 해당한다.</p></blockquote><p>따라서 <code class="language-plaintext highlighter-rouge">JpaPagingItemReader</code>는 100의 <code class="language-plaintext highlighter-rouge">ChunkSize</code>를 채우기 위해 10개가 들어있는 페이지를 10번의 반복 진행하여 Chunk를 채우고 프로세스에게 넘겨주게 된다.</p><p><br /></p><p><code class="language-plaintext highlighter-rouge">JpaPagingItemReader</code>의 <code class="language-plaintext highlighter-rouge">doReadPage()</code>메서드를 다시한번 확인하자.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doReadPage</span><span class="o">()</span> <span class="o">{</span>

	<span class="nc">EntityTransaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	
	<span class="k">if</span> <span class="o">(</span><span class="n">transacted</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">();</span>
		<span class="n">tx</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
		
		<span class="n">entityManager</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
		<span class="n">entityManager</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="c1">// ... </span>
</pre></table></code></div></div><p>이 메서드는 페이지 단위로 읽어올때 실행되는 일종의 Iteration되는 메서드에 해당한다. transaction의 상태를 측정하는 <code class="language-plaintext highlighter-rouge">transacted</code>의 값이 true일 경우 해당 로직으로 들어오게되는데, 이때 <code class="language-plaintext highlighter-rouge">entityManager.flush(); entityManager.clear();</code> 를 호출한다. <strong>즉, 영속성 매니저를 초기화 시켜버린다는 것이다.</strong></p><p><br /></p><p>따라서 마지막 페이지를 제외한 1~9 번째 페이지는 LazyLoading을 진행하지 못하게 된다.</p><blockquote><p>아예 프록시 객체도 꽂혀있지 않아 이러한 Exception이 발생되는 것이다.</p></blockquote><p>하지만 마지막 10번째 페이지의 경우, entityManager가 살아있는 상태로 전달이 되므로 Processor에서 이에 대한 LazyLoading을 진행할 수 있다. (relation이 있는 프록시 객체가 꽂혀있다.)</p><h3 id="해결방법">해결방법</h3><p>해결방법은 정말 단순하게도 <code class="language-plaintext highlighter-rouge">ChunkSize == PageSize</code>를 맞추어주는 것이다. 그 외에는 <code class="language-plaintext highlighter-rouge">AbstractPagingItemReader&lt;T&gt;</code>를 새로 상속하여 임의의 클래스를 만들어 직접 <code class="language-plaintext highlighter-rouge">entityManager</code>를 관리해주는 방법이 있다.</p><blockquote><p>엔티티매니저의 flush나 clear에 대한 시점을 직접 설정해야하는 것이다.</p></blockquote><h3 id="더-나아가면">더 나아가면</h3><p>LazyLoading을 진행하면 모든 <code class="language-plaintext highlighter-rouge">Customer</code>마다 연결되어있는 <code class="language-plaintext highlighter-rouge">Purchase</code>들의 Proxy를 깨워 해당 매핑을 완료지을 것이다. 이때 하나의 <code class="language-plaintext highlighter-rouge">Customer</code>당 <code class="language-plaintext highlighter-rouge">Purchase</code>개수만큼 SELECT쿼리를 날려 가져오는데, 이때 <code class="language-plaintext highlighter-rouge">spring.jpa.properties.hibernate.default_batch_fetch_size</code> 옵션을 주면 in query로 한번에 가져온다.</p><blockquote><p>fetch Join과 함께 대표적인 N+1 문제를 해결할 수 있는 솔루션이다.</p></blockquote><blockquote><p>이외에도 <code class="language-plaintext highlighter-rouge">@BatchSize</code>어노테이션을 주어도 된다.</p></blockquote><h3 id="더-나아가면-2">더 나아가면 2</h3><p>그러면 여기서 궁금증이 하나 든다,</p><blockquote><p>아니 생각해보니까 <code class="language-plaintext highlighter-rouge">JpaCursorItemReader</code>도 있잖아? 얘는 어떻게 영속성 유지를 하는거지?</p></blockquote><p>사실 <code class="language-plaintext highlighter-rouge">JpaCursorItemReader</code>은 최근들어(스프링 배치 4.3) 도입된 클래스에 해당한다. 이 기능이 작동되게끔 하는 원리는 <code class="language-plaintext highlighter-rouge">doOpen()</code>메서드를 통해 보면 알 수 있다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doOpen</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
	<span class="k">this</span><span class="o">.</span><span class="na">entityManager</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">entityManagerFactory</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">entityManager</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">DataAccessResourceFailureException</span><span class="o">(</span><span class="s">"Unable to create an EntityManager"</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">queryProvider</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">queryProvider</span><span class="o">.</span><span class="na">setEntityManager</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">entityManager</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">createQuery</span><span class="o">();</span>
	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">parameterValues</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">parameterValues</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nl">query:</span><span class="o">:</span><span class="n">setParameter</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">this</span><span class="o">.</span><span class="na">iterator</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultStream</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="no">T</span> <span class="nf">doRead</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">?</span> <span class="k">this</span><span class="o">.</span><span class="na">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">doOpen()</code>의 마지막줄을 보면 <code class="language-plaintext highlighter-rouge">query.getResultStream()</code>을통해 resultStream을 뽑아낸다. jdbc의 ResultSet과 비슷한 개념으로, 이는 JPA에서도 데이터 스트림을 뽑아낸다는 것을 의미한다.</p><blockquote><p>해당 기능은 JPA 2.2 이후부터 지원했다. 자세한 정보는 <a href="https://github.com/eclipse-ee4j/jpa-api/issues/99">여기</a>에서 찾을 수 있다.</p></blockquote><h1 id="출처">출처</h1><ul><li><a href="https://jojoldu.tistory.com/146?category=902551">기억보다 기록을 - Spring Batch에서 영속성 컨텍스트 문제</a><li><a href="https://jojoldu.tistory.com/551">기억보다 기록을 - Spring Batch JpaCursorItemReader 도입되다</a><li><a href="https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-%EB%B0%B0%EC%B9%98">Spring Batch 강의 - 정수원님</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/spring/'>Spring</a>, <a href='/categories/batch/'>batch</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring/" class="post-tag no-text-decoration" >spring</a> <a href="/tags/springboot/" class="post-tag no-text-decoration" >springboot</a> <a href="/tags/batch/" class="post-tag no-text-decoration" >batch</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=스프링 배치 - 6 ItemReader - Vitriol&url=https://vitriol95.github.io/posts/batchbase6/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=스프링 배치 - 6 ItemReader - Vitriol&u=https://vitriol95.github.io/posts/batchbase6/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=스프링 배치 - 6 ItemReader - Vitriol&url=https://vitriol95.github.io/posts/batchbase6/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/batchbase1/">스프링 배치 - 1 스프링 배치란?</a><li><a href="/posts/batchbase2/">스프링 배치 - 2 DB 스키마에 대한 이해</a><li><a href="/posts/batchbase3/">스프링 배치 - 3 도메인 뜯어보기(JOB)</a><li><a href="/posts/batchbase4/">스프링 배치 - 4 도메인 뜯어보기(STEP)</a><li><a href="/posts/batchbase5/">스프링 배치 - 5 청크 지향 처리</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/batchbase1/"><div class="card-body"> <span class="timeago small" > Nov 1, 2021 <i class="unloaded">2021-11-01T12:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 배치 - 1 스프링 배치란?</h3><div class="text-muted small"><p> 스프링 배치 깊은 부분까지 파고들어가 볼 생각이다. 배치에 대한 기초적인 아이디어의 경우(왜 필요한지, 어떻게 활용 되는지에 대한) 창천향로님의 블로그 기억보단 기록을 를 참고하면 큰 도움이 된다! 해당 글 시리즈는 Inflearn에 있는 Spring Batch 강의 - 정수원님를 들으며 강의 내용들을 정리한 것에 해당한다. 강추하는 강의...</p></div></div></a></div><div class="card"> <a href="/posts/batchbase2/"><div class="card-body"> <span class="timeago small" > Nov 2, 2021 <i class="unloaded">2021-11-02T12:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 배치 - 2 DB 스키마에 대한 이해</h3><div class="text-muted small"><p> 난 테이블을 생성한적 없는데.. 이러한 테이블들은 모두 스프링 배치의 실행 + 관리에 대한 정보를 삼기 위해 만들어진다. 예를 들어 잡이 실패했는지 성공했는지에 대한 여부부터, Context에 대한 세세한 정보까지 제공해 주게 된다. DB 스키마에 대하여 설정 spring.batch.jdbc.initialize-schema설정을 통해 끄고 켤 ...</p></div></div></a></div><div class="card"> <a href="/posts/batchbase3/"><div class="card-body"> <span class="timeago small" > Nov 3, 2021 <i class="unloaded">2021-11-03T12:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 배치 - 3 도메인 뜯어보기(JOB)</h3><div class="text-muted small"><p> JOB 먼저, 배치에서 가장 큰 단위인 JOB을 보도록 하자! 큰 흐름은 위와 같이 그림으로 정리된다. JOB은 이름을 가지며 재시작이 가능하고(restartable) JobRepository가 지정되어있다. 앞선 테이블 스키마에서 살펴본 INSTANCE,EXECUTION에 대한 정보를 쌓아야하므로 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/batchbase5/" class="btn btn-outline-primary" prompt="Older"><p>스프링 배치 - 5 청크 지향 처리</p></a> <a href="/posts/batchbase7/" class="btn btn-outline-primary" prompt="Newer"><p>스프링 배치 - 7 ItemWriter</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">vitriol</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://vitriol95.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
