<!DOCTYPE html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="자바(JVM)의 구동 원리 및 구조 - 3" /><meta property="og:locale" content="ko" /><meta name="description" content="이전 포스트 - 자바(JVM)의 구동 원리 및 구조 - 1 이전 포스트 - 자바(JVM)의 구동 원리 및 구조 - 2" /><meta property="og:description" content="이전 포스트 - 자바(JVM)의 구동 원리 및 구조 - 1 이전 포스트 - 자바(JVM)의 구동 원리 및 구조 - 2" /><link rel="canonical" href="https://vitriol95.github.io/posts/java_intro_3/" /><meta property="og:url" content="https://vitriol95.github.io/posts/java_intro_3/" /><meta property="og:site_name" content="Vitriol" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-05-10T17:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="자바(JVM)의 구동 원리 및 구조 - 3" /><meta name="twitter:site" content="@" /><meta name="google-site-verification" content="QsbP4NOwVkaE8CnHpYOl-qNGhxB9m1RbsrBEefA92ao" /> <script type="application/ld+json"> {"headline":"자바(JVM)의 구동 원리 및 구조 - 3","dateModified":"2021-05-10T17:00:00+09:00","datePublished":"2021-05-10T17:00:00+09:00","description":"이전 포스트 - 자바(JVM)의 구동 원리 및 구조 - 1 이전 포스트 - 자바(JVM)의 구동 원리 및 구조 - 2","url":"https://vitriol95.github.io/posts/java_intro_3/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://vitriol95.github.io/posts/java_intro_3/"},"@context":"https://schema.org"}</script><title>자바(JVM)의 구동 원리 및 구조 - 3 | Vitriol</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Vitriol"><meta name="application-name" content="Vitriol"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-WSY4XYN711"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-WSY4XYN711'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Vitriol</a></div><div class="site-subtitle font-italic">기억을 적는 시간</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/vitriol95" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['vitriol951','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>자바(JVM)의 구동 원리 및 구조 - 3</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>자바(JVM)의 구동 원리 및 구조 - 3</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> vitriol </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, May 10, 2021, 5:00 PM +0900" prep="on" > May 10, 2021 <i class="unloaded">2021-05-10T17:00:00+09:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2582 words">14 min</span></div></div><div class="post-content"><p>이전 포스트 - <a href="https://vitriol95.github.io/posts/java_intro_1/">자바(JVM)의 구동 원리 및 구조 - 1</a><br /> 이전 포스트 - <a href="https://vitriol95.github.io/posts/java_intro_2/">자바(JVM)의 구동 원리 및 구조 - 2</a></p><p><br /> JVM의 구조와 그 중 Garbage Collector의 역할에 대해서 알아보았다. 이번 포스트부터는 심화적인 내용에 들어갈 예정인데, 가장 첫번째로 ‘참조(Reference)’에 대해서 알아보려 한다.</p><h1 id="레퍼런스">레퍼런스</h1><hr /><p>1편에 있었던 예시를 가져와서 레퍼런스가 무엇이었는가에 대한 기억을 살려보아야한다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span><span class="o">{</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">ll</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span> <span class="c1">// 1</span>
        <span class="n">ll</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"k"</span><span class="o">);</span>
        <span class="n">ll</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"o"</span><span class="o">);</span> <span class="c1">// 2</span>
        <span class="n">check</span><span class="o">(</span><span class="n">ll</span><span class="o">);</span> <span class="c1">// 5</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">check</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">array</span><span class="o">){</span> <span class="c1">//3</span>
        <span class="nc">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">array</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span> <span class="c1">// 4</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/java_study/5.JPG" /></p><p>주석 1번에 해당한 항목을 보면 <code class="language-plaintext highlighter-rouge">List&lt;String&gt; ll = new ArrayList&lt;&gt;();</code>로 새롭게 배열을 정의한 부분이 있고, 이를 통해 스택에 ll이 Heap영역의 리스트를 참조하고 있었음을 배웠었다.</p><p><br /> 이러한 참조의 형태는 가장 일반적인 참조에 해당하면서, 가장 보편적인 형태에 참조이다. (이방법 말고 다른 방법으로 참조를 줘본 경험은 없을 것이다..) 이를 <code class="language-plaintext highlighter-rouge">Strong Refernce</code> 즉 강한 참조라고 이야기한다. 이러한 형태로 참조당하는 객체의 상태를 ‘Strongly Reachable’이라고 한다.</p><p><br /> <code class="language-plaintext highlighter-rouge">String something = "aaa"</code> 와 같이 명시적으로 스트링 레터럴을 이용한 방식 또한 강한 참조에 해당하고, 이렇게 참조 되어있는 힙 내부의 객체는 당연히 Garbage Collection의 대상이 되지 않는다. <br /> 즉 <code class="language-plaintext highlighter-rouge">Object a = new Object()</code> 의 꼴로 선언된 객체 형태는 모두 여기에 해당한다.</p><h2 id="reachability">Reachability</h2><hr /><p>무엇이 Garbage 인지 판단을 할 때에는 힙에 있는 객체들의 Reachability를 따져보게 된다. 스택으로 부터 유효한 레퍼런스가 존재하지 않는다면 unreachable한 상태이며 유효한 상태는 reachable이라고 표현한다. 다음의 그림을 보자.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/java_study/12.JPG" /></p><blockquote><p>엄밀하게 따지면 왼쪽은 Stack이 아니라, ‘Root Set of Reference’라는 용어를 써야하지만, 이를 배제하고 일단은 Stack으로 이야기하며 진행하겠다.</p></blockquote><p>파란색으로 표시된 객체들이 Reachable한 객체에 해당하며 빨간색으로 표시된 객체들이 unreachable 한 객체들에 해당한다. A와 같이 reachable한 객체를 참조하더라도, Stack으로부터 직접적인 참조가 없다면 이는 unreachable 상태라고 보게 된다.</p><p><br /> 그렇다면 우리가 이야기 했던 Reference는 여기서 무엇으로 표시가 된 것일까? 바로 화살표에 해당한다. Strong Reference이외에도, Weak Reference, Soft Reference, Phantom Reference 등이 존재하고 이들은 화살표의 형태를 다르게 할 것이다.</p><p><br /></p><h3 id="효용성">효용성?</h3><p>이렇게 다른 Reference를 적용함으로부터 우리가 얻을 수 있는 이점은 무엇이 있을까? 바로 Garbage Collection 영역에 사용자 코드가 개입할 수 있다는 것이다. 단적으로 예를 들어보면 스택으로 부터 직접적으로 참조가 된다고 하더라도 Garbage Collection의 대상으로 만들어 버릴 수 있는 것이다.</p><hr /><h1 id="다양한-reference의-형태">다양한 Reference의 형태</h1><p>Strong Reference 이외에 다양한 Ref가 존재하는데, 이들의 역할은 앞서 이야기한 객체의 Reachability를 다르게 한다. 따라서 Reference의 종류와 이렇게 참조된 객체의 Reachability를 함께 이해하는 것이 중요하다</p><p><br /></p><h2 id="weak-reference">Weak Reference</h2><p>힙에서의 Weak Reference는 GC이후 살아남을 필요가 없을 것 같은 객체들에게 할당해 줄 수 있는데, 어찌보면 명시적으로 <code class="language-plaintext highlighter-rouge">이 객체를 GC 해주세요!</code> 라고 부탁하는 것이 될 수 있겠다. 다음과 같은 형태를 명시하여 WeakReference를 선언할 수 있다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">SampleObj</span><span class="o">&gt;</span> <span class="n">weakRef</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WeakReference</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="nc">SamepleObj</span><span class="o">());</span>
</pre></table></code></div></div><p>생성된 WeakReference클래스의 객체는 new 로 생성된 SampleObj()에 해당한다. 이 객체는 get 명령어로 가져올 수 있다. 아래 코드가 진행될 때 스택, 힙은 어떻게 구성이 되는지 알아보자.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">Sample</span><span class="o">&gt;</span> <span class="n">wr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WeakReference</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="nc">Sample</span><span class="o">());</span>
<span class="nc">Sample</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">wr</span><span class="o">.</span><span class="na">get</span><span class="o">();</span> <span class="c1">// 1</span>
<span class="cm">/**
~
*/</span>
<span class="n">ex</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">//2</span>
</pre></table></code></div></div><p>주석으로 표시한 1번과 2번 상황을 각각 그림으로 표현하면 다음과 같다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/java_study/13.JPG" /></p><p>2번에 의해 <code class="language-plaintext highlighter-rouge">ex = null</code>인 상태가 되버리면 Sample Obj를 참조하는 대상은 WeakRef Obj 밖에 존재하지 않는다. 이 상태의 객체를 Weakly Reachable 상태라고 하며, 이 객체는 Garbage Collection의 대상이된다. 일단은 이 개념을 가지고 좀 더 복잡한 예제로 들어가보자.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/java_study/14.JPG" /></p><p>여기서 Weakly Reachable한 객체는 B와 C에 해당하고, 파란색의 객체는 Strongly Reachable한 객체에 해당한다. 파란색의 객체는 GC의 대상이 아니다. GC가 동작하게 되면 빨간색의 unreachable 객체들과 weakly reachable 객체들이 함께 가비지 객체로 간주되어 메모리를 회수당하게 된다. <br /></p><blockquote><p>주의해야 할 점이 있는데 Weak Reference 객체 자체는 weakly Reachable이 아니라 Strongly Reachable한 객체에 해당한다는 점이다. (두개의 WeakRef Obj 자체는 스택으로부터 직접적인 참조를 받는다)</p></blockquote><p><br /> 또한 A의 경우에는 WeakRef의 참조를 받아 weakly reachable이지만, 스택으로 부터 직접적인 참조를 받고있기에 strongly reachable에 해당하여 GC의 대상이 아니다.</p><p><br /> B와 같이 Strongly Reachable에 참조 사슬에 포함이 되어 있지만(From WeakRef Obj), GC 동작시에 회수되므로 항상 유효할 필요가 없는 LRU 캐시와 같이 임시 객체를 저장하는 Caching scenario에 자주 사용이 되는 참조이다.</p><p><br /></p><h2 id="soft-reference">Soft Reference</h2><hr /><p>앞선 사례로 부터 알 수 있엇듯 GC는 스택으로 부터 시작하여 객체에 대한 모든 경로를 탐색하고, 그 경로에 있는 Reference Object들을 조사해 그 객체들의 reachability를 결정하는 과정이 존재한다.</p><p><br /> 이어서 볼 Soft Reference란 memory-sensitive한 상황에서 사용되는 참조 형태에 해당한다. 이들은 Application이 Low on Memory 한 상태에 있으면 최 우선적으로 GC의 대상이 된다. 반대로 말하면 메모리 확보가 불필요할 때 딱히 이들을 건드리지 않는 것이다. 이들은 다음과 같이 선언할 수 있다.</p><blockquote><p>Conditional한 Weak Ref 정도로 봐도 무방하다.</p></blockquote><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">SoftReference</span><span class="o">&lt;</span><span class="nc">Sample</span><span class="o">&gt;</span> <span class="n">sr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SoftReference</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="nc">Sample</span><span class="o">());</span>
</pre></table></code></div></div><p>만약 어떠한 애플리케이션이 구동중에 OutOfMemoryError를 throw했다면, Softly Reachable한 객체들은 이미 GC에 의해 정리된 상태임을 예상해 볼 수 있다.</p><p><br /></p><h2 id="phantom-reference">Phantom Reference</h2><hr /><p>Strong, Softly, Weakly 중 어떠한 상태에도 포함되지 않은 객체의 상태에 해당한다. 이 객체는 <strong>Finalize 되었지만</strong> 아직 메모리가 회수되지 않는 상태에 해당한다.</p><blockquote><p>GC는 대게 Mark - Sweep 두가지 과정으로 이루어져 있다. 하지만 이들은 항상 함께 동작하는 것이 아니다(순차적으로 mark를 했다면 바로 sweep을 진행하는 것이 아니다). 따라서 이러한 phantom 객체들이 존재할 수 있는 것이다.</p></blockquote><p><br /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/java_study/15.JPG" /></p><p>위의 그림에서 객체 A의 Reachability는 현재 Softly Reachable에 해당하며 이는 어플리케이션이 low on memory 상태일 때 GC의 대상이 된다. 하지만 화살표 B가 끊어지게 되면 A는 Phantomly Reachable 상태가 되며 이는 Finalize 된 후에 GC 대상이 된다.</p><p><br /> 특이한 점은 GC 대상 여부를 결정하는 부분에 관여하는 softly, weakly reachable과는 달리 phantomly reachable은 파이널라이즈와 메모리 회수 사이에만 관여한다. 어떤 객체의 참조가 phantom ref만 남게되면 해당 객체는 바로 파이널라이즈가 된다.</p><h2 id="reference-queue-javalangref">Reference Queue (java.lang.ref)</h2><hr /><p>Reference Queue란 Garbage Collector가 reference object를 집어넣는 간단한 data structure에 해당한다.</p><p><br /> Soft ref, Weak ref객체가 참조하는 객체가 GC의 대상이 된다면 soft Ref, weak Ref 객체의 참조는 null로 바뀌게 되고 참조하던 객체는 Reference Queue에 들어오게 된다. 이 과정은 GC가 수행한다.</p><p><br /> Reference Queue에 이 reference obj들이 들어있는지 확인하면 softly Reachable 객체나, weakly Reachable 객체가 GC되었는지에 대한 여부를 파악할 수 있고 이에 따라 관련 리소스 혹은 객체에 대한 후처리를 가능하게 해준다. 마치 스프링 빈의 Annotation인 @PreDestroy와 어느정도 유사하다고 보면 된다</p><p><br /> Reference Queue에 enque되기 위해서는 Soft나 Weak Ref object들은 처음부터 Reference Queue내부에서 만들어져야 한다(선택적이다). 하지만 Phantom Ref 객체들은 반드시 Reference Queue에서 만들어져야 한다(의무적이다).</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nc">ReferenceQueue</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReferenceQueue</span><span class="o">();</span>
<span class="nc">PhantomReference</span> <span class="n">pr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PhantomReference</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">queue</span><span class="o">);</span>
</pre></table></code></div></div><p><br /></p><h1 id="정리">정리</h1><hr /><p>GC가 객체를 처리하는 과정을 다시한번 세부적으로 정리하면 다음과 같다.</p><ol><li>SoftReference<li>WeakReference<li>파이널라이즈<li>PhantomReference<li>메모리 회수</ol><p>즉, 어떤 객체의 GC여부 판별은 reachability를 strongly, softly, weakly 순서로 판별하고 모두 아니면 그 객체에 대한 파이널라이즈를 진행한다.<br /> 이후 대상 객체를 참조하는 Phantoly Ref가 있다면 phantomly reachable로 판별한다. <br />마지막으로 Reference Queue에 넣어진 객체라면(Phontomly reachable은 무조건) 파이널라이즈 이후 작업을 애플리케이션이 수행하게 하고, 메모리의 회수는 지연 시킨다.</p><h1 id="출처">출처</h1><hr /><p>참고자료 : <a href="http://www.pawlan.com/monica/articles/refobjs/">http://www.pawlan.com/monica/articles/refobjs/</a> <br /> 참고자료 : <a href="https://d2.naver.com/helloworld/329631">https://d2.naver.com/helloworld/329631</a> <br /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/java/'>Java</a>, <a href='/categories/java-study/'>java_study</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration" >java</a> <a href="/tags/jvm/" class="post-tag no-text-decoration" >jvm</a> <a href="/tags/%EC%9E%90%EB%B0%94/" class="post-tag no-text-decoration" >자바</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=자바(JVM)의 구동 원리 및 구조 - 3 - Vitriol&url=https://vitriol95.github.io/posts/java_intro_3/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=자바(JVM)의 구동 원리 및 구조 - 3 - Vitriol&u=https://vitriol95.github.io/posts/java_intro_3/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=자바(JVM)의 구동 원리 및 구조 - 3 - Vitriol&url=https://vitriol95.github.io/posts/java_intro_3/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/batchbase1/">스프링 배치 - 1 스프링 배치란?</a><li><a href="/posts/batchbase2/">스프링 배치 - 2 DB 스키마에 대한 이해</a><li><a href="/posts/batchbase3/">스프링 배치 - 3 도메인 뜯어보기(JOB)</a><li><a href="/posts/batchbase4/">스프링 배치 - 4 도메인 뜯어보기(STEP)</a><li><a href="/posts/batchbase5/">스프링 배치 - 5 청크 지향 처리</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/java_intro_1/"><div class="card-body"> <span class="timeago small" > May 10, 2021 <i class="unloaded">2021-05-10T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>자바(JVM)의 구동 원리 및 구조 - 1</h3><div class="text-muted small"><p> JAVA의 전체적인 틀 동작원리를 알기 전에, 먼저 자바의 파일들이 어떻게 구성되어있는지 알 필요가 있다. Intellij나 Eclipse 등을 이용해 Java언어 코딩을 진행할때 많이 보았을 파일의 형식은 아마 .java였을 것이다. 그리고 컴파일을 하게 되면 out 폴더나(Intellij), bulid 폴더(eclipse)내에 동일한 이름의 ....</p></div></div></a></div><div class="card"> <a href="/posts/java_intro_2/"><div class="card-body"> <span class="timeago small" > May 10, 2021 <i class="unloaded">2021-05-10T15:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>자바(JVM)의 구동 원리 및 구조 - 2</h3><div class="text-muted small"><p> 이전 포스트 - 자바(JVM)의 구동 원리 및 구조 - 1 저번 시간에는 자바의 전체적인 틀과함께 JVM의 구조를 알아보았다. 그 중에서 JVM의 메모리에 해당하는 Runtime Data Area 영역에 대해서 자세히 알아보았고 그중에서도 Stack과 Heap영역에 데이터가 쌓이는 방식에 대해 알아보았다. 이번시간에는 JVM의 Garbage Col...</p></div></div></a></div><div class="card"> <a href="/posts/java_intro_4/"><div class="card-body"> <span class="timeago small" > May 11, 2021 <i class="unloaded">2021-05-11T17:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>자바(JVM)의 구동 원리 및 구조 - 4</h3><div class="text-muted small"><p> 이전 포스트 - 자바(JVM)의 구동 원리 및 구조 - 1 이전 포스트 - 자바(JVM)의 구동 원리 및 구조 - 2 이전 포스트 - 자바(JVM)의 구동 원리 및 구조 - 3 저번 시간에는 GC에 있어 여러가지 참조 형태와 사용자 코드의 개입에 대해서 이야기 해보았는데, 마지막으로 GC의 여러 알고리즘을 이야기하고자 한다. GC과정에서 가장 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/java_intro_2/" class="btn btn-outline-primary" prompt="Older"><p>자바(JVM)의 구동 원리 및 구조 - 2</p></a> <a href="/posts/boj5639/" class="btn btn-outline-primary" prompt="Newer"><p>백준 5639 이진 검색 트리 with Python</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">vitriol</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://vitriol95.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
