<!DOCTYPE html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="스프링 mvc 프로젝트 + AWS EC2에 빌드까지(7)" /><meta property="og:locale" content="ko" /><meta name="description" content="이전 글" /><meta property="og:description" content="이전 글" /><link rel="canonical" href="https://vitriol95.github.io/posts/mvcproject7/" /><meta property="og:url" content="https://vitriol95.github.io/posts/mvcproject7/" /><meta property="og:site_name" content="Vitriol" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-07T11:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="스프링 mvc 프로젝트 + AWS EC2에 빌드까지(7)" /><meta name="twitter:site" content="@" /><meta name="google-site-verification" content="QsbP4NOwVkaE8CnHpYOl-qNGhxB9m1RbsrBEefA92ao" /> <script type="application/ld+json"> {"headline":"스프링 mvc 프로젝트 + AWS EC2에 빌드까지(7)","dateModified":"2021-07-01T19:17:09+09:00","datePublished":"2021-06-07T11:00:00+09:00","description":"이전 글","url":"https://vitriol95.github.io/posts/mvcproject7/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://vitriol95.github.io/posts/mvcproject7/"},"@context":"https://schema.org"}</script><title>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(7) | Vitriol</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Vitriol"><meta name="application-name" content="Vitriol"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-WSY4XYN711"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-WSY4XYN711'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Vitriol</a></div><div class="site-subtitle font-italic">기억을 적는 시간</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/vitriol95" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['vitriol951','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(7)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(7)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> vitriol </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Jun 7, 2021, 11:00 AM +0900" prep="on" > Jun 7, 2021 <i class="unloaded">2021-06-07T11:00:00+09:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Jul 1, 2021, 7:17 PM +0900" prefix="Updated " > Jul 1, 2021 <i class="unloaded">2021-07-01T19:17:09+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="7713 words">42 min</span></div></div><div class="post-content"><h1 id="이전-글">이전 글</h1><p><a href="https://vitriol95.github.io/posts/mvcproject6/">이전글</a> 에서는 게시글에 대한 검색기능과, 유저 목록을 보여주는 기능을 구현해 보았다. 이번 시간에는 배포이전 마지막단계로 단위테스트와 함께 쿼리 효율을 분석해보고, 필요할 경우 리팩토링을 진행할 예정이다.</p><hr /><h1 id="단위-테스트-구현">단위 테스트 구현</h1><p>가장 먼저, 테스트 메서드의 편의성을 위해 Account, Post, Reply를 만들어내는 AccountFactory, PostFactory, ReplyFactory 클래스를 테스트 폴더안에 만들어 두었다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre><td class="rouge-code"><pre><span class="c1">// AccountFactory.java</span>
<span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountFactory</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">AccountRepository</span> <span class="n">accountRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Account</span> <span class="nf">newAccount</span><span class="o">(</span><span class="nc">String</span> <span class="n">nickname</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Account</span><span class="o">();</span>
        <span class="n">account</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="n">nickname</span> <span class="o">+</span> <span class="s">"@naver.com"</span><span class="o">);</span>
        <span class="n">account</span><span class="o">.</span><span class="na">setNickname</span><span class="o">(</span><span class="n">nickname</span><span class="o">);</span>
        <span class="n">account</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">"123123123"</span><span class="o">);</span>
        <span class="n">accountRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">account</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// PostFactory.java</span>
<span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PostFactory</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">PostService</span> <span class="n">postService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Post</span> <span class="nf">newPost</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">Account</span> <span class="n">writer</span><span class="o">)</span> <span class="o">{</span>


        <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Post</span><span class="o">();</span>
        <span class="n">post</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">title</span><span class="o">);</span>
        <span class="n">post</span><span class="o">.</span><span class="na">setIntroduction</span><span class="o">(</span><span class="s">"test"</span><span class="o">);</span>
        <span class="n">post</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="s">"description"</span><span class="o">);</span>
        <span class="n">post</span><span class="o">.</span><span class="na">setOpen</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">postService</span><span class="o">.</span><span class="na">createNewPost</span><span class="o">(</span><span class="n">post</span><span class="o">,</span> <span class="n">writer</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">post</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// ReplyFactory.java</span>
<span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReplyFactory</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">PostService</span> <span class="n">postService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Reply</span> <span class="nf">newReply</span><span class="o">(</span><span class="nc">Post</span> <span class="n">post</span><span class="o">,</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Reply</span> <span class="n">reply</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Reply</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">randomString</span> <span class="o">=</span> <span class="nc">RandomString</span><span class="o">.</span><span class="na">make</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
        <span class="n">reply</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="n">randomString</span><span class="o">);</span>
        <span class="n">postService</span><span class="o">.</span><span class="na">createNewReply</span><span class="o">(</span><span class="n">reply</span><span class="o">,</span> <span class="n">post</span><span class="o">,</span> <span class="n">account</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">reply</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>이전 테스트들은 회원 가입 및 로그인, 게시글 작성 및 수정 / 삭제에 대한 테스트를 모두 마친 상태이므로, 댓글과 관련된 컨트롤러 테스트를 진행해야한다. 이는 PostController내에 구현되어 있으므로 새로운 테스트 클래스인 PostWithReplyControllerTest 파일을 생성해 테스트를 진행하겠다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
</pre><td class="rouge-code"><pre><span class="c1">// PostWithReplyControllerTest.java</span>
<span class="nd">@Transactional</span>
<span class="nd">@SpringBootTest</span>
<span class="nd">@AutoConfigureMockMvc</span>
<span class="kd">class</span> <span class="nc">PostWithReplyControllerTest</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">MockMvc</span> <span class="n">mockMvc</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">AccountService</span> <span class="n">accountService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">AccountRepository</span> <span class="n">accountRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">PostService</span> <span class="n">postService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">PostRepository</span> <span class="n">postRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">AccountFactory</span> <span class="n">accountFactory</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">PostFactory</span> <span class="n">postFactory</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">ReplyFactory</span> <span class="n">replyFactory</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">ReplyRepository</span> <span class="n">replyRepository</span><span class="o">;</span>

    <span class="nd">@BeforeEach</span>
    <span class="kt">void</span> <span class="nf">beforeEach</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">SignUpForm</span> <span class="n">signUpForm</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SignUpForm</span><span class="o">();</span>
        <span class="n">signUpForm</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="s">"vitriol95@naver.com"</span><span class="o">);</span>
        <span class="n">signUpForm</span><span class="o">.</span><span class="na">setNickname</span><span class="o">(</span><span class="s">"vitriol95"</span><span class="o">);</span>
        <span class="n">signUpForm</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">"12345678"</span><span class="o">);</span>
        <span class="n">accountService</span><span class="o">.</span><span class="na">createNewAccount</span><span class="o">(</span><span class="n">signUpForm</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@AfterEach</span>
    <span class="kt">void</span> <span class="nf">afterEach</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">postRepository</span><span class="o">.</span><span class="na">deleteAll</span><span class="o">();</span>
        <span class="n">accountRepository</span><span class="o">.</span><span class="na">deleteAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"댓글 입력 폼"</span><span class="o">)</span>
    <span class="nd">@Test</span>
    <span class="nd">@WithUserDetails</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"vitriol95@naver.com"</span><span class="o">,</span> <span class="n">setupBefore</span> <span class="o">=</span> <span class="nc">TestExecutionEvent</span><span class="o">.</span><span class="na">TEST_EXECUTION</span><span class="o">)</span>
    <span class="kt">void</span> <span class="n">댓글_입력_폼</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="nc">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountFactory</span><span class="o">.</span><span class="na">newAccount</span><span class="o">(</span><span class="s">"test1"</span><span class="o">);</span>
        <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postFactory</span><span class="o">.</span><span class="na">newPost</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="n">account</span><span class="o">);</span>
        <span class="nc">Long</span> <span class="n">postId</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>

        <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/posts/"</span> <span class="o">+</span> <span class="n">postId</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">view</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"post/view"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"newReplyForm"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"댓글 작성"</span><span class="o">)</span>
    <span class="nd">@Test</span>
    <span class="nd">@WithUserDetails</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"vitriol95@naver.com"</span><span class="o">,</span> <span class="n">setupBefore</span> <span class="o">=</span> <span class="nc">TestExecutionEvent</span><span class="o">.</span><span class="na">TEST_EXECUTION</span><span class="o">)</span>
    <span class="kt">void</span> <span class="n">댓글_작성</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="nc">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountFactory</span><span class="o">.</span><span class="na">newAccount</span><span class="o">(</span><span class="s">"test1"</span><span class="o">);</span>
        <span class="nc">Post</span> <span class="n">post2</span> <span class="o">=</span> <span class="n">postFactory</span><span class="o">.</span><span class="na">newPost</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="n">account</span><span class="o">);</span>
        <span class="nc">Long</span> <span class="n">postId</span> <span class="o">=</span> <span class="n">post2</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>

        <span class="nc">NewReplyForm</span> <span class="n">replyForm</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NewReplyForm</span><span class="o">();</span>
        <span class="n">replyForm</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="s">"aaa"</span><span class="o">);</span>

        <span class="c1">// Ajax</span>
        <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">post</span><span class="o">(</span><span class="s">"/posts/"</span> <span class="o">+</span> <span class="n">postId</span> <span class="o">+</span> <span class="s">"/reply"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
                <span class="o">.</span><span class="na">content</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">replyForm</span><span class="o">))</span>
                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="n">csrf</span><span class="o">()))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">());</span>

        <span class="nc">Reply</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">replyRepository</span><span class="o">.</span><span class="na">findByPost</span><span class="o">(</span><span class="n">post2</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">reply</span><span class="o">).</span><span class="na">isNotNull</span><span class="o">();</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">reply</span><span class="o">.</span><span class="na">getAccount</span><span class="o">().</span><span class="na">getEmail</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"vitriol95@naver.com"</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">reply</span><span class="o">.</span><span class="na">getDescription</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"aaa"</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">reply</span><span class="o">.</span><span class="na">getPost</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">post2</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">post2</span><span class="o">.</span><span class="na">getReplies</span><span class="o">()).</span><span class="na">contains</span><span class="o">(</span><span class="n">reply</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">post2</span><span class="o">.</span><span class="na">getReplyCount</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>

        <span class="nc">Account</span> <span class="n">vitriol</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="s">"vitriol95@naver.com"</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">vitriol</span><span class="o">.</span><span class="na">getReplyCount</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"입력된 댓글 뷰"</span><span class="o">)</span>
    <span class="nd">@Test</span>
    <span class="nd">@WithUserDetails</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"vitriol95@naver.com"</span><span class="o">,</span> <span class="n">setupBefore</span> <span class="o">=</span> <span class="nc">TestExecutionEvent</span><span class="o">.</span><span class="na">TEST_EXECUTION</span><span class="o">)</span>
    <span class="kt">void</span> <span class="n">입력된_댓글_뷰</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="nc">Account</span> <span class="n">test1</span> <span class="o">=</span> <span class="n">accountFactory</span><span class="o">.</span><span class="na">newAccount</span><span class="o">(</span><span class="s">"test1"</span><span class="o">);</span>
        <span class="nc">Account</span> <span class="n">test2</span> <span class="o">=</span> <span class="n">accountFactory</span><span class="o">.</span><span class="na">newAccount</span><span class="o">(</span><span class="s">"test2"</span><span class="o">);</span>
        <span class="nc">Post</span> <span class="n">post1</span> <span class="o">=</span> <span class="n">postFactory</span><span class="o">.</span><span class="na">newPost</span><span class="o">(</span><span class="s">"test1's post"</span><span class="o">,</span> <span class="n">test1</span><span class="o">);</span>
        <span class="nc">Reply</span> <span class="n">reply1</span> <span class="o">=</span> <span class="n">replyFactory</span><span class="o">.</span><span class="na">newReply</span><span class="o">(</span><span class="n">post1</span><span class="o">,</span> <span class="n">test1</span><span class="o">);</span>
        <span class="nc">Reply</span> <span class="n">reply2</span> <span class="o">=</span> <span class="n">replyFactory</span><span class="o">.</span><span class="na">newReply</span><span class="o">(</span><span class="n">post1</span><span class="o">,</span> <span class="n">test2</span><span class="o">);</span>

        <span class="nc">MvcResult</span> <span class="n">mvcResult</span> <span class="o">=</span> <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/posts/"</span> <span class="o">+</span> <span class="n">post1</span><span class="o">.</span><span class="na">getId</span><span class="o">()))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">view</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"post/view"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"newReplyForm"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">()).</span><span class="na">andReturn</span><span class="o">();</span>

        <span class="nc">String</span> <span class="n">content</span> <span class="o">=</span> <span class="n">mvcResult</span><span class="o">.</span><span class="na">getResponse</span><span class="o">().</span><span class="na">getContentAsString</span><span class="o">();</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">content</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="n">reply1</span><span class="o">.</span><span class="na">getDescription</span><span class="o">());</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">content</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="n">reply1</span><span class="o">.</span><span class="na">getAccount</span><span class="o">().</span><span class="na">getNickname</span><span class="o">());</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">content</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="n">reply1</span><span class="o">.</span><span class="na">getCreatedDate</span><span class="o">().</span><span class="na">format</span><span class="o">(</span><span class="nc">DateTimeFormatter</span><span class="o">.</span><span class="na">ofPattern</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm"</span><span class="o">)));</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">content</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="n">reply2</span><span class="o">.</span><span class="na">getDescription</span><span class="o">());</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">content</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="n">reply2</span><span class="o">.</span><span class="na">getAccount</span><span class="o">().</span><span class="na">getNickname</span><span class="o">());</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">content</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="n">reply2</span><span class="o">.</span><span class="na">getCreatedDate</span><span class="o">().</span><span class="na">format</span><span class="o">(</span><span class="nc">DateTimeFormatter</span><span class="o">.</span><span class="na">ofPattern</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm"</span><span class="o">)));</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">content</span><span class="o">).</span><span class="na">doesNotContain</span><span class="o">(</span><span class="s">"삭제"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"댓글 삭제"</span><span class="o">)</span>
    <span class="nd">@Test</span>
    <span class="nd">@WithUserDetails</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"vitriol95@naver.com"</span><span class="o">,</span> <span class="n">setupBefore</span> <span class="o">=</span> <span class="nc">TestExecutionEvent</span><span class="o">.</span><span class="na">TEST_EXECUTION</span><span class="o">)</span>
    <span class="kt">void</span> <span class="n">댓글_삭제</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Account</span> <span class="n">test1</span> <span class="o">=</span> <span class="n">accountFactory</span><span class="o">.</span><span class="na">newAccount</span><span class="o">(</span><span class="s">"test1"</span><span class="o">);</span>
        <span class="nc">Post</span> <span class="n">post1</span> <span class="o">=</span> <span class="n">postFactory</span><span class="o">.</span><span class="na">newPost</span><span class="o">(</span><span class="s">"title112"</span><span class="o">,</span> <span class="n">test1</span><span class="o">);</span>

        <span class="nc">Account</span> <span class="n">vitriol</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="s">"vitriol95@naver.com"</span><span class="o">);</span>
        <span class="nc">Reply</span> <span class="n">reply1</span> <span class="o">=</span> <span class="n">replyFactory</span><span class="o">.</span><span class="na">newReply</span><span class="o">(</span><span class="n">post1</span><span class="o">,</span> <span class="n">vitriol</span><span class="o">);</span>

        <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">post</span><span class="o">(</span><span class="s">"/posts/"</span> <span class="o">+</span> <span class="n">post1</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/reply/"</span> <span class="o">+</span> <span class="n">reply1</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/delete"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="n">csrf</span><span class="o">()))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">is3xxRedirection</span><span class="o">())</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">redirectedUrl</span><span class="o">(</span><span class="s">"/posts/"</span> <span class="o">+</span> <span class="n">post1</span><span class="o">.</span><span class="na">getId</span><span class="o">()));</span>

        <span class="nc">Reply</span> <span class="n">replyById</span> <span class="o">=</span> <span class="n">replyRepository</span><span class="o">.</span><span class="na">findReplyById</span><span class="o">(</span><span class="n">reply1</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">replyById</span><span class="o">).</span><span class="na">isNull</span><span class="o">();</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">post1</span><span class="o">.</span><span class="na">getReplies</span><span class="o">()).</span><span class="na">doesNotContain</span><span class="o">(</span><span class="n">reply1</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">post1</span><span class="o">.</span><span class="na">getReplyCount</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">0L</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">vitriol</span><span class="o">.</span><span class="na">getReplies</span><span class="o">()).</span><span class="na">doesNotContain</span><span class="o">(</span><span class="n">reply1</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">vitriol</span><span class="o">.</span><span class="na">getReplyCount</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">0L</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>70번째 댓글작성 메서드는 Ajax요청으로 데이터를 JSON형태로 Request Body에 넣어 전달하기에 코드가 살짝 다르다.</p><p><br /> 이어서 회원 목록에 대한 테스트 코드와, 게시글 검색에 대한 테스트 코드를 작성해 보았다. 전자의 경우는 AccountControllerTest 안에, 후자의 경우는 MainControllerTest안에 구현되었다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
</pre><td class="rouge-code"><pre><span class="c1">// AccountControllerTest.java</span>
<span class="nd">@Transactional</span>
<span class="nd">@SpringBootTest</span>
<span class="nd">@AutoConfigureMockMvc</span>
<span class="kd">class</span> <span class="nc">AccountControllerTest</span> <span class="o">{</span>

    <span class="cm">/**
    이전 코드들
    */</span>
    <span class="nd">@WithUserDetails</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"vitriol95@naver.com"</span><span class="o">,</span> <span class="n">setupBefore</span> <span class="o">=</span> <span class="nc">TestExecutionEvent</span><span class="o">.</span><span class="na">TEST_EXECUTION</span><span class="o">)</span>
    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"회원 전체 검색"</span><span class="o">)</span>
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="n">회원_전체_검색</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">41</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">accountFactory</span><span class="o">.</span><span class="na">newAccount</span><span class="o">(</span><span class="s">"testAccount"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span> <span class="c1">// 총 41 + 2(BeforeEach) 유저가 존재. 3페이지 분량 (20, 20, 3)</span>

        <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/accounts"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">view</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"account/all"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"accountPage"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"accountPage"</span><span class="o">,</span> <span class="nc">IsIterableWithSize</span><span class="o">.</span><span class="na">iterableWithSize</span><span class="o">(</span><span class="mi">20</span><span class="o">)));</span>

        <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/accounts?page=1"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">view</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"account/all"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"accountPage"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"accountPage"</span><span class="o">,</span> <span class="nc">IsIterableWithSize</span><span class="o">.</span><span class="na">iterableWithSize</span><span class="o">(</span><span class="mi">20</span><span class="o">)));</span>

        <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/accounts?page=2"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">view</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"account/all"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"accountPage"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"accountPage"</span><span class="o">,</span> <span class="nc">IsIterableWithSize</span><span class="o">.</span><span class="na">iterableWithSize</span><span class="o">(</span><span class="mi">3</span><span class="o">)));</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">accountRepository</span><span class="o">.</span><span class="na">count</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">43L</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// MainControllerTest.java</span>

<span class="nd">@Transactional</span>
<span class="nd">@SpringBootTest</span>
<span class="nd">@AutoConfigureMockMvc</span>
<span class="kd">class</span> <span class="nc">MainControllerTest</span> <span class="o">{</span>

    <span class="cm">/**
    이전 코드들
    */</span>

    <span class="nd">@WithUserDetails</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"vitriol95@naver.com"</span><span class="o">,</span> <span class="n">setupBefore</span> <span class="o">=</span> <span class="nc">TestExecutionEvent</span><span class="o">.</span><span class="na">TEST_EXECUTION</span><span class="o">)</span>
    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"게시글 검색 - 전체 검색"</span><span class="o">)</span>
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="n">게시글_검색_전체_검색</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="nc">Account</span> <span class="n">vitriol</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="s">"vitriol95@naver.com"</span><span class="o">);</span>
        <span class="nc">Account</span> <span class="n">creator</span> <span class="o">=</span> <span class="n">accountFactory</span><span class="o">.</span><span class="na">newAccount</span><span class="o">(</span><span class="s">"creator"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">Post</span> <span class="n">withR</span> <span class="o">=</span> <span class="n">postFactory</span><span class="o">.</span><span class="na">newPost</span><span class="o">(</span><span class="s">"testTitle"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">creator</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">13</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">replyFactory</span><span class="o">.</span><span class="na">newReply</span><span class="o">(</span><span class="n">withR</span><span class="o">,</span> <span class="n">vitriol</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/search/post"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">param</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">,</span> <span class="s">""</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">view</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"search"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"postPage"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"sortProperty"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">,</span> <span class="s">""</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"postPage"</span><span class="o">,</span> <span class="nc">IsIterableWithSize</span><span class="o">.</span><span class="na">iterableWithSize</span><span class="o">(</span><span class="mi">12</span><span class="o">)));</span>

        <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/search/post"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">param</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">,</span> <span class="s">""</span><span class="o">)</span>
                <span class="o">.</span><span class="na">param</span><span class="o">(</span><span class="s">"page"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">view</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"search"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"postPage"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"sortProperty"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">,</span> <span class="s">""</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"postPage"</span><span class="o">,</span> <span class="nc">IsIterableWithSize</span><span class="o">.</span><span class="na">iterableWithSize</span><span class="o">(</span><span class="mi">2</span><span class="o">)));</span>

        <span class="c1">// 정렬 방식</span>
        <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/search/post"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">param</span><span class="o">(</span><span class="s">"sort"</span><span class="o">,</span> <span class="s">"createdDate,desc"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">param</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">,</span> <span class="s">""</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">view</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"search"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"postPage"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"sortProperty"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">,</span> <span class="s">""</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"postPage"</span><span class="o">,</span> <span class="nc">IsIterableWithSize</span><span class="o">.</span><span class="na">iterableWithSize</span><span class="o">(</span><span class="mi">12</span><span class="o">)))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"sortProperty"</span><span class="o">,</span> <span class="s">"createdDate"</span><span class="o">));</span>

        <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/search/post"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">param</span><span class="o">(</span><span class="s">"sort"</span><span class="o">,</span> <span class="s">"replyCount,desc"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">param</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">,</span> <span class="s">""</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">view</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"search"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"postPage"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"sortProperty"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">,</span> <span class="s">""</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"postPage"</span><span class="o">,</span> <span class="nc">IsIterableWithSize</span><span class="o">.</span><span class="na">iterableWithSize</span><span class="o">(</span><span class="mi">12</span><span class="o">)))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"sortProperty"</span><span class="o">,</span> <span class="s">"replyCount"</span><span class="o">));</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">postRepository</span><span class="o">.</span><span class="na">count</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">14L</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">replyRepository</span><span class="o">.</span><span class="na">count</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@WithUserDetails</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"vitriol95@naver.com"</span><span class="o">,</span> <span class="n">setupBefore</span> <span class="o">=</span> <span class="nc">TestExecutionEvent</span><span class="o">.</span><span class="na">TEST_EXECUTION</span><span class="o">)</span>
    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"게시글 검색 - 특정 검색어"</span><span class="o">)</span>
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="n">게시글_검색_특정_검색어</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="nc">Account</span> <span class="n">vitriol</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="s">"vitriol95@naver.com"</span><span class="o">);</span>
        <span class="nc">Account</span> <span class="n">creator</span> <span class="o">=</span> <span class="n">accountFactory</span><span class="o">.</span><span class="na">newAccount</span><span class="o">(</span><span class="s">"creator"</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">postFactory</span><span class="o">.</span><span class="na">newPost</span><span class="o">(</span><span class="s">"testTitle"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">creator</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">postFactory</span><span class="o">.</span><span class="na">newPost</span><span class="o">(</span><span class="s">"vitriol"</span><span class="o">,</span> <span class="n">vitriol</span><span class="o">);</span>
        <span class="o">}</span>


        <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/search/post"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">param</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">,</span> <span class="s">"vitriol"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">view</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"search"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"postPage"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attributeExists</span><span class="o">(</span><span class="s">"sortProperty"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">,</span> <span class="s">"vitriol"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">model</span><span class="o">().</span><span class="na">attribute</span><span class="o">(</span><span class="s">"postPage"</span><span class="o">,</span> <span class="nc">IsIterableWithSize</span><span class="o">.</span><span class="na">iterableWithSize</span><span class="o">(</span><span class="mi">10</span><span class="o">)));</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>게시글 검색의 경우에는 정렬 방식에 대한 테스트 또한 진행해 보았다.</p><hr /><h1 id="쿼리-분석하기">쿼리 분석하기</h1><p><br /></p><h2 id="회원가입-및-로그인">회원가입 및 로그인</h2><p>이 두가지 기능의 경우 매우 단순하므로, 따로 코드를 보며 예상해보지 않고 바로 서버를 구동하며 쿼리를 살펴보겠다. <br /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/26.JPG" /></p><p>가장 먼저 회원가입을 진행한 경우 쿼리는 다음과 같다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/27.JPG" /></p><p>총 3개의 쿼리가 나가고 있다. 이들을 순번대로 살펴보자.</p><ol><li>회원가입 시, 중복 이메일의 가입을 막고있기에 같은 이메일이 있는지를 검사하는 SELECT 문이 나간다.<li>또한 중복 닉네임의 가입을 막고있기에 같은 닉네임이 있는지 검사하는 SELECT 문이 나가게 된다.<blockquote><p>위 두가지 제약사항은 Validator를 상속한 SignUpFormValidator에서 구현하였다.</p></blockquote><li>마지막으로 두 조건을 모두 만족시킬 때, Account 객체의 Insert문이 나가게 된다.<blockquote><p>직관대로 쿼리가 나가고 있음을 확인해 보았다.</p></blockquote></ol><p><br /> 다음으로는 로그인의 쿼리를 분석해보자.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/28.JPG" /></p><p>SELECT 쿼리가 딱 1개만 나가고 있다. 살짝 의구심이 들 수 있지만 이는 SpringSecurity의 기능이 많이 포함되어있기 때문이다. 우리가 직접 구현한 기능은 <code class="language-plaintext highlighter-rouge">UserDetailService</code>의 <code class="language-plaintext highlighter-rouge">loadUserByUsername</code>메서드에 해당한다. 우리는 로그인시 Account의 email 프로퍼티를 username으로 사용하기에 이를 repository에서 불러와주는 과정만 구현하였다. 따라서 이 쿼리만 나갈 뿐, 나머지 인증과 관련된 절차는 스프링 시큐리티가 진행하게 된다.</p><hr /><h2 id="회원-정보-수정">회원 정보 수정</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/29.JPG" /></p><p>이어서 회원 정보를 수정해보자. 기존 공백이었던 소개글만 추가하고 수정하기 버튼을 눌러보겠다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/30.JPG" /></p><p>우리가 원하는 결과가 나왔다. 우리는 프로필 수정 폼에 대한 Validator인 ProfileFormValidator의 validate 메서드를 통해 중복되는 닉네임으로의 수정을 막고있다. 따라서 닉네임을 통해 유저를 검색한다.</p><p><br /> 여기서는 닉네임이 변경되지 않았으므로 SELECT 문을 통한 객체가 바로 수정해야할 객체에 해당한다. 따라서 이에 대해 곧바로 UPDATE 쿼리를 보내주고 있다.</p><p><br /> 그렇다면 닉네임을 변경한다면 어떻게 될까?</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        account0_.id as id1_0_,
        account0_.created_date as created_2_0_,
        account0_.modified_date as modified3_0_,
        account0_.bio as bio4_0_,
        account0_.email as email5_0_,
        account0_.nickname as nickname6_0_,
        account0_.password as password7_0_,
        account0_.post_count as post_cou8_0_,
        account0_.profile_image as profile_9_0_,
        account0_.reply_count as reply_c10_0_ 
    from
        account account0_ 
    where
        account0_.nickname=?
Hibernate: 
    select
        account0_.id as id1_0_0_,
        account0_.created_date as created_2_0_0_,
        account0_.modified_date as modified3_0_0_,
        account0_.bio as bio4_0_0_,
        account0_.email as email5_0_0_,
        account0_.nickname as nickname6_0_0_,
        account0_.password as password7_0_0_,
        account0_.post_count as post_cou8_0_0_,
        account0_.profile_image as profile_9_0_0_,
        account0_.reply_count as reply_c10_0_0_ 
    from
        account account0_ 
    where
        account0_.id=?
Hibernate: 
    update
        account 
    set
        created_date=?,
        modified_date=?,
        bio=?,
        email=?,
        nickname=?,
        password=?,
        post_count=?,
        profile_image=?,
        reply_count=? 
    where
        id=?

</pre></table></code></div></div><p>닉네임을 통해 Account를 검색하는 것은 확인했는데, 그 아래에 새롭게 id를 통해 account를 검색하고 있다. 이 이유는 다음과 같다.</p><ol><li>nickname을 통해 검색한 Account는 null에 해당한다. (그래서 닉네임을 변경할 수 있는 것이다.)<li>따라서 아직 수정할 객체가 SELECT 되지 않았으므로 이 객체를 가져와야한다.<li>이후 업데이트를 진행한다.</ol><hr /><h2 id="글-작성">글 작성</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/31.JPG" /></p><p>가장 먼저 다음과 같이 글을 작성해 보았다. 쿼리를 직접 보기전에 어떠한 쿼리가 나가게 될지 확인해보자. 글 작성에 대한 로직은 다음과 같다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="c1">// Handler(Controller)</span>
<span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/new-post"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">postFormSubmit</span><span class="o">(</span><span class="nd">@LoggedInUser</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">,</span> <span class="nd">@Valid</span> <span class="nc">NewPostForm</span> <span class="n">newPostForm</span><span class="o">,</span> <span class="nc">Errors</span> <span class="n">errors</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">errors</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"post/form"</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postService</span><span class="o">.</span><span class="na">createNewPost</span><span class="o">(</span><span class="n">modelMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">newPostForm</span><span class="o">,</span> <span class="nc">Post</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">account</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"redirect:/posts/"</span> <span class="o">+</span> <span class="n">post</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
<span class="o">}</span>

<span class="c1">// Service</span>
<span class="kd">public</span> <span class="nc">Post</span> <span class="nf">createNewPost</span><span class="o">(</span><span class="nc">Post</span> <span class="n">newPost</span><span class="o">,</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">Account</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getEmail</span><span class="o">());</span>
<span class="c1">//         Detached 상태인 애를 데려오기</span>

        <span class="n">newPost</span><span class="o">.</span><span class="na">setWriter</span><span class="o">(</span><span class="n">writer</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">newPost</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// post.setWriter</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setWriter</span><span class="o">(</span><span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">account</span> <span class="o">=</span> <span class="n">account</span><span class="o">;</span>
    <span class="n">account</span><span class="o">.</span><span class="na">postAdd</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// account.postAdd</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">postAdd</span><span class="o">(</span><span class="nc">Post</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">getPosts</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">postCount</span><span class="o">++;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>여기서 findAccountByEmail은 LAZY로 설정된 연결 객체(Post,Reply)등을 가져오지 않고 순수 Account의 프로퍼티만 가져오는 것에 해당한다. 이 로직을 통해 예상해본 쿼리는 다음과 같다.</p><ol><li>가장 먼저, Detached상태인 Account를 깨워주기 위한 <strong>SELECT</strong> 문이 나갈것이다. (email을 통해서)<li>이후 Post(게시글)에 대한 <strong>Insert</strong> 문을 보내게 된다. 여기에는 연결된 account의 정보가 이미 포함되어있다.<li>양방향 매핑 매서드인 <code class="language-plaintext highlighter-rouge">setWriter()</code>를 통해 account.postAdd()를 호출하게 되고 postCount를 1증가시켜주는 <strong>Update</strong> 문이 나가게 된다.</ol><p><br /> 실제 쿼리는 다음과 같았다.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        account0_.id as id1_0_,
        account0_.created_date as created_2_0_,
        account0_.modified_date as modified3_0_,
        account0_.bio as bio4_0_,
        account0_.email as email5_0_,
        account0_.nickname as nickname6_0_,
        account0_.password as password7_0_,
        account0_.post_count as post_cou8_0_,
        account0_.profile_image as profile_9_0_,
        account0_.reply_count as reply_c10_0_ 
    from
        account account0_ 
    where
        account0_.email=?
Hibernate: 
    select
        posts0_.account_id as account_9_1_0_,
        posts0_.id as id1_1_0_,
        posts0_.id as id1_1_1_,
        posts0_.created_date as created_2_1_1_,
        posts0_.modified_date as modified3_1_1_,
        posts0_.account_id as account_9_1_1_,
        posts0_.description as descript4_1_1_,
        posts0_.introduction as introduc5_1_1_,
        posts0_.open as open6_1_1_,
        posts0_.reply_count as reply_co7_1_1_,
        posts0_.title as title8_1_1_ 
    from
        post posts0_ 
    where
        posts0_.account_id=?
Hibernate: 
    insert 
    into
        post
        (id, created_date, modified_date, account_id, description, introduction, open, reply_count, title) 
    values
        (null, ?, ?, ?, ?, ?, ?, ?, ?)
Hibernate: 
    update
        account 
    set
        created_date=?,
        modified_date=?,
        bio=?,
        email=?,
        nickname=?,
        password=?,
        post_count=?,
        profile_image=?,
        reply_count=? 
    where
        id=?
</pre></table></code></div></div><blockquote><p>엇.. 내가 예상했던 쿼리보다 1개가 더 많다.</p></blockquote><p>예상대로 첫번째 쿼리는 Detached 상태를 깨워주는 쿼리이며, 세번째는 Post에 대한 Insert 쿼리, 그리고 마지막은 Account에 대한 Update 쿼리가 나갔다. 두번째 쿼리는 정체가 뭘까?</p><p><br /> 두번째 쿼리는 바로 <code class="language-plaintext highlighter-rouge">account.postAdd()</code> 메서드 떄문에 생겨난 것이다. 이는 account 객체의 getPosts()에 새로운 게시글을 넣어주는 <strong>양방향 매핑 메서드</strong> 에 해당한다. 이때 account가 가지고 있는 post들을 모두 긁어와야 하므로 두번째와 같은 쿼리가 나타나게 되는 것이다.</p><blockquote><p>이를 좀 더 효율적으로 바꿀 순 없을까?</p></blockquote><p><br /></p><h3 id="좀-더-효율적인-방식으로-바꾸어-보기글-작성">좀 더 효율적인 방식으로 바꾸어 보기(글 작성)</h3><p>필자는 이 두번째 쿼리를 없애버릴 수 있겠다는 생각을 했다. 처음 Detached 상태인 account를 가져올 때, 관련된 post 까지 모두 가져오면 되지 않겠는가? <br /> 따라서 서비스단에서 Detached 상태인 Account를 가져오는 쿼리를 다음과 같이 수정했다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c1">// Service</span>

<span class="kd">public</span> <span class="nc">Post</span> <span class="nf">createNewPost</span><span class="o">(</span><span class="nc">Post</span> <span class="n">newPost</span><span class="o">,</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>

<span class="c1">//        Account writer = accountRepository.findByEmail(account.getEmail());</span>
<span class="c1">// 기존방식</span>
    <span class="nc">Account</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findAccountWithPostsByEmail</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getEmail</span><span class="o">());</span>
<span class="c1">//  새로운 방식</span>
    <span class="n">newPost</span><span class="o">.</span><span class="na">setWriter</span><span class="o">(</span><span class="n">writer</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">newPost</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// AccountRepository.java</span>
<span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Account</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="cm">/**
    이전 코드들
    */</span>

    <span class="nd">@Query</span><span class="o">(</span><span class="s">"select a from Account a left join fetch a.posts where a.email = :email"</span><span class="o">)</span>
    <span class="nc">Account</span> <span class="nf">findAccountWithPostsByEmail</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"email"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">email</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>여러가지 방법이 있지만, 필자는 @Query를 이용해 fetch join한 결과를 가져왔다. 이렇게 되면 account 객체를 가져올때 연관된 post들이 한꺼번에 검색되어 딸려오게 된다.</p><p><br /> 이렇게 적용한 결과 쿼리는 어떻게 바뀔까?</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        account0_.id as id1_0_0_,
        posts1_.id as id1_1_1_,
        account0_.created_date as created_2_0_0_,
        account0_.modified_date as modified3_0_0_,
        account0_.bio as bio4_0_0_,
        account0_.email as email5_0_0_,
        account0_.nickname as nickname6_0_0_,
        account0_.password as password7_0_0_,
        account0_.post_count as post_cou8_0_0_,
        account0_.profile_image as profile_9_0_0_,
        account0_.reply_count as reply_c10_0_0_,
        posts1_.created_date as created_2_1_1_,
        posts1_.modified_date as modified3_1_1_,
        posts1_.account_id as account_9_1_1_,
        posts1_.description as descript4_1_1_,
        posts1_.introduction as introduc5_1_1_,
        posts1_.open as open6_1_1_,
        posts1_.reply_count as reply_co7_1_1_,
        posts1_.title as title8_1_1_,
        posts1_.account_id as account_9_1_0__,
        posts1_.id as id1_1_0__ 
    from
        account account0_ 
    left outer join
        post posts1_ 
            on account0_.id=posts1_.account_id 
    where
        account0_.email=?
Hibernate: 
    insert 
    into
        post
        (id, created_date, modified_date, account_id, description, introduction, open, reply_count, title) 
    values
        (null, ?, ?, ?, ?, ?, ?, ?, ?)
Hibernate: 
    update
        account 
    set
        created_date=?,
        modified_date=?,
        bio=?,
        email=?,
        nickname=?,
        password=?,
        post_count=?,
        profile_image=?,
        reply_count=? 
    where
        id=?
</pre></table></code></div></div><p>쿼리 3개로 마무리 되었다. 제일 처음의 select문은 Account와 함께 연관된 post들을 모두 가져온다.</p><blockquote><p>사실 쿼리 개수가 적어진다고 무조건 성능이 좋아지는 것은 아니다. Grafana와 같은 모니터링 툴이 있다면 효율을 더 잘 따져볼 수 있다.</p></blockquote><p><br /> 🤔 그런데 ‘왜 <code class="language-plaintext highlighter-rouge">account.getPosts()</code> 에 새로운 객체를 추가했는데 Insert문이나 Update문이 안나가지?’ 라고 생각할 수 있다. 이는 DB와 객체지향언어의 패러다임 차이를 생각해 보면 금방 알 수 있다. 이 정보는 데이터베이스가 가지고있어야할 정보가 아니기 때문이다.</p><hr /><h2 id="글-상세보기-뷰">글 상세보기 뷰</h2><p>글을 쓰고 나면 다음과 같은 페이지로 리다이렉팅이 되는데 이때의 뷰가 글 상세보기 뷰에 해당한다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/32.JPG" /></p><p>이때의 쿼리는 다음의 로직을 따라 생성된다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="c1">// Controller</span>
<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/posts/{id}"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">postView</span><span class="o">(</span><span class="nd">@LoggedInUser</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">findPostWithUserAndRepliesById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">post</span><span class="o">.</span><span class="na">isOpen</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"redirect:/"</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"post"</span><span class="o">,</span> <span class="n">post</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="k">new</span> <span class="nc">NewReplyForm</span><span class="o">());</span>
    <span class="k">return</span> <span class="s">"post/view"</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// PostRepository.java</span>
<span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PostRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;,</span> <span class="nc">PostRepositoryEx</span> <span class="o">{</span>

    <span class="nd">@EntityGraph</span><span class="o">(</span><span class="n">attributePaths</span> <span class="o">=</span> <span class="o">{</span><span class="s">"description"</span><span class="o">,</span><span class="s">"account"</span><span class="o">,</span><span class="s">"replies"</span><span class="o">},</span> <span class="n">type</span> <span class="o">=</span> <span class="nc">EntityGraph</span><span class="o">.</span><span class="na">EntityGraphType</span><span class="o">.</span><span class="na">LOAD</span><span class="o">)</span>
    <span class="nc">Post</span> <span class="nf">findPostWithUserAndRepliesById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>

    <span class="cm">/**
    이전 코드들
    */</span>

<span class="o">}</span>
</pre></table></code></div></div><p>사실 이 쿼리에 대해서는 지난시간에 이미 진행한적이 있다. <a href="https://vitriol95.github.io/posts/mvcproject5/">이곳</a>에서 상세히 다루어두었다. 따라서 쿼리는 다음과 같이 SELECT문 하나로 정리가 된다.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        post0_.id as id1_1_0_,
        replies1_.id as id1_2_1_,
        account2_.id as id1_0_2_,
        post0_.created_date as created_2_1_0_,
        post0_.modified_date as modified3_1_0_,
        post0_.account_id as account_9_1_0_,
        post0_.description as descript4_1_0_,
        post0_.introduction as introduc5_1_0_,
        post0_.open as open6_1_0_,
        post0_.reply_count as reply_co7_1_0_,
        post0_.title as title8_1_0_,
        replies1_.created_date as created_2_2_1_,
        replies1_.modified_date as modified3_2_1_,
        replies1_.account_id as account_5_2_1_,
        replies1_.description as descript4_2_1_,
        replies1_.post_id as post_id6_2_1_,
        replies1_.post_id as post_id6_2_0__,
        replies1_.id as id1_2_0__,
        account2_.created_date as created_2_0_2_,
        account2_.modified_date as modified3_0_2_,
        account2_.bio as bio4_0_2_,
        account2_.email as email5_0_2_,
        account2_.nickname as nickname6_0_2_,
        account2_.password as password7_0_2_,
        account2_.post_count as post_cou8_0_2_,
        account2_.profile_image as profile_9_0_2_,
        account2_.reply_count as reply_c10_0_2_ 
    from
        post post0_ 
    left outer join
        reply replies1_ 
            on post0_.id=replies1_.post_id 
    left outer join
        account account2_ 
            on post0_.account_id=account2_.id 
    where
        post0_.id=?
</pre></table></code></div></div><p>다음과 같이 Post의 글쓴이, 댓글들과 함께 댓글들의 글쓴이들이 모두 outerjoin되어 딸려오고 있다.</p><h3 id="좀-더-효율적으로-바꾸어보기-글-상세보기-뷰">좀 더 효율적으로 바꾸어보기 (글 상세보기 뷰)</h3><p>좀 더 효율적인 방법이라기 보다는 JPQL의 @Query를 이용해 좀 더 가독성 있게 바꾸어 보았다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c1">// PostRepository.java</span>

<span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PostRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;,</span> <span class="nc">PostRepositoryEx</span> <span class="o">{</span>

    
    <span class="c1">// @EntityGraph(attributePaths = {"description","account","replies"}, type = EntityGraph.EntityGraphType.LOAD)</span>
    <span class="c1">// Post findPostWithUserAndRepliesById(Long id); </span>

    <span class="c1">// 대체</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"select distinct p from Post p join fetch p.account left join fetch p.replies where p.id = :id"</span><span class="o">)</span>
    <span class="nc">Post</span> <span class="nf">findPostWithAccountAndRepliesById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>
    
<span class="o">}</span>
</pre></table></code></div></div><p>그리고 댓글이 4개 달렸을 시 위 쿼리에 의한 DB상태는 다음과 같다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/33.JPG" /></p><blockquote><p>1:N 상황에 해당하므로 댓글이 4개 달렸을시 다음과 같은 결과가 나오게 된다. 그리고 @Query에 distinct는 사실 없어도 된다.</p></blockquote><hr /><h2 id="글-수정-및-삭제">글 수정 및 삭제</h2><h3 id="글-수정-뷰">글 수정 뷰</h3><p>글을 수정하는 경우 뷰는 아래와 같다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/34.JPG" /></p><p>이때 발생하는 쿼리는 다음과 같은 로직을 따른다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="c1">// Controller</span>
<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/posts/{id}/update"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">updatePostFormView</span><span class="o">(</span><span class="nd">@LoggedInUser</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postService</span><span class="o">.</span><span class="na">getPostToUpdate</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">account</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
    <span class="nc">NewPostForm</span> <span class="n">map</span> <span class="o">=</span> <span class="n">modelMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">post</span><span class="o">,</span> <span class="nc">NewPostForm</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"newPostForm"</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"post/update"</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// Service</span>
<span class="kd">public</span> <span class="nc">Post</span> <span class="nf">getPostToUpdate</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">findPostWithAccountById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="n">validateWriter</span><span class="o">(</span><span class="n">account</span><span class="o">,</span> <span class="n">post</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">post</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">validateWriter</span><span class="o">(</span><span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="nc">Post</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">post</span><span class="o">.</span><span class="na">isWriter</span><span class="o">(</span><span class="n">account</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">AccessDeniedException</span><span class="o">(</span><span class="s">"작성자가 아닙니다."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Repo</span>
<span class="nd">@EntityGraph</span><span class="o">(</span><span class="n">attributePaths</span> <span class="o">=</span> <span class="s">"account"</span><span class="o">,</span><span class="n">type</span> <span class="o">=</span> <span class="nc">EntityGraph</span><span class="o">.</span><span class="na">EntityGraphType</span><span class="o">.</span><span class="na">LOAD</span><span class="o">)</span>
<span class="nc">Post</span> <span class="nf">findPostWithAccountById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>
</pre></table></code></div></div><p>실질적으로 쿼리는 <code class="language-plaintext highlighter-rouge">postService.getPostToUpdate</code>에 의해 하나가 발생할 것이다. 이는 <code class="language-plaintext highlighter-rouge">postRepository.findPostWithAccountById</code>를 호출하여 Post객체와 연관된 Account(글쓴이)를 함께 불러오게 된다.</p><blockquote><p>여기서 댓글까지 불러올 필요가 없다.</p></blockquote><p><br /> 이후 <code class="language-plaintext highlighter-rouge">validateWriter()</code> 메서드를 통해 현재 스프링 시큐리티 컨텍스트에 담긴 Account가 글쓴이와 맞는지 확인하는 과정을 거친다. 이때 발생하는 쿼리는 없을 것이다.</p><p><br /> 실제 쿼리는 아래와 같았다.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        post0_.id as id1_1_0_,
        account1_.id as id1_0_1_,
        post0_.created_date as created_2_1_0_,
        post0_.modified_date as modified3_1_0_,
        post0_.account_id as account_9_1_0_,
        post0_.description as descript4_1_0_,
        post0_.introduction as introduc5_1_0_,
        post0_.open as open6_1_0_,
        post0_.reply_count as reply_co7_1_0_,
        post0_.title as title8_1_0_,
        account1_.created_date as created_2_0_1_,
        account1_.modified_date as modified3_0_1_,
        account1_.bio as bio4_0_1_,
        account1_.email as email5_0_1_,
        account1_.nickname as nickname6_0_1_,
        account1_.password as password7_0_1_,
        account1_.post_count as post_cou8_0_1_,
        account1_.profile_image as profile_9_0_1_,
        account1_.reply_count as reply_c10_0_1_ 
    from
        post post0_ 
    left outer join
        account account1_ 
            on post0_.account_id=account1_.id 
    where
        post0_.id=?
</pre></table></code></div></div><p>이 SELECT문 하나만 나가게 되고, modelMapper에 의해 DTO로 변경되어 뷰에 그려지게 된다.</p><h3 id="글-수정-post-요청">글 수정 POST 요청</h3><p>가장 먼저 쿼리는 다음과 같은 로직을 따라 생성될 것이다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="c1">// Controller</span>
<span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/posts/{id}/update"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">updatePostFormSubmit</span><span class="o">(</span><span class="nd">@LoggedInUser</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">,</span> <span class="nd">@Valid</span> <span class="nc">NewPostForm</span> <span class="n">newPostForm</span><span class="o">,</span> <span class="nc">Errors</span> <span class="n">errors</span><span class="o">)</span> <span class="o">{</span>

    <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postService</span><span class="o">.</span><span class="na">getPostToUpdate</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">account</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">errors</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"post/update"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
    <span class="n">postService</span><span class="o">.</span><span class="na">updatePost</span><span class="o">(</span><span class="n">post</span><span class="o">,</span> <span class="n">newPostForm</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"redirect:/posts/"</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// Service </span>
<span class="kd">public</span> <span class="nc">Post</span> <span class="nf">getPostToUpdate</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">findPostWithAccountById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="n">validateWriter</span><span class="o">(</span><span class="n">account</span><span class="o">,</span> <span class="n">post</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">post</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">updatePost</span><span class="o">(</span><span class="nc">Post</span> <span class="n">post</span><span class="o">,</span> <span class="nc">NewPostForm</span> <span class="n">newPostForm</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">modelMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">newPostForm</span><span class="o">,</span> <span class="n">post</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>코드를 기반으로 예측한 쿼리 순서는 다음과 같을 것이다.</p><ol><li>가장먼저 글 수정뷰 단에서의 post객체를 가져온 것 같이, <code class="language-plaintext highlighter-rouge">postService.getPostToUpdate</code>로 인해 post와 글쓴이 정보를 가져올 것이다. (<strong>SELECT문</strong>)<blockquote><p>곧바로 validating을 진행한다. 이때 발생하는 쿼리는 없다.</p></blockquote><li>이후, <code class="language-plaintext highlighter-rouge">postService.updatePost</code>로 인해 post객체가 변경된 객체로 채워지게 되며 이때 <strong>update</strong> 문이 나갈것이다.</ol><p><br /> 실제 쿼리는 다음과 같았다.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        post0_.id as id1_1_0_,
        account1_.id as id1_0_1_,
        post0_.created_date as created_2_1_0_,
        post0_.modified_date as modified3_1_0_,
        post0_.account_id as account_9_1_0_,
        post0_.description as descript4_1_0_,
        post0_.introduction as introduc5_1_0_,
        post0_.open as open6_1_0_,
        post0_.reply_count as reply_co7_1_0_,
        post0_.title as title8_1_0_,
        account1_.created_date as created_2_0_1_,
        account1_.modified_date as modified3_0_1_,
        account1_.bio as bio4_0_1_,
        account1_.email as email5_0_1_,
        account1_.nickname as nickname6_0_1_,
        account1_.password as password7_0_1_,
        account1_.post_count as post_cou8_0_1_,
        account1_.profile_image as profile_9_0_1_,
        account1_.reply_count as reply_c10_0_1_ 
    from
        post post0_ 
    left outer join
        account account1_ 
            on post0_.account_id=account1_.id 
    where
        post0_.id=?

Hibernate: 
    update
        post 
    set
        created_date=?,
        modified_date=?,
        account_id=?,
        description=?,
        introduction=?,
        open=?,
        reply_count=?,
        title=? 
    where
        id=?
</pre></table></code></div></div><p>예상했던 대로 쿼리가 잘 나가고 있다.</p><h3 id="글-삭제-post-요청">글 삭제 POST 요청</h3><p>다음으로 글 삭제 요청에 대해 살펴보자. 사실 이 부분에 대한 쿼리가 정말 어렵다. 왜냐하면 다음과 같은 요청을 해주어야 하기 때문이다.</p><ol><li>Post와 Reply의 연관관계의 주인은 Reply에 해당한다. 하지만 참조 무결성 조건을 Cascade로 주었기 때문에 Post에 딸려있는 댓글 객체들이 모두 삭제되어야 한다.<li>Account(글쓴이)와 Post는 양방향 매핑 관계이므로 account가 가지고 있는 post목록에서 본 post를 지워야한다. 또한 postCount를 1내려주어야한다.<li>딸려 있는 Reply가 삭제될 경우 이 댓글을 달았던 account객체들의 replyCount를 1씩 내려주어야 한다.<blockquote><p>댓글 수가 많은 글이 삭제될 수록 쿼리가 더 어마어마 해질것 같다..</p></blockquote></ol><p><br /> 가장 먼저 쿼리가 어떤 흐름으로 나가게 될지, 코드를 통해 살펴보자.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="c1">// PostController.java</span>

<span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/posts/{id}/delete"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">deletePostSubmit</span><span class="o">(</span><span class="nd">@LoggedInUser</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postService</span><span class="o">.</span><span class="na">getPostToDelete</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">account</span><span class="o">);</span>
    <span class="n">postService</span><span class="o">.</span><span class="na">deletePost</span><span class="o">(</span><span class="n">post</span><span class="o">,</span> <span class="n">account</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"redirect:/"</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// PostService.java</span>

<span class="kd">public</span> <span class="nc">Post</span> <span class="nf">getPostToDelete</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">findPostWithAccountAndRepliesById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="n">validateWriter</span><span class="o">(</span><span class="n">account</span><span class="o">,</span> <span class="n">post</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">post</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">deletePost</span><span class="o">(</span><span class="nc">Post</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">post</span><span class="o">.</span><span class="na">unsetWriter</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">getAccount</span><span class="o">());</span>
    <span class="n">post</span><span class="o">.</span><span class="na">getReplies</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">reply</span> <span class="o">-&gt;</span> <span class="n">reply</span><span class="o">.</span><span class="na">unsetWriter</span><span class="o">(</span><span class="n">reply</span><span class="o">.</span><span class="na">getAccount</span><span class="o">()));</span>
    <span class="n">postRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// PostRepository.java</span>

<span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"select distinct p from Post p join fetch p.account left join fetch p.replies where p.id = :id"</span><span class="o">)</span>
<span class="nc">Post</span> <span class="nf">findPostWithAccountAndRepliesById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>

<span class="c1">// Post.java</span>

<span class="cm">/** 양방향 매핑 메서드 With Post*/</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">unsetWriter</span><span class="o">(</span><span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">account</span><span class="o">.</span><span class="na">postRemove</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// Reply.java</span>

<span class="cm">/** 양방향 매핑 메서드 With Account */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">unsetWriter</span><span class="o">(</span><span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">account</span><span class="o">.</span><span class="na">replyRemove</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// Account.java</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">postRemove</span><span class="o">(</span><span class="nc">Post</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">getPosts</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">postCount</span><span class="o">--;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">replyRemove</span><span class="o">(</span><span class="nc">Reply</span> <span class="n">reply</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">getReplies</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="n">reply</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">replyCount</span><span class="o">--;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>많은 요구사항처럼, 코드양이 적지 않다. 일단 흐름을 따라 쿼리가 어떻게 작성될지 예상해보자.</p><h3 id="댓글이-없을-경우">댓글이 없을 경우</h3><ol><li>가장먼저 <code class="language-plaintext highlighter-rouge">postService.getPostToDelete</code>를 호출한다. 여기서는 <code class="language-plaintext highlighter-rouge">postRepository.findPostWithAccountAndRepliesById</code>를 통해 post의 account(글쓴이), replies(댓글들)을 모두 가져오게된다. (<strong>SELECT</strong> 문)<blockquote><p>이 replies를 가져오게 되면. Reply와 Account(댓글쓴이)는 fetch 타입이 EAGER이므로 자동으로 댓글쓴이들 까지 모두 가져온다.</p></blockquote><li>이후 글쓴이 확인을 위한 validating을 진행하고 이후 <code class="language-plaintext highlighter-rouge">postService.deletePost</code>를 호출한다.<blockquote><p>역시 validating의 경우 추가 쿼리는 발생하지 않는다.</p></blockquote><li>양방향 매핑 메서드인 <code class="language-plaintext highlighter-rouge">post.unsetWriter</code>를 호출한다. 이는 post의 글쓴이 객체를 파라미터로 넘긴다. 이 글쓴이 객체(Account)는 이미 페치조인으로 긁어왔기에 추가 쿼리는 발생하지 않는다.<li><code class="language-plaintext highlighter-rouge">post.unsetWriter</code>는 <code class="language-plaintext highlighter-rouge">account.replyRemove()</code>를 부르게 되고 여기서 <code class="language-plaintext highlighter-rouge">this(account).getPosts()</code>에 의해 <strong>SELECT</strong> 문이 발생하게 될 것이다.<blockquote><p>Account(글쓴이)와 Post의 fetch 타입은 LAZY 이기 때문이다.</p></blockquote><li><code class="language-plaintext highlighter-rouge">this.getPosts()</code>로 가져온 목록에서 삭제할 post를 없애고, postCount를 1내려준다. 이때 Account에 대한 <strong>UPDATE</strong> 문이 나가게 될 것이다.<li>마지막으로 <code class="language-plaintext highlighter-rouge">postRepository.delete()</code>에 의해 post가 삭제되는 <strong>DELETE</strong> 문이 나간다.</ol><p><br /> 실제 쿼리는 다음과 같았다.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        distinct post0_.id as id1_1_0_,
        account1_.id as id1_0_1_,
        replies2_.id as id1_2_2_,
        post0_.created_date as created_2_1_0_,
        post0_.modified_date as modified3_1_0_,
        post0_.account_id as account_9_1_0_,
        post0_.description as descript4_1_0_,
        post0_.introduction as introduc5_1_0_,
        post0_.open as open6_1_0_,
        post0_.reply_count as reply_co7_1_0_,
        post0_.title as title8_1_0_,
        account1_.created_date as created_2_0_1_,
        account1_.modified_date as modified3_0_1_,
        account1_.bio as bio4_0_1_,
        account1_.email as email5_0_1_,
        account1_.nickname as nickname6_0_1_,
        account1_.password as password7_0_1_,
        account1_.post_count as post_cou8_0_1_,
        account1_.profile_image as profile_9_0_1_,
        account1_.reply_count as reply_c10_0_1_,
        replies2_.created_date as created_2_2_2_,
        replies2_.modified_date as modified3_2_2_,
        replies2_.account_id as account_5_2_2_,
        replies2_.description as descript4_2_2_,
        replies2_.post_id as post_id6_2_2_,
        replies2_.post_id as post_id6_2_0__,
        replies2_.id as id1_2_0__ 
    from
        post post0_ 
    inner join
        account account1_ 
            on post0_.account_id=account1_.id 
    left outer join
        reply replies2_ 
            on post0_.id=replies2_.post_id 
    where
        post0_.id=?
Hibernate: 
    select
        posts0_.account_id as account_9_1_0_,
        posts0_.id as id1_1_0_,
        posts0_.id as id1_1_1_,
        posts0_.created_date as created_2_1_1_,
        posts0_.modified_date as modified3_1_1_,
        posts0_.account_id as account_9_1_1_,
        posts0_.description as descript4_1_1_,
        posts0_.introduction as introduc5_1_1_,
        posts0_.open as open6_1_1_,
        posts0_.reply_count as reply_co7_1_1_,
        posts0_.title as title8_1_1_ 
    from
        post posts0_ 
    where
        posts0_.account_id=?
Hibernate: 
    update
        account 
    set
        created_date=?,
        modified_date=?,
        bio=?,
        email=?,
        nickname=?,
        password=?,
        post_count=?,
        profile_image=?,
        reply_count=? 
    where
        id=?
Hibernate: 
    delete 
    from
        post 
    where
        id=?
</pre></table></code></div></div><p>앞서 이야기한대로 2개의 SELECT문과 1개의 UPDATE문, 1개의 DELETE문이 나가고 있었다. 예상이 맞아서 나름 만족스럽다.. 😀 <br /></p><h3 id="댓글이-있는-경우">댓글이 있는 경우</h3><p>앞선 코드에서 21번째 라인에 해당하는 코드가 적용되게 된다. 전체적인 순서는 댓글이 없는 경우를 따르지만, 여기서 추가로 발생하는 쿼리들이 존재한다.</p><ol><li>댓글이 없는 경우의 1~5 과정을 모두 따른다. 이때 <strong>2개의 SELECT</strong> 문과 <strong>1개의 UPDATE</strong> 문이 나가게 된다.<li>이후 <code class="language-plaintext highlighter-rouge">post.getRepies().forEach()</code>를 수행한다. post내의 replies들은 모두 페치조인에 의해 가져왔으므로 추가 쿼리는 발생하지 않는다. 하지만 forEach()내의 람다식을 살펴보면 <code class="language-plaintext highlighter-rouge">reply.unsetWriter()</code>이 반복되고 있다.<li><code class="language-plaintext highlighter-rouge">reply.unsetWriter()</code>에 파라미터는 reply의 account(댓글쓴이)가 될 것이다. 이때 Reply와 Account는 fetch타입이 EAGER이므로 추가 쿼리가 필요하지 않는다.<li><code class="language-plaintext highlighter-rouge">reply.unsetWriter()</code>는 <code class="language-plaintext highlighter-rouge">account.replyRemove()</code>를 호출한다. 이때 <code class="language-plaintext highlighter-rouge">this.getReplies()</code>로 인해 replies를 가져오는 <strong>SELECT</strong> 문이 발생할 것이다. 이후 이 리스트 내에서 삭제될 reply를 지운다.<li>이후 account의 replyCount가 1감소되므로 <strong>UPDATE</strong> 문이 발생한다.<li>마지막으로 글이 삭제되는 <strong>DELETE</strong> 문이 나가게 된다. 그리고 참조 제약조건(Cascade)에 의해 reply도 삭제되는 <strong>DELETE</strong> 문이 나가게 된다.</ol><p><br /> 만약 댓글이 3개가 달린 상황이라고 생각해보자(글쓴이와 댓글쓴이가 모두 다르다고 가정). 이때 각 댓글쓴이마다 replies를 가져와야하므로 SELECT문이 3개가 나가게 될 것이다. <br />그리고 각 댓글쓴이(account)의 replyCount가 1씩 내려가야 하므로 3개의 UPDATE문이 나간다. 마지막으로 replies에 대한 DELETE문도 3개가 나갈것이다.</p><p><br /> 댓글을 3개 달아놓고, 테스트 해보았다.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        distinct post0_.id as id1_1_0_,
        account1_.id as id1_0_1_,
        replies2_.id as id1_2_2_,
        post0_.created_date as created_2_1_0_,
        post0_.modified_date as modified3_1_0_,
        post0_.account_id as account_9_1_0_,
        post0_.description as descript4_1_0_,
        post0_.introduction as introduc5_1_0_,
        post0_.open as open6_1_0_,
        post0_.reply_count as reply_co7_1_0_,
        post0_.title as title8_1_0_,
        account1_.created_date as created_2_0_1_,
        account1_.modified_date as modified3_0_1_,
        account1_.bio as bio4_0_1_,
        account1_.email as email5_0_1_,
        account1_.nickname as nickname6_0_1_,
        account1_.password as password7_0_1_,
        account1_.post_count as post_cou8_0_1_,
        account1_.profile_image as profile_9_0_1_,
        account1_.reply_count as reply_c10_0_1_,
        replies2_.created_date as created_2_2_2_,
        replies2_.modified_date as modified3_2_2_,
        replies2_.account_id as account_5_2_2_,
        replies2_.description as descript4_2_2_,
        replies2_.post_id as post_id6_2_2_,
        replies2_.post_id as post_id6_2_0__,
        replies2_.id as id1_2_0__ 
    from
        post post0_ 
    inner join
        account account1_ 
            on post0_.account_id=account1_.id 
    left outer join
        reply replies2_ 
            on post0_.id=replies2_.post_id 
    where
        post0_.id=?
!**** Hibernate: **************!
    select
        account0_.id as id1_0_0_,
        account0_.created_date as created_2_0_0_,
        account0_.modified_date as modified3_0_0_,
        account0_.bio as bio4_0_0_,
        account0_.email as email5_0_0_,
        account0_.nickname as nickname6_0_0_,
        account0_.password as password7_0_0_,
        account0_.post_count as post_cou8_0_0_,
        account0_.profile_image as profile_9_0_0_,
        account0_.reply_count as reply_c10_0_0_ 
    from
        account account0_ 
    where
        account0_.id=?
!**** Hibernate: **************!
    select
        account0_.id as id1_0_0_,
        account0_.created_date as created_2_0_0_,
        account0_.modified_date as modified3_0_0_,
        account0_.bio as bio4_0_0_,
        account0_.email as email5_0_0_,
        account0_.nickname as nickname6_0_0_,
        account0_.password as password7_0_0_,
        account0_.post_count as post_cou8_0_0_,
        account0_.profile_image as profile_9_0_0_,
        account0_.reply_count as reply_c10_0_0_ 
    from
        account account0_ 
    where
        account0_.id=?
!**** Hibernate: **************!
    select
        account0_.id as id1_0_0_,
        account0_.created_date as created_2_0_0_,
        account0_.modified_date as modified3_0_0_,
        account0_.bio as bio4_0_0_,
        account0_.email as email5_0_0_,
        account0_.nickname as nickname6_0_0_,
        account0_.password as password7_0_0_,
        account0_.post_count as post_cou8_0_0_,
        account0_.profile_image as profile_9_0_0_,
        account0_.reply_count as reply_c10_0_0_ 
    from
        account account0_ 
    where
        account0_.id=?
Hibernate: 
    select
        posts0_.account_id as account_9_1_0_,
        posts0_.id as id1_1_0_,
        posts0_.id as id1_1_1_,
        posts0_.created_date as created_2_1_1_,
        posts0_.modified_date as modified3_1_1_,
        posts0_.account_id as account_9_1_1_,
        posts0_.description as descript4_1_1_,
        posts0_.introduction as introduc5_1_1_,
        posts0_.open as open6_1_1_,
        posts0_.reply_count as reply_co7_1_1_,
        posts0_.title as title8_1_1_ 
    from
        post posts0_ 
    where
        posts0_.account_id=?
Hibernate: 
    select
        replies0_.account_id as account_5_2_0_,
        replies0_.id as id1_2_0_,
        replies0_.id as id1_2_1_,
        replies0_.created_date as created_2_2_1_,
        replies0_.modified_date as modified3_2_1_,
        replies0_.account_id as account_5_2_1_,
        replies0_.description as descript4_2_1_,
        replies0_.post_id as post_id6_2_1_ 
    from
        reply replies0_ 
    where
        replies0_.account_id=?
Hibernate: 
    select
        replies0_.account_id as account_5_2_0_,
        replies0_.id as id1_2_0_,
        replies0_.id as id1_2_1_,
        replies0_.created_date as created_2_2_1_,
        replies0_.modified_date as modified3_2_1_,
        replies0_.account_id as account_5_2_1_,
        replies0_.description as descript4_2_1_,
        replies0_.post_id as post_id6_2_1_ 
    from
        reply replies0_ 
    where
        replies0_.account_id=?
Hibernate: 
    select
        replies0_.account_id as account_5_2_0_,
        replies0_.id as id1_2_0_,
        replies0_.id as id1_2_1_,
        replies0_.created_date as created_2_2_1_,
        replies0_.modified_date as modified3_2_1_,
        replies0_.account_id as account_5_2_1_,
        replies0_.description as descript4_2_1_,
        replies0_.post_id as post_id6_2_1_ 
    from
        reply replies0_ 
    where
        replies0_.account_id=?
Hibernate: 
    update
        account 
    set
        created_date=?,
        modified_date=?,
        bio=?,
        email=?,
        nickname=?,
        password=?,
        post_count=?,
        profile_image=?,
        reply_count=? 
    where
        id=?
Hibernate: 
    update
        account 
    set
        created_date=?,
        modified_date=?,
        bio=?,
        email=?,
        nickname=?,
        password=?,
        post_count=?,
        profile_image=?,
        reply_count=? 
    where
        id=?
Hibernate: 
    update
        account 
    set
        created_date=?,
        modified_date=?,
        bio=?,
        email=?,
        nickname=?,
        password=?,
        post_count=?,
        profile_image=?,
        reply_count=? 
    where
        id=?
Hibernate: 
    delete 
    from
        reply 
    where
        id=?
Hibernate: 
    delete 
    from
        reply 
    where
        id=?
Hibernate: 
    delete 
    from
        reply 
    where
        id=?
Hibernate: 
    delete 
    from
        post 
    where
        id=?

</pre></table></code></div></div><p>댓글이 3개인 상황이지만, 쿼리 개수가 무시무시했다..</p><p><br /> 그리고 <em>**</em>! 쳐져있는 쿼리들은 예상하지 못한 쿼리들이다. Account객체 3개를 SELECT해오고 있는데, 댓글쓴이를 또 다시 가져오고 있는 상황에 해당한다. <br />😅 아.. 이걸 생각 못하고 있었다. 댓글쓴이들은 UPDATE문(replyCount–)이 나가야 하기에 Managed상태로 올려놓아야 한다. 따라서 쿼리안에 댓글쓴이도 함께 페치조인하여 가져와야한다.</p><blockquote><p>흔히 말하는 1 + N 문제이다. 이를 구현하면 댓글쓴이에 대한 SELECT문 3개는 없어지게 될 것이다.</p></blockquote><h2><br /></h2><h1 id="중요-변화">중요 변화</h1><p>이부분을 수정함에 있어서 많은 고민을 해보았다.. 그 과정에서 갑자기 이생각이 났다. ‘지금 상황에서 어떠한 객체와도 Account는 양방향 매핑일 이유가 없다..’ 😅 조금 고생스럽겠지만, 이 양방향 관계를 변경하고 마지막 쿼리 테스트를 해본 뒤, 최종 코드를 올려보도록 하겠다.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/spring/'>Spring</a>, <a href='/categories/spring-project/'>spring_project</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring/" class="post-tag no-text-decoration" >spring</a> <a href="/tags/spring-mvc/" class="post-tag no-text-decoration" >spring mvc</a> <a href="/tags/springboot/" class="post-tag no-text-decoration" >springboot</a> <a href="/tags/springframework/" class="post-tag no-text-decoration" >springframework</a> <a href="/tags/java/" class="post-tag no-text-decoration" >java</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(7) - Vitriol&url=https://vitriol95.github.io/posts/mvcproject7/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(7) - Vitriol&u=https://vitriol95.github.io/posts/mvcproject7/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(7) - Vitriol&url=https://vitriol95.github.io/posts/mvcproject7/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/batchbase1/">스프링 배치 - 1 스프링 배치란?</a><li><a href="/posts/batchbase2/">스프링 배치 - 2 DB 스키마에 대한 이해</a><li><a href="/posts/batchbase3/">스프링 배치 - 3 도메인 뜯어보기(JOB)</a><li><a href="/posts/batchbase4/">스프링 배치 - 4 도메인 뜯어보기(STEP)</a><li><a href="/posts/batchbase5/">스프링 배치 - 5 청크 지향 처리</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/mvcproject1/"><div class="card-body"> <span class="timeago small" > Jun 1, 2021 <i class="unloaded">2021-06-01T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(1)</h3><div class="text-muted small"><p> 프로젝트 목표 스프링 부트를 이용하여 간단한 게시판 페이지를 만들어 보려한다. 그리고 이를 AWS의 EC2를 이용하여 직접 라이브 서버에 띄워보는 것을 목표로 한다. 초기 설정 JDK 버전은 11에 해당하며, 스프링 부트의 버전은 2.4.7을 사용했다. 불러온 라이브러리들은 lombok, devtool, web, dataJpa 마지막으로 템플...</p></div></div></a></div><div class="card"> <a href="/posts/mvcporject2/"><div class="card-body"> <span class="timeago small" > Jun 2, 2021 <i class="unloaded">2021-06-02T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(2)</h3><div class="text-muted small"><p> 이전 글 이전글 에서는 Account 클래스를 만들고 이에 Spring Security를 적용하여 로그인과 회원가입을 진행해보았다. 이번시간에는 Account와 관련된 기능들을 좀 더 다듬고, MockMvc를 이용해 테스트를 진행해 보려한다. Account 다듬기 회원가입 - 추가 1 지난 시간, 회원가입에 추가하지 않은 로직이 존재한다. 바로...</p></div></div></a></div><div class="card"> <a href="/posts/mvcproject3/"><div class="card-body"> <span class="timeago small" > Jun 3, 2021 <i class="unloaded">2021-06-03T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(3)</h3><div class="text-muted small"><p> 이전 글 이전글 에서는 Account와 관련된 기능들을 좀 더 다듬고, MockMvc를 이용해 테스트를 진행해 보았다. 이번 시간에는 Account의 정보 수정을 구현하고 Post라는 엔티티를 정의해보려한다. Account 정보 수정 정보변경에 대한 기능은 프론트뷰에선 다음과 같이 위치해 있으며 클릭시 URI는 “/settings”에 해당한다...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/boj1086/" class="btn btn-outline-primary" prompt="Older"><p>백준 1086 박성원 with Python(pypy3)</p></a> <a href="/posts/boj17404/" class="btn btn-outline-primary" prompt="Newer"><p>백준 17404 RGB 거리 2 with Python</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">vitriol</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://vitriol95.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
