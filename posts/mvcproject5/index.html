<!DOCTYPE html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="스프링 mvc 프로젝트 + AWS EC2에 빌드까지(5)" /><meta property="og:locale" content="ko" /><meta name="description" content="이전 글" /><meta property="og:description" content="이전 글" /><link rel="canonical" href="https://vitriol95.github.io/posts/mvcproject5/" /><meta property="og:url" content="https://vitriol95.github.io/posts/mvcproject5/" /><meta property="og:site_name" content="Vitriol" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-05T11:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="스프링 mvc 프로젝트 + AWS EC2에 빌드까지(5)" /><meta name="twitter:site" content="@" /><meta name="google-site-verification" content="QsbP4NOwVkaE8CnHpYOl-qNGhxB9m1RbsrBEefA92ao" /> <script type="application/ld+json"> {"headline":"스프링 mvc 프로젝트 + AWS EC2에 빌드까지(5)","dateModified":"2021-06-05T11:00:00+09:00","datePublished":"2021-06-05T11:00:00+09:00","description":"이전 글","url":"https://vitriol95.github.io/posts/mvcproject5/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://vitriol95.github.io/posts/mvcproject5/"},"@context":"https://schema.org"}</script><title>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(5) | Vitriol</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Vitriol"><meta name="application-name" content="Vitriol"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-WSY4XYN711"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-WSY4XYN711'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Vitriol</a></div><div class="site-subtitle font-italic">기억을 적는 시간</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/vitriol95" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['vitriol951','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(5)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(5)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> vitriol </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Jun 5, 2021, 11:00 AM +0900" prep="on" > Jun 5, 2021 <i class="unloaded">2021-06-05T11:00:00+09:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3238 words">17 min</span></div></div><div class="post-content"><h1 id="이전-글">이전 글</h1><p><a href="https://vitriol95.github.io/posts/mvcproject4/">이전글</a> 에서는 수정사항과 단위테스트, 마지막으로 Reply 엔티티를 정의하고 양방향 매핑까지 완료하였다. 이번시간에는 Reply객체가 들어옴으로써 발생하는 컨트롤러와 뷰단의 변화를 적용하고 Reply의 등록 및 삭제기능을 구현해보자. 등록과정에서는 비동기 테스트를 위해 ajax를 사용해 보겠다.</p><hr /><h1 id="포스트-상세보기-뷰--컨트롤러-수정">포스트 상세보기 뷰 / 컨트롤러 수정</h1><p>포스트 상세보기 뷰에 Reply객체를 적용해야한다. html파일은 다음과 같이 정의된다.</p><div class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
</pre><td class="rouge-code"><pre><span class="c">&lt;!-- 수정된 post/view.html 파일 --&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span> <span class="na">xmlns:sec=</span><span class="s">"http://thymeleaf.org/extras/spring-security"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head</span> <span class="na">th:replace=</span><span class="s">"fragments.html::head"</span><span class="nt">&gt;</span>

<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;nav</span> <span class="na">th:replace=</span><span class="s">"fragments.html :: main-nav"</span><span class="nt">&gt;&lt;/nav&gt;</span>

    <span class="nt">&lt;main</span> <span class="na">role=</span><span class="s">"main"</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"d-flex align-items-center p-3 my-3 bg-purple rounded shadow-sm"</span> <span class="na">style=</span><span class="s">"justify-content: space-between"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"lh-200"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"mb-0 lh-200"</span> <span class="na">th:text=</span><span class="s">"${post.title}"</span><span class="nt">&gt;</span>Bootstrap<span class="nt">&lt;/h3&gt;</span>
                <span class="nt">&lt;small</span> <span class="na">th:text=</span><span class="s">"${#temporals.format(post.modifiedDate,'yyyy-MM-dd HH:mm')}"</span><span class="nt">&gt;</span>localdate<span class="nt">&lt;/small&gt;</span>
            <span class="nt">&lt;/div&gt;</span>

            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"lh-200"</span> <span class="na">th:if=</span><span class="s">"${post.isWriter(#authentication.principal)}"</span><span class="nt">&gt;</span>

                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group mb-0"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{'/posts/'+${post.getId()}+'/update'}"</span><span class="nt">&gt;&lt;button</span> <span class="na">name=</span><span class="s">"update"</span> <span class="na">class=</span><span class="s">"btn btn-outline-primary"</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>수정<span class="nt">&lt;/button&gt;&lt;/a&gt;</span>
                <span class="nt">&lt;/div&gt;</span>

                <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"form-inline"</span> <span class="na">th:if=</span><span class="s">"${post.isWriter(#authentication.principal)}"</span> <span class="na">action=</span><span class="s">"#"</span> <span class="na">th:action=</span><span class="s">"@{'/posts/' + ${post.getId()} + '/delete'}"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">novalidate</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;button</span> <span class="na">name=</span><span class="s">"delete"</span> <span class="na">class=</span><span class="s">"btn btn-outline-danger"</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>삭제<span class="nt">&lt;/button&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;/form&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"d-flex align-items-center p-3 my-3 bg-purple rounded shadow-sm"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"lh-100"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;svg</span> <span class="na">th:if=</span><span class="s">"${#strings.isEmpty(post.account?.profileImage)}"</span> <span class="na">data-jdenticon-value=</span><span class="s">"user111"</span> <span class="na">th:data-jdenticon-value=</span><span class="s">"${post.account.email}"</span>
                     <span class="na">width=</span><span class="s">"32"</span> <span class="na">height=</span><span class="s">"32"</span> <span class="na">class=</span><span class="s">"rounded boarder bg-light"</span><span class="nt">&gt;&lt;/svg&gt;</span>
                <span class="nt">&lt;img</span> <span class="na">th:if=</span><span class="s">"${!#strings.isEmpty(post.account?.profileImage)}"</span> <span class="na">th:src=</span><span class="s">"${post.account.profileImage}"</span>
                     <span class="na">width=</span><span class="s">"32"</span> <span class="na">height=</span><span class="s">"32"</span> <span class="na">class=</span><span class="s">"rounded boarder bg-light"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"lh-100 h6 mb-0"</span> <span class="na">th:text=</span><span class="s">"${post.account.nickname}"</span><span class="nt">&gt;&lt;/span&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"my-3 p-3 bg-white rounded shadow-sm"</span> <span class="na">th:utext=</span><span class="s">"${post.description}"</span><span class="nt">&gt;</span>

        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"comments"</span> <span class="na">th:fragment=</span><span class="s">"comments"</span> <span class="na">class=</span><span class="s">"my-3 p-3 bg-white rounded shadow-sm"</span><span class="nt">&gt;</span>

            <span class="nt">&lt;h6</span> <span class="na">class=</span><span class="s">"border-bottom border-gray pb-2 mb-0"</span><span class="nt">&gt;&lt;strong&gt;</span>코멘트<span class="nt">&lt;/strong&gt;&lt;/h6&gt;</span>

            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"media text-muted pt-3"</span> <span class="na">th:each=</span><span class="s">"reply: ${post.replies}"</span><span class="nt">&gt;</span>

                <span class="nt">&lt;svg</span> <span class="na">class=</span><span class="s">"bd-placeholder-img mr-2 rounded"</span> <span class="na">th:if=</span><span class="s">"${#strings.isEmpty(reply.account?.profileImage)}"</span> <span class="na">data-jdenticon-value=</span><span class="s">"user111"</span> <span class="na">th:data-jdenticon-value=</span><span class="s">"${reply.account.email}"</span>
                     <span class="na">width=</span><span class="s">"32"</span> <span class="na">height=</span><span class="s">"32"</span><span class="nt">&gt;&lt;/svg&gt;</span>
                <span class="nt">&lt;img</span> <span class="na">th:if=</span><span class="s">"${!#strings.isEmpty(reply.account?.profileImage)}"</span> <span class="na">th:src=</span><span class="s">"${reply.account.profileImage}"</span>
                     <span class="na">width=</span><span class="s">"32"</span> <span class="na">height=</span><span class="s">"32"</span> <span class="na">class=</span><span class="s">"bd-placeholder-img mr-2 rounded"</span><span class="nt">&gt;</span>

                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"media-body pb-3 mb-0 small lh-125 border-bottom border-gray"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"d-flex justify-content-between align-items-center w-100"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;strong</span> <span class="na">class=</span><span class="s">"text-gray-dark"</span> <span class="na">th:text=</span><span class="s">"${reply.account.nickname}"</span><span class="nt">&gt;</span>Full Name<span class="nt">&lt;/strong&gt;</span>
                        <span class="nt">&lt;span&gt;</span>
                            <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"form-inline"</span> <span class="na">th:if=</span><span class="s">"${reply.isWriter(#authentication.principal)}"</span> <span class="na">th:action=</span><span class="s">"@{'/posts/' + ${post.getId()} + '/reply/' +${reply.getId()}+'/delete'}"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">novalidate</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;button</span> <span class="na">name=</span><span class="s">"delete"</span> <span class="na">class=</span><span class="s">"btn btn-link btn-sm"</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>삭제<span class="nt">&lt;/button&gt;</span>
                                <span class="nt">&lt;/div&gt;</span>
                            <span class="nt">&lt;/form&gt;</span>
                        <span class="nt">&lt;/span&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">th:text=</span><span class="s">"${#temporals.format(reply.modifiedDate,'yyyy-MM-dd HH:mm')}"</span><span class="nt">&gt;</span>@username<span class="nt">&lt;/span&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mt-1 text-dark"</span>  <span class="na">th:utext=</span><span class="s">"${reply.description}"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>


            <span class="nt">&lt;small</span> <span class="na">class=</span><span class="s">"d-block text-right mt-3"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>All suggestions<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/small&gt;</span>

            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"needs-validation col-sm-10"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"replyDescription"</span><span class="nt">&gt;</span>코멘트 작성<span class="nt">&lt;/label&gt;</span>
                    <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"replyDescription"</span> <span class="na">id=</span><span class="s">"replyDescription"</span> <span class="na">class=</span><span class="s">"editor form-control"</span> <span class="na">placeholder=</span><span class="s">"본문을 작성해주세요"</span>
                              <span class="na">aria-describedby=</span><span class="s">"replyDescriptionHelp"</span> <span class="na">required</span> <span class="na">minlength=</span><span class="s">"2"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
                    <span class="nt">&lt;small</span> <span class="na">id=</span><span class="s">"replyDescriptionHelp"</span> <span class="na">class=</span><span class="s">"form-text text-muted"</span><span class="nt">&gt;</span>
                        매너를 지켜 작성해주세요.
                    <span class="nt">&lt;/small&gt;</span>
                    <span class="nt">&lt;small</span> <span class="na">class=</span><span class="s">"invalid-feedback"</span><span class="nt">&gt;</span>2글자 이상이 와야합니다.<span class="nt">&lt;/small&gt;</span>
                <span class="nt">&lt;/div&gt;</span>

                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"replySave"</span> <span class="na">class=</span><span class="s">"btn btn-primary btn-block"</span> <span class="na">type=</span><span class="s">"button"</span><span class="nt">&gt;</span>코멘트 달기<span class="nt">&lt;/button&gt;</span>
                <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
    <span class="nt">&lt;script </span><span class="na">th:replace=</span><span class="s">"fragments.html :: form-validation"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">th:fragment=</span><span class="s">"summerNote"</span> <span class="na">type=</span><span class="s">"application/javascript"</span><span class="nt">&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">.editor</span><span class="dl">'</span><span class="p">).</span><span class="nx">summernote</span><span class="p">({</span>
                <span class="na">placeholder</span><span class="p">:</span> <span class="dl">'</span><span class="s1">공백만 있는 글은 허용되지 않습니다.</span><span class="dl">'</span><span class="p">,</span>
                <span class="na">tabSize</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="na">height</span><span class="p">:</span> <span class="mi">100</span>
            <span class="p">});</span>
        <span class="p">})</span>
    <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"application/javascript"</span> <span class="na">th:inline=</span><span class="s">"javascript"</span><span class="nt">&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">csrfToken</span> <span class="o">=</span> <span class="cm">/*[[${_csrf.token}]]*/</span> <span class="kc">null</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">csrfHeader</span> <span class="o">=</span> <span class="cm">/*[[${_csrf.headerName}]]*/</span> <span class="kc">null</span><span class="p">;</span>
            <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ajaxSend</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="nx">csrfHeader</span><span class="p">,</span> <span class="nx">csrfToken</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;script&gt;</span>
        <span class="kd">let</span> <span class="nx">index</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">init</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#replySave</span><span class="dl">"</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">replySave</span><span class="p">();</span>
                <span class="p">});</span>
            <span class="p">},</span>
            <span class="na">replySave</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">description</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#replyDescription</span><span class="dl">"</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
                <span class="kd">let</span> <span class="nx">postId</span> <span class="o">=</span> <span class="p">[[</span><span class="nx">$</span><span class="p">{</span><span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="p">}]];</span>
                <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="na">description</span><span class="p">:</span> <span class="nx">description</span><span class="p">};</span>
                <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
                    <span class="na">contentType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json; charset=utf8</span><span class="dl">"</span><span class="p">,</span>
                    <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
                    <span class="na">url</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/posts/</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">String</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/reply</span><span class="dl">"</span><span class="p">,</span>
                    <span class="na">data</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span>
                <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
                <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">alert</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="nx">index</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></table></code></div></div><p>43라인부터 69라인이 현재 포스트에 작성된 댓글들을 보여주는 곳에 해당한다. 또한 76라인부터 90라인까지가 새로운 댓글을 등록하는 창에 해당한다(Summernote를 적용하였다.) 이들의 뷰 로직은 다음과 같다.</p><p><br /></p><ol><li>댓글을 남길경우 뷰단에 댓글을 단 사용자의 프로필 이미지, 닉네임과 본문이 나타나게 된다.<li>댓글 작성자의 경우에만 삭제 버튼에 접근할 수 있다.<blockquote><p>역시 principal을 매개변수로 한 isWriter 메서드가 필요하다</p></blockquote><li>댓글 작성시, description만 property로 가진 newReplyForm에 정보가 담겨 서버쪽으로 넘어오게 된다.<li>댓글 작성 작업은 비동기적으로 이루어지게 되며 (114~138) ajax방식으로 전달 된다. 이때 csrf토큰을 넣어주어야 유효하다(105~113).<blockquote><p>ajax 요청이 성공하면 (success) 여기서는 location.reload()로 페이지를 refresh하고 있다. 사실 이렇게 페이지를 갱신한다면 ajax를 이용하는 장점이 없어진다. 해결법으로는 replaceWith 메서드를 이용해 필요한 화면만 갱신할 수 있다. 하지만 이 프로젝트에서는 비동기 테스트를 위한 용도이므로 넘어가도록 하자.</p></blockquote><li>댓글 삭제의 경우 단순한 post요청으로 넘어가게 된다. (59라인)</ol><p><br /> 이 뷰에 대한 핸들러는 다음과 같이 수정된다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="c1">// PostController.class</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/posts/{id}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">postView</span><span class="o">(</span><span class="nd">@LoggedInUser</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">findPostWithUserAndRepliesById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">post</span><span class="o">.</span><span class="na">isOpen</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
            <span class="k">return</span> <span class="s">"redirect:/"</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"post"</span><span class="o">,</span> <span class="n">post</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="k">new</span> <span class="nc">NewReplyForm</span><span class="o">());</span>
        <span class="k">return</span> <span class="s">"post/view"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/posts/{id}/reply"</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="nc">ResponseEntity</span> <span class="nf">replyFormSubmit</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nd">@LoggedInUser</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> 
                                            <span class="nd">@RequestBody</span> <span class="nc">NewReplyForm</span> <span class="n">newReplyForm</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postService</span><span class="o">.</span><span class="na">getVanillaPost</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">postService</span><span class="o">.</span><span class="na">createNewReply</span><span class="o">(</span><span class="n">modelMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">newReplyForm</span><span class="o">,</span> <span class="nc">Reply</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">post</span><span class="o">,</span> <span class="n">account</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">ok</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/posts/{postId}/reply/{replyId}/delete"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">deleteReplySubmit</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"postId"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nd">@LoggedInUser</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> 
                                        <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"replyId"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">replyId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postService</span><span class="o">.</span><span class="na">getVanillaPost</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="nc">Reply</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">replyRepository</span><span class="o">.</span><span class="na">findReplyById</span><span class="o">(</span><span class="n">replyId</span><span class="o">);</span>
        <span class="n">postService</span><span class="o">.</span><span class="na">deleteReply</span><span class="o">(</span><span class="n">reply</span><span class="o">,</span> <span class="n">post</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"redirect:/posts/"</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>변화된 상황을 하나씩 살펴보자.</p><hr /><h2 id="포스트-상세보기postsid-컨트롤러">포스트 상세보기(/posts/{id}) 컨트롤러</h2><p>앞선 뷰를 보여주는 핸들러에 해당한다. 위에서 보았듯이, Post객체를 하나 가져와서 연결된 Account와 Reply들을 모두 긁어오고 있다. 이는 <code class="language-plaintext highlighter-rouge">Post post = postRepository.findPostWithUserAndRepliesById(id)</code> 라는 메서드를 통해 긁어온다. 이는 다음과 같이 구현되어있다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PostRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@EntityGraph</span><span class="o">(</span><span class="n">attributePaths</span> <span class="o">=</span> <span class="o">{</span><span class="s">"description"</span><span class="o">,</span><span class="s">"account"</span><span class="o">,</span><span class="s">"replies"</span><span class="o">},</span> <span class="n">type</span> <span class="o">=</span> <span class="nc">EntityGraph</span><span class="o">.</span><span class="na">EntityGraphType</span><span class="o">.</span><span class="na">LOAD</span><span class="o">)</span>
    <span class="nc">Post</span> <span class="nf">findPostWithUserAndRepliesById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>

    <span class="cm">/**
    이전 코드들
    */</span>

<span class="o">}</span>

</pre></table></code></div></div><p>위의 @EntityGraph를 이용하여 Lazy로 설정된 attribute들을 모두 긁어오고 있다. 이렇게 되면 뷰에 본문과, 글쓴이에 대한 정보, 댓글들을 모두 가져올 수 있다.</p><p><br /> 🤔 하지만 한가지 의문점이 든다. 뷰를 다시보면, 우리는 Reply들의 Account도 필요하다. 즉, 댓글이 보여질 때 댓글쓴이의 프로필과 닉네임이 함께 보여져야 하므로 이것까지 긁어와야 한다는 것이다. 그림으로 나타내면 다음과 같다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/16.JPG" /></p><p>Post 엔티티의 본문, Reply, Account(글쓴이)는 @EntityGraph를 통해 한꺼번에 가져와지는 반면 Reply엔티티와 연결된 Account(댓글쓴이)는 LAZY에 해당하므로 프록시 객체가 자리할 것이다. 따라서 뷰단으로 <code class="language-plaintext highlighter-rouge">reply.account.profileImage</code>와 같은 프로퍼티를 소환할 경우 에러를 뱉어낼 것이다.</p><p><br /> 이를 해결하는 방법에는 2가지가 존재한다.</p><ol><li>Reply Entity의 Account 프로퍼티 FetchType을 EAGER로 바꾼다.<li>네이티브 쿼리나 QueryDSL을 이용하여 새로운 쿼리를 정의한다.</ol><p>필자는 2번방법을 시도하던 중, 잠시 생각이 떠올랐다. ‘Account(댓글쓴이)가 없는 상태로 Reply가 보여질 일이 있는가?’ 답은 No였다. 따라서 1번 방식으로 우회하여 진행하였다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"reply"</span><span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Reply</span> <span class="kd">extends</span> <span class="nc">LocalDateTimeEntity</span> <span class="o">{</span>

    <span class="cm">/**
    이전 코드들
    */</span>
    <span class="nd">@ManyToOne</span>
    <span class="kd">private</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">;</span>

    <span class="cm">/**
    이전 코드들
    */</span>
<span class="o">}</span>
</pre></table></code></div></div><p>다음과 같이 진행하면 앞선 <code class="language-plaintext highlighter-rouge">findPostWithUserAndRepliesById</code>메서드를 사용하더라도 Reply의 Account까지 모두 가져오게 된다.</p><hr /><h2 id="댓글-등록-postsidreply-컨트롤러">댓글 등록 (/posts/{id}/reply) 컨트롤러</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">// PostController.java</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/posts/{id}/reply"</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="nc">ResponseEntity</span> <span class="nf">replyFormSubmit</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nd">@LoggedInUser</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="nd">@RequestBody</span> <span class="nc">NewReplyForm</span> <span class="n">newReplyForm</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postService</span><span class="o">.</span><span class="na">getVanillaPost</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">postService</span><span class="o">.</span><span class="na">createNewReply</span><span class="o">(</span><span class="n">modelMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">newReplyForm</span><span class="o">,</span> <span class="nc">Reply</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">post</span><span class="o">,</span> <span class="n">account</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">ok</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>Ajax 방식으로 요청을 받아 비동기적으로 진행이 되었기에 @ResponseBody를 이용해 ResponseEntity 객체를 내려주었다. 일종의 api 핸들러역할을 한다고 생각하면 된다.</p><p><br /> 이 핸들러는 뷰단에서 비동기적으로 Post요청으로 넘어온 newReplyForm을 받아 Reply객체로 매핑을 진행하고 이를 생성한다. 이때, Reply 엔티티는 Post와 Account객체가 매핑되어야 한다.</p><p><br /> post의 경우 <code class="language-plaintext highlighter-rouge">getVanillaPost</code>라는 메서드를 통해 가져오고 있다. 이번 Post를 가져올때 우리는 연결된 Account나 description과 같은 Lazy프로퍼티들을 가져올 필요가 없다. 그냥 reply를 넣어주기만 하면 되기 때문이다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c1">// PostService.java</span>
<span class="kd">public</span> <span class="nc">Post</span> <span class="nf">getVanillaPost</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">findPostById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// PostRepository.java</span>
<span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PostRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="cm">/**
    이전 코드들
    */</span>

    <span class="nc">Post</span> <span class="nf">findPostById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>
    <span class="c1">// 어떠한 연결객체도 깨우지 않은 상태로 가져온다.</span>
    
    <span class="cm">/**
    이전 코드들
    */</span>
<span class="o">}</span>
</pre></table></code></div></div><p>다음으로는 postService의 <code class="language-plaintext highlighter-rouge">createNewReply</code>메서드를 보자. 파라미터로는 Reply와 Post, Account를 받고있다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1">// PostService.java</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">createNewReply</span><span class="o">(</span><span class="nc">Reply</span> <span class="n">reply</span><span class="o">,</span> <span class="nc">Post</span> <span class="n">post</span><span class="o">,</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Account</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getEmail</span><span class="o">());</span>
    <span class="c1">// detached 살려오기</span>

    <span class="n">reply</span><span class="o">.</span><span class="na">setAccount</span><span class="o">(</span><span class="n">writer</span><span class="o">);</span>
    <span class="n">post</span><span class="o">.</span><span class="na">addReply</span><span class="o">(</span><span class="n">reply</span><span class="o">);</span>
    <span class="n">writer</span><span class="o">.</span><span class="na">replyAdd</span><span class="o">();</span>
    <span class="n">replyRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">reply</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>우리는 파라미터로 @LoggedInUser 어노테이션이 적용된 Principal객체내의 Account를 받았다. 이 객체는 Detached 상태에 해당하므로 이를 다시 Managed상태로 올려주어야 한다(4 라인). 이 Reply에 대한 작성자와 post 정보를 채워주고 저장하면 된다.</p><blockquote><p>여기에 writer.replyAdd()나, post.addReply(reply) 같은 메서드가 존재하는데 나중에 회원 정보를 보여줄 때 댓글수와 게시글 수를 보여주기 위해 새로운 post/replyCount 프로퍼티를 만들어 두었다. 후자의 경우는 양방향 매핑을 하며 Post 내부 프로퍼티인 replyCount를 1 더해준다.</p></blockquote><hr /><h2 id="댓글-삭제-postspostidreplyreplyiddelete-컨트롤러">댓글 삭제 (/posts/{postId}/reply/{replyId}/delete) 컨트롤러</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">// PostController.java</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/posts/{postId}/reply/{replyId}/delete"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">deleteReplySubmit</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"postId"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nd">@LoggedInUser</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"replyId"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">replyId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postService</span><span class="o">.</span><span class="na">getVanillaPost</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="nc">Reply</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">replyRepository</span><span class="o">.</span><span class="na">findReplyById</span><span class="o">(</span><span class="n">replyId</span><span class="o">);</span>
        <span class="n">postService</span><span class="o">.</span><span class="na">deleteReply</span><span class="o">(</span><span class="n">reply</span><span class="o">,</span> <span class="n">post</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"redirect:/posts/"</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>역시 <code class="language-plaintext highlighter-rouge">getVanillaPost</code>메서드를 이용하여 게시글을 가져왔으며 reply객체와 함께 <code class="language-plaintext highlighter-rouge">postService.deleteReply</code>의 파라미터로 넘겨주었다. 이 메서드를 살펴보자.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteReply</span><span class="o">(</span><span class="nc">Reply</span> <span class="n">reply</span><span class="o">,</span> <span class="nc">Post</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">post</span><span class="o">.</span><span class="na">removeReply</span><span class="o">();</span>
    <span class="n">reply</span><span class="o">.</span><span class="na">removeTrace</span><span class="o">();</span>
    <span class="n">replyRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">reply</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>post 객체로 들어가 양방향 매핑을 제거하고 removeTrace()메서드를 이용하여 Account와 post객체의 replyCount를 1씩 내려주었다.</p><p><br /></p><p>이들이 제대로 동작하는지 한번 살펴보도록 하자.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/17.JPG" /></p><p>초기의 화면에 해당하고, 댓글을 등록하면 다음과 같이 나타난다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/18.JPG" /></p><p>댓글의 글쓴이면서, 게시글의 글쓴이에 해당하므로 수정과 삭제 버튼이 모두 열려있다. 다른 유저로 들어가 댓글을 남겨보자.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/19.JPG" /></p><p>자신이 쓴 댓글에만 삭제 버튼이 열려있는 것을 확인해 볼 수 있었다.</p><hr /><h1 id="버그-수정---post-엔티티와-reply-엔티티의-영속성-전이">버그 수정 - Post 엔티티와 Reply 엔티티의 영속성 전이</h1><p>필드 테스트중 한가지 오류가 발생하여 수정하려고 한다. (아.. 이걸 왜 생각 안하고 있었지 ㅠㅠ) 게시글에 댓글이 달려있을 경우에 글을 삭제하면 다음과 같은 오류가 발생한다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/20.JPG" /></p><p>현재 Post - Reply 관계에서 외래키를 가지고있는 쪽은 Reply에 해당한다. 동시에 연관관계의 주인에 해당한다. 이 때 Post엔티티를 삭제할 경우 RDBMS의 ‘참조 무결성 원칙’이 깨지게 되어 이러한 오류가 발생하는 것이다.</p><p><br /> 이 경우에는, 부모 릴레이션(제공하는 쪽)이 Post엔티티에 해당하며 자식 릴레이션(제공 받는 쪽)이 Reply엔티티에 해당하므로 부모 릴레이션 삭제시에 제약사항이 걸리는 것이다. 따라서 다음과 같은 옵션을 추가해주면 된다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"post"</span><span class="o">)</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Post</span> <span class="kd">extends</span> <span class="nc">LocalDateTimeEntity</span> <span class="o">{</span>

    <span class="cm">/**
    이전 코드들
    */</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"post"</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="nc">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">replies</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="cm">/**
    이전 코드들
    */</span>
<span class="o">}</span>
</pre></table></code></div></div><p>참조 무결성 제약조건 옵션중 cascade를 이용하며 Reply는 Post와 생명주기를 같이하도록 한다. 그리고 <code class="language-plaintext highlighter-rouge">orphanRemoval = true</code> 옵션을 주어 참조가 끊어진 Reply들은 자동삭제되게끔 한다(GC 대상)</p><blockquote><p>사실 여기서 orphanRemoval 옵션은 안주어도 크게 상관이 없다.</p></blockquote><p>이제 게시글 상세보기 구현 및 Reply에 대한 기능은 모두 구현하였다. 다음에는 게시글을 검색하는 서비스를 만들고, 가입된 유저 목록을 보여주는 기능을 만들어보자.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/spring/'>Spring</a>, <a href='/categories/spring-project/'>spring_project</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring/" class="post-tag no-text-decoration" >spring</a> <a href="/tags/spring-mvc/" class="post-tag no-text-decoration" >spring mvc</a> <a href="/tags/springboot/" class="post-tag no-text-decoration" >springboot</a> <a href="/tags/springframework/" class="post-tag no-text-decoration" >springframework</a> <a href="/tags/java/" class="post-tag no-text-decoration" >java</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(5) - Vitriol&url=https://vitriol95.github.io/posts/mvcproject5/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(5) - Vitriol&u=https://vitriol95.github.io/posts/mvcproject5/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(5) - Vitriol&url=https://vitriol95.github.io/posts/mvcproject5/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/batchbase1/">스프링 배치 - 1 스프링 배치란?</a><li><a href="/posts/batchbase2/">스프링 배치 - 2 DB 스키마에 대한 이해</a><li><a href="/posts/batchbase3/">스프링 배치 - 3 도메인 뜯어보기(JOB)</a><li><a href="/posts/batchbase4/">스프링 배치 - 4 도메인 뜯어보기(STEP)</a><li><a href="/posts/batchbase5/">스프링 배치 - 5 청크 지향 처리</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/mvcproject1/"><div class="card-body"> <span class="timeago small" > Jun 1, 2021 <i class="unloaded">2021-06-01T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(1)</h3><div class="text-muted small"><p> 프로젝트 목표 스프링 부트를 이용하여 간단한 게시판 페이지를 만들어 보려한다. 그리고 이를 AWS의 EC2를 이용하여 직접 라이브 서버에 띄워보는 것을 목표로 한다. 초기 설정 JDK 버전은 11에 해당하며, 스프링 부트의 버전은 2.4.7을 사용했다. 불러온 라이브러리들은 lombok, devtool, web, dataJpa 마지막으로 템플...</p></div></div></a></div><div class="card"> <a href="/posts/mvcporject2/"><div class="card-body"> <span class="timeago small" > Jun 2, 2021 <i class="unloaded">2021-06-02T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(2)</h3><div class="text-muted small"><p> 이전 글 이전글 에서는 Account 클래스를 만들고 이에 Spring Security를 적용하여 로그인과 회원가입을 진행해보았다. 이번시간에는 Account와 관련된 기능들을 좀 더 다듬고, MockMvc를 이용해 테스트를 진행해 보려한다. Account 다듬기 회원가입 - 추가 1 지난 시간, 회원가입에 추가하지 않은 로직이 존재한다. 바로...</p></div></div></a></div><div class="card"> <a href="/posts/mvcproject3/"><div class="card-body"> <span class="timeago small" > Jun 3, 2021 <i class="unloaded">2021-06-03T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(3)</h3><div class="text-muted small"><p> 이전 글 이전글 에서는 Account와 관련된 기능들을 좀 더 다듬고, MockMvc를 이용해 테스트를 진행해 보았다. 이번 시간에는 Account의 정보 수정을 구현하고 Post라는 엔티티를 정의해보려한다. Account 정보 수정 정보변경에 대한 기능은 프론트뷰에선 다음과 같이 위치해 있으며 클릭시 URI는 “/settings”에 해당한다...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/boj2042/" class="btn btn-outline-primary" prompt="Older"><p>백준 2042 구간 합 구하기 with Python</p></a> <a href="/posts/boj15686/" class="btn btn-outline-primary" prompt="Newer"><p>백준 15686 치킨 배달 with Python</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">vitriol</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://vitriol95.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
