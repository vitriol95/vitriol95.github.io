<!DOCTYPE html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="JPA와 낙관적 락" /><meta property="og:locale" content="ko" /><meta name="description" content="JPA의 낙관적 락" /><meta property="og:description" content="JPA의 낙관적 락" /><link rel="canonical" href="https://vitriol95.github.io/posts/optimistic/" /><meta property="og:url" content="https://vitriol95.github.io/posts/optimistic/" /><meta property="og:site_name" content="Vitriol" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-09-30T14:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="JPA와 낙관적 락" /><meta name="twitter:site" content="@" /><meta name="google-site-verification" content="QsbP4NOwVkaE8CnHpYOl-qNGhxB9m1RbsrBEefA92ao" /> <script type="application/ld+json"> {"headline":"JPA와 낙관적 락","dateModified":"2021-10-14T14:47:14+09:00","datePublished":"2021-09-30T14:00:00+09:00","description":"JPA의 낙관적 락","url":"https://vitriol95.github.io/posts/optimistic/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://vitriol95.github.io/posts/optimistic/"},"@context":"https://schema.org"}</script><title>JPA와 낙관적 락 | Vitriol</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Vitriol"><meta name="application-name" content="Vitriol"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-WSY4XYN711"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-WSY4XYN711'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Vitriol</a></div><div class="site-subtitle font-italic">기억을 적는 시간</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/vitriol95" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['vitriol951','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>JPA와 낙관적 락</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>JPA와 낙관적 락</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> vitriol </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Sep 30, 2021, 2:00 PM +0900" prep="on" > Sep 30, 2021 <i class="unloaded">2021-09-30T14:00:00+09:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Oct 14, 2021, 2:47 PM +0900" prefix="Updated " > Oct 14, 2021 <i class="unloaded">2021-10-14T14:47:14+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3266 words">18 min</span></div></div><div class="post-content"><h1 id="jpa의-낙관적-락">JPA의 낙관적 락</h1><h2 id="개념">개념</h2><p>낙관적 락에 대한 설명은 <a href="https://vitriol95.github.io/posts/mysql4/">이글</a>에 정리를 해 두었다.!</p><p><br /></p><p>동시성제어를 위해 JPA에서는 낙관적 락을 지원하게 된다. 앞선 글에서와 마찬가지로 version 칼럼을 추가하여 Entity의 변경을 추적하는 메커니즘에 해당한다.</p><h2 id="적용--1-version">적용 -1 Version</h2><p>JPA에서 낙관적 락을 사용하기 위해서는 <code class="language-plaintext highlighter-rouge">@Entity</code>내부에 <code class="language-plaintext highlighter-rouge">@Version</code> 어노테이션이 붙은 변수를 구현해 줌으로써 가능하다. 이때 다음과 같은 주의사항이 존재한다.</p><ul><li>각 엔티티 클래스에는 <code class="language-plaintext highlighter-rouge">@Version</code>속성이 하나만 있어야 한다.<li>여러 테이블에 매핑된 엔티티의 경우, 기본 테이블에 존재해야한다.<li>타입은 int, Integer, long, Long, short, Short가 되며, Timestamp도 가능하다.<blockquote><p>코틀린의 경우 맘편하게 int로 설정하면 될것이다.</p></blockquote></ul><p>JPA는 select가 일어날 때, 버전 속성값을 가지고 있다가 트랜잭션이 업데이트를 치기 전에 버전 속성을 다시 확인한다. 이 과정에서 버전 정보가 변경된다면 <code class="language-plaintext highlighter-rouge">OptimisticLockException</code>이 발생하게 된다.</p><h2 id="적용---2-versionless">적용 - 2 Versionless</h2><p>별도의 <code class="language-plaintext highlighter-rouge">@Version</code> 없이 적용하는 것도 가능한데, 엔티티 클래스 상단에 <code class="language-plaintext highlighter-rouge">@OptimisticLocking</code>을 적용하는 방식이다. 이 어노테이션에 적용할 수 있는 4가지 모드가 있는데, 이들은 다음과 같다.</p><ul><li>NONE: 사용하지 않는것과 같다.<li>VERSION: 적용 1의 방식을 따라간다. 별도의 version column이 필요하다.<li>ALL: 모든 칼럼을 이용해 version 체크를 진행한다. update와 delete의 경우 where절 안에 모든 칼럼을 넣어 검색을 진행한다.<li>DIRTY: dirty attribute(바뀐 attribute)만을 이용해 검색한다. 역시 WHERE절에 바뀐 칼럼들을 검색어로 넣어 체크한다.</ul><p>예시로 보면 다음과 같은 엔티티가 나올 수 있다. (자바)</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Person"</span><span class="o">)</span>
<span class="nd">@OptimisticLocking</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">OptimisticLockType</span><span class="o">.</span><span class="na">ALL</span><span class="o">)</span>
<span class="nd">@DynamicUpdate</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>

 <span class="nd">@Id</span>
 <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

 <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"`name`"</span><span class="o">)</span>
 <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

 <span class="kd">private</span> <span class="nc">String</span> <span class="n">country</span><span class="o">;</span>

 <span class="kd">private</span> <span class="nc">String</span> <span class="n">city</span><span class="o">;</span>

 <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"created_on"</span><span class="o">)</span>
 <span class="kd">private</span> <span class="nc">Timestamp</span> <span class="n">createdOn</span><span class="o">;</span>

 <span class="c1">//Getters and setters are omitted for brevity</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="실습해보기---준비">실습해보기 - 준비</h2><p>코틀린 1.5.31, Jdk 11버전으로 진행할 생각이다. 의존성은 data jpa, h2인메모리 db를 사용하며 테스트코드는 junit5를 이용해 작성하겠다.</p><blockquote><p>그리고 <code class="language-plaintext highlighter-rouge">@Version</code>을 적용한 버전 필드가 있는 엔티티를 사용할 생각이다. (적용1)</p></blockquote><h3 id="configuration--entity">Configuration &amp; Entity</h3><div class="language-groovy highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="n">plugins</span> <span class="o">{</span>
    <span class="c1">// ...</span>
    <span class="n">kotlin</span><span class="o">(</span><span class="s2">"plugin.spring"</span><span class="o">)</span> <span class="n">version</span> <span class="s2">"1.5.31"</span>
    <span class="n">kotlin</span><span class="o">(</span><span class="s2">"plugin.jpa"</span><span class="o">)</span> <span class="n">version</span> <span class="s2">"1.5.31"</span>
<span class="o">}</span>

<span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">implementation</span><span class="o">(</span><span class="s2">"org.springframework.boot:spring-boot-starter-data-jpa"</span><span class="o">)</span>
    <span class="n">implementation</span><span class="o">(</span><span class="s2">"org.springframework.boot:spring-boot-starter-web"</span><span class="o">)</span>
    <span class="n">implementation</span><span class="o">(</span><span class="s2">"com.fasterxml.jackson.module:jackson-module-kotlin"</span><span class="o">)</span>
    <span class="n">implementation</span><span class="o">(</span><span class="s2">"org.jetbrains.kotlin:kotlin-reflect"</span><span class="o">)</span>
    <span class="n">implementation</span><span class="o">(</span><span class="s2">"org.jetbrains.kotlin:kotlin-stdlib-jdk8"</span><span class="o">)</span>
    <span class="n">runtimeOnly</span><span class="o">(</span><span class="s2">"com.h2database:h2"</span><span class="o">)</span>
    <span class="n">testImplementation</span><span class="o">(</span><span class="s2">"org.springframework.boot:spring-boot-starter-test"</span><span class="o">)</span>
<span class="o">}</span>
<span class="c1">// ...</span>
</pre></table></code></div></div><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="nd">@DynamicUpdate</span>
<span class="kd">class</span> <span class="nc">TestEntity</span> <span class="p">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="p">(</span><span class="n">strategy</span> <span class="p">=</span> <span class="nc">GenerationType</span><span class="p">.</span><span class="nc">AUTO</span><span class="p">)</span>
    <span class="kd">var</span> <span class="py">id</span><span class="p">:</span> <span class="nc">Long</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="kd">var</span> <span class="py">count</span><span class="p">:</span> <span class="nc">Long</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="kd">var</span> <span class="py">isActive</span><span class="p">:</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="k">false</span>

    <span class="nd">@Version</span>
    <span class="kd">var</span> <span class="py">version</span><span class="p">:</span> <span class="nc">Long</span> <span class="p">=</span> <span class="mi">1</span>

    <span class="k">fun</span> <span class="nf">updateActive</span><span class="p">(){</span>
        <span class="k">this</span><span class="p">.</span><span class="n">isActive</span> <span class="p">=</span> <span class="p">!</span><span class="k">this</span><span class="p">.</span><span class="n">isActive</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">countUp</span><span class="p">(){</span>
        <span class="k">this</span><span class="p">.</span><span class="n">count</span><span class="p">++</span>
    <span class="p">}</span>

    <span class="c1">// equals and hashcode...</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>여기서 중요한게, 버전에 대한 정보는 꼭 저렇게 Initializing 해주어야 한다.</p></blockquote><h3 id="service">Service</h3><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">class</span> <span class="nc">TestService</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">repository</span><span class="p">:</span> <span class="nc">TestEntityRepository</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">log</span> <span class="p">=</span> <span class="nc">LoggerFactory</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="n">javaClass</span><span class="p">)</span>

    <span class="k">fun</span> <span class="nf">save</span><span class="p">(){</span>
        <span class="n">repository</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="nc">TestEntity</span><span class="p">())</span>
        <span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"=== 저장 완료 ==="</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">updateActive</span><span class="p">(){</span>
        <span class="kd">val</span> <span class="py">entity</span> <span class="p">=</span> <span class="n">repository</span><span class="p">.</span><span class="nf">findEntityById</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">entity</span><span class="p">.</span><span class="nf">updateActive</span><span class="p">()</span>
        <span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"=== 업데이트 완료 ==="</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">countUp</span><span class="p">(){</span>
        <span class="kd">val</span> <span class="py">entity</span> <span class="p">=</span> <span class="n">repository</span><span class="p">.</span><span class="nf">findEntityById</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">entity</span><span class="p">.</span><span class="nf">countUp</span><span class="p">()</span>
        <span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"=== 카운트 업 완료 ==="</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li><code class="language-plaintext highlighter-rouge">updateActive()</code>는 isActive 칼럼을 뒤집는 요청에 해당하며<li><code class="language-plaintext highlighter-rouge">countUp()</code>은 count칼럼을 1증가 시키는 요청에 해당한다.</ol><h3 id="repository">Repository</h3><p>위에서 작성한 <code class="language-plaintext highlighter-rouge">findEntityById</code>는 다음과 같이 구현하였다.</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">interface</span> <span class="nc">TestEntityRepository</span> <span class="p">:</span> <span class="nc">JpaRepository</span><span class="p">&lt;</span><span class="nc">TestEntity</span><span class="p">,</span> <span class="nc">Long</span><span class="p">&gt;</span> <span class="p">{</span>

    <span class="nd">@Lock</span><span class="p">(</span><span class="nc">LockModeType</span><span class="p">.</span><span class="nc">OPTIMISTIC</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">findEntityById</span><span class="p">(</span><span class="n">id</span><span class="p">:</span><span class="nc">Long</span><span class="p">):</span> <span class="nc">TestEntity</span>
<span class="p">}</span>
</pre></table></code></div></div><p>실제로, JPA에서 제공하는 낙관적 Lock은 다음과 같은 4가지가 존재한다.</p><ul><li>OPTIMISTIC<li>OPTIMISTIC_FORCE_INCREMENT<li>READ (OPTIMISTIC과 동일)<li>WRITE (OPTIMISTIC_FORCE_INCREMENT와 동일)</ul><p>확인하였다 싶이, 가장 첫번째 부터 적용해가며 사용할 것이다.</p><h2 id="실습해보기---확인">실습해보기 - 확인</h2><h3 id="locktype---optimistic">LOCKTYPE - OPTIMISTIC</h3><p>테스트 코드를 이용해 <code class="language-plaintext highlighter-rouge">update()</code>로직을 진행했을때는 다음과 같은 쿼리가 나갔다.</p><blockquote><p><code class="language-plaintext highlighter-rouge">@DynamicUpdate</code>를 붙혀두었다.</p></blockquote><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="nd">@SpringBootTest</span>
<span class="nd">@TestInstance</span><span class="p">(</span><span class="nc">TestInstance</span><span class="p">.</span><span class="nc">Lifecycle</span><span class="p">.</span><span class="nc">PER_CLASS</span><span class="p">)</span>
<span class="k">internal</span> <span class="kd">class</span> <span class="nc">TestServiceTest</span><span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">service</span><span class="p">:</span><span class="nc">TestService</span>

    <span class="nd">@BeforeAll</span>
    <span class="k">fun</span> <span class="nf">beforeAll</span><span class="p">(){</span>
        <span class="n">service</span><span class="p">.</span><span class="nf">save</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="nd">@DisplayName</span><span class="p">(</span><span class="s">"setActive Test"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">activeTest</span><span class="p">(){</span>
        <span class="n">service</span><span class="p">.</span><span class="nf">updateActive</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="k">select</span>
    <span class="n">testentity0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_0_</span><span class="p">,</span>
    <span class="n">testentity0_</span><span class="p">.</span><span class="k">count</span> <span class="k">as</span> <span class="n">count2_0_</span><span class="p">,</span>
    <span class="n">testentity0_</span><span class="p">.</span><span class="n">is_active</span> <span class="k">as</span> <span class="n">is_activ3_0_</span><span class="p">,</span>
    <span class="n">testentity0_</span><span class="p">.</span><span class="k">version</span> <span class="k">as</span> <span class="n">version4_0_</span> 
<span class="k">from</span>
    <span class="n">test_entity</span> <span class="n">testentity0_</span> 
<span class="k">where</span>
    <span class="n">testentity0_</span><span class="p">.</span><span class="n">id</span><span class="o">=?</span>
<span class="c1">---</span>
<span class="k">update</span>
    <span class="n">test_entity</span> 
<span class="k">set</span>
    <span class="n">is_active</span><span class="o">=?</span><span class="p">,</span>
    <span class="k">version</span><span class="o">=?</span> <span class="c1">--- (1)</span>
<span class="k">where</span>
    <span class="n">id</span><span class="o">=?</span> 
    <span class="k">and</span> <span class="k">version</span><span class="o">=?</span> <span class="c1">--- (1)</span>
<span class="c1">---</span>
<span class="k">select</span> <span class="c1">--- (2)</span>
    <span class="k">version</span> <span class="k">as</span> <span class="n">version_</span> 
<span class="k">from</span>
    <span class="n">test_entity</span> 
<span class="k">where</span>
    <span class="n">id</span> <span class="o">=</span> <span class="o">?</span>
</pre></table></code></div></div><p>2가지 재밌는 사항이 존재한다.</p><ol><li>서비스코드에는 version을 건드리는 것이 없었지만 이 값이 실제로 업데이트 되고 있다. (결과적으로 version이 1증가한다.)<li>그리고 version에 대한 select문이 한번 더 나간다.</ol><p><code class="language-plaintext highlighter-rouge">2번 쿼리는 왜 나가는 걸까?</code> 를 생각해보면 단순하다. 만약 이 값이 초반과 달라졌다고 하면 <code class="language-plaintext highlighter-rouge">OptimisticLockingFailureException</code>이 발생한다.</p><blockquote><p>이제 어느정도 감이 잡히기 시작했다.! 트랜잭션의 처음과 끝에 버전을 2번 감시하는 것이다.</p></blockquote><h3 id="locktype---optimistic_force_increment">LOCKTYPE - OPTIMISTIC_FORCE_INCREMENT</h3><p>리포지토리의 LOCKTYPE만 변경하여 다시 해당 메서드를 호출해보면 다음과 같다.</p><div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="k">select</span>
    <span class="n">testentity0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_0_</span><span class="p">,</span>
    <span class="n">testentity0_</span><span class="p">.</span><span class="k">count</span> <span class="k">as</span> <span class="n">count2_0_</span><span class="p">,</span>
    <span class="n">testentity0_</span><span class="p">.</span><span class="n">is_active</span> <span class="k">as</span> <span class="n">is_activ3_0_</span><span class="p">,</span>
    <span class="n">testentity0_</span><span class="p">.</span><span class="k">version</span> <span class="k">as</span> <span class="n">version4_0_</span> 
<span class="k">from</span>
    <span class="n">test_entity</span> <span class="n">testentity0_</span> 
<span class="k">where</span>
    <span class="n">testentity0_</span><span class="p">.</span><span class="n">id</span><span class="o">=?</span>
<span class="c1">---</span>
<span class="k">update</span> <span class="c1">--- (1)</span>
    <span class="n">test_entity</span> 
<span class="k">set</span>
    <span class="n">is_active</span><span class="o">=?</span><span class="p">,</span>
    <span class="k">version</span><span class="o">=?</span> 
<span class="k">where</span>
    <span class="n">id</span><span class="o">=?</span> 
    <span class="k">and</span> <span class="k">version</span><span class="o">=?</span>
<span class="c1">---</span>
<span class="k">update</span> <span class="c1">--- (2)</span>
    <span class="n">test_entity</span> 
<span class="k">set</span>
    <span class="k">version</span><span class="o">=?</span> 
<span class="k">where</span>
    <span class="n">id</span><span class="o">=?</span> 
    <span class="k">and</span> <span class="k">version</span><span class="o">=?</span>
</pre></table></code></div></div><p>달라진 차이점을 보자면 update문이 두번 나간것이다. 결론적으로 이야기하면 version이 1이 아닌 2가 올라가게 된다.</p><p><br /></p><p>그냥 <code class="language-plaintext highlighter-rouge">@Lock(LockModeType.OPTIMISTIC)</code> 의 경우 version이 1-&gt;2로 증가한 반면, <code class="language-plaintext highlighter-rouge">@Lock(LockModeType.OPTIMISTIC_FORCE_INCREMENT)</code>의 경우는 version이 1-&gt;3으로 증가했다.</p><hr /><h3 id="2개-트랜잭션을-열어-실습하기">2개 트랜잭션을 열어 실습하기</h3><h4 id="위에서-두가지-방식의-공통-차이점">위에서 두가지 방식의 공통, 차이점?</h4><p><strong>가장 큰 차이로는</strong> 후자의 방식을 보자면 전자의 마지막 쿼리 <code class="language-plaintext highlighter-rouge">select version as version_</code> 과 같은 버전확인을 트랜잭션 종료시에 진행하지 않고 version에 대한 업데이트 쿼리만 두번 나가고 있다.</p><p><br /></p><p>또한 버전 관리 방식이 다르다. 아래와 같은 테스트 코드가 있다고 하자.</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>
<span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">test_success</span><span class="p">(){</span>
    <span class="kd">val</span> <span class="py">em1</span> <span class="p">=</span> <span class="n">emf</span><span class="p">.</span><span class="nf">createEntityManager</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">tx1</span> <span class="p">=</span> <span class="n">em1</span><span class="p">.</span><span class="n">transaction</span>
    <span class="n">tx1</span><span class="p">.</span><span class="nf">begin</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">entity1</span> <span class="p">=</span> <span class="n">em1</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="nc">TestEntity</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="mi">1L</span><span class="p">,</span> <span class="nc">LockModeType</span><span class="p">.</span><span class="nc">NONE</span><span class="p">)</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"=== 초기버전: ${entity1.version}"</span><span class="p">)</span>
    <span class="n">tx1</span><span class="p">.</span><span class="nf">commit</span><span class="p">()</span>
    
    <span class="kd">val</span> <span class="py">one</span> <span class="p">=</span> <span class="n">service</span><span class="p">.</span><span class="nf">getIdOne</span><span class="p">()</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"=== 이후버전: ${one.version}"</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>엔티티를 가져오는 과정만 있을 뿐, 아무런 업데이트 사항이 없다. 전자와 후자를 사용할때 버전은 어떻게 달라질까?</p><ul><li><code class="language-plaintext highlighter-rouge">LockTypeMode.OPTIMISTIC</code></ul><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        testentity0_.id as id1_0_0_,
        testentity0_.count as count2_0_0_,
        testentity0_.is_active as is_activ3_0_0_,
        testentity0_.version as version4_0_0_ 
    from
        test_entity testentity0_ 
    where
        testentity0_.id=?
=== 초기버전: 1
Hibernate: 
    select
        testentity0_.id as id1_0_,
        testentity0_.count as count2_0_,
        testentity0_.is_active as is_activ3_0_,
        testentity0_.version as version4_0_ 
    from
        test_entity testentity0_ 
    where
        testentity0_.id=?
Hibernate: 
    select
        version as version_ 
    from
        test_entity 
    where
        id =?
=== 이후버전: 1
</pre></table></code></div></div><p>당연히 아무런 변화도 주지 않았으므로 버전에 변화가 없다.</p><ul><li><code class="language-plaintext highlighter-rouge">LockTypeMode.OPTIMISTIC_FORCE_INCREMENT</code></ul><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        testentity0_.id as id1_0_0_,
        testentity0_.count as count2_0_0_,
        testentity0_.is_active as is_activ3_0_0_,
        testentity0_.version as version4_0_0_ 
    from
        test_entity testentity0_ 
    where
        testentity0_.id=?
=== 초기버전: 1
Hibernate: 
    select
        testentity0_.id as id1_0_,
        testentity0_.count as count2_0_,
        testentity0_.is_active as is_activ3_0_,
        testentity0_.version as version4_0_ 
    from
        test_entity testentity0_ 
    where
        testentity0_.id=?
Hibernate: 
    update
        test_entity 
    set
        version=? 
    where
        id=? 
        and version=?
=== 이후버전: 2
</pre></table></code></div></div><p>?!?! 버전이 바뀌었다. 아무런 업데이트가 진행되지 않더라도 이 모드는 버전을 1증가시킨다.</p><blockquote><p>실제 업데이트가 일어난 경우는 2증가시킨다.</p></blockquote><p>이것이 의미하는 바가 굉장히 크다. 만약 <code class="language-plaintext highlighter-rouge">LockTypeMode.OPTIMISTIC_FORCE_INCREMENT</code> 모드를 걸어 객체를 조회한 경우는 다른 트랜잭션에게 제한을 걸어버리는 의미와 같아진다. <a href="https://www.logicbig.com/tutorials/java-ee-tutorial/jpa/optimistic-lock-force-increment-use-case.html">언제 OPTIMISTIC_FORCE_INCREMENT lock mode를 사용할까?</a>를 살펴보면 다음과 같은 상황에서 사용된다고 한다.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>LockModeType.OPTIMISTIC_FORCE_INCREMENT can be used in the scenarios 
where we want to lock another entity while updating the current entity. 
The two entities can be or cannot be directly related, but 
they might be dependent on each other from business logic perspective.
</pre></table></code></div></div><p><br /></p><p><strong>공통점으로는</strong> 버전 넘버를 통해 트랜잭션 격리성을 관리한다는 것이다. 이름에 걸맞게 race condition이 발생하지 않을 것이라고 생각하는 방식의 locking이며 이를 잠근다는 의미보다는 충돌이 났을때 이를 감지하는 의미가 더 크다. 또한 DB레벨에서의 ‘락’이 아니므로 다른 트랜잭션이 들어오는 것이 가능했다!</p><blockquote><p>어플리케이션이 쓰기 작업보다 읽기 작업이 많은 경우 적합한 locking strategy에 해당한다.</p></blockquote><p><br /></p><p>그럼 이제 이 두가지 방식을 가지고 다른 예시를 보자. 마찬가지로 <code class="language-plaintext highlighter-rouge">Jpa + Hibernate</code>를 이용해 진행하겠다.</p><h4 id="성공흐름">성공흐름</h4><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>
<span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">test_success</span><span class="p">(){</span>
    <span class="kd">val</span> <span class="py">em1</span> <span class="p">=</span> <span class="n">emf</span><span class="p">.</span><span class="nf">createEntityManager</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">em2</span> <span class="p">=</span> <span class="n">emf</span><span class="p">.</span><span class="nf">createEntityManager</span><span class="p">()</span>

    <span class="kd">val</span> <span class="py">tx1</span> <span class="p">=</span> <span class="n">em1</span><span class="p">.</span><span class="n">transaction</span>
    <span class="kd">val</span> <span class="py">tx2</span> <span class="p">=</span> <span class="n">em2</span><span class="p">.</span><span class="n">transaction</span>

    <span class="n">tx1</span><span class="p">.</span><span class="nf">begin</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">entity1</span> <span class="p">=</span> <span class="n">em1</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="nc">TestEntity</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="mi">1L</span><span class="p">,</span> <span class="nc">LockModeType</span><span class="p">.</span><span class="nc">NONE</span><span class="p">)</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"=== 초기상태: ${entity1.isActive}"</span><span class="p">)</span>
    <span class="n">entity1</span><span class="p">.</span><span class="nf">updateActive</span><span class="p">()</span>
    <span class="n">tx1</span><span class="p">.</span><span class="nf">commit</span><span class="p">()</span>

    <span class="n">tx2</span><span class="p">.</span><span class="nf">begin</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">entity2</span> <span class="p">=</span> <span class="n">em2</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="nc">TestEntity</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="mi">1L</span><span class="p">)</span>
    <span class="n">entity2</span><span class="p">.</span><span class="nf">updateActive</span><span class="p">()</span>
    <span class="n">tx2</span><span class="p">.</span><span class="nf">commit</span><span class="p">()</span>

    <span class="kd">val</span> <span class="py">finalEntity</span> <span class="p">=</span> <span class="n">service</span><span class="p">.</span><span class="nf">getOne</span><span class="p">()</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"=== 완료상태 :${finalEntity.isActive}"</span><span class="p">)</span>

<span class="p">}</span>

</pre></table></code></div></div><p>트랜잭션 2개를 열어 실제값이 어떻게 바뀌는지 확인해보기 위함이다. 초기값은 <code class="language-plaintext highlighter-rouge">false</code>이고, 트랜잭션 2번 각각에서 이 값을 반대로 바꾸는 연산을 진행하므로 완료 상태값은 다시 <code class="language-plaintext highlighter-rouge">false</code>가 나와야한다.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre>
Hibernate: 
    select
        testentity0_.id as id1_0_0_,
        testentity0_.count as count2_0_0_,
        testentity0_.is_active as is_activ3_0_0_,
        testentity0_.version as version4_0_0_ 
    from
        test_entity testentity0_ 
    where
        testentity0_.id=?
=== 초기상태: false
Hibernate: 
    update
        test_entity 
    set
        is_active=?,
        version=? 
    where
        id=? 
        and version=?
Hibernate: 
    select
        testentity0_.id as id1_0_0_,
        testentity0_.count as count2_0_0_,
        testentity0_.is_active as is_activ3_0_0_,
        testentity0_.version as version4_0_0_ 
    from
        test_entity testentity0_ 
    where
        testentity0_.id=?
Hibernate: 
    update
        test_entity 
    set
        is_active=?,
        version=? 
    where
        id=? 
        and version=?
Hibernate: 
    select
        testentity0_.id as id1_0_,
        testentity0_.count as count2_0_,
        testentity0_.is_active as is_activ3_0_,
        testentity0_.version as version4_0_ 
    from
        test_entity testentity0_ 
    where
        testentity0_.id=?
Hibernate: 
    select
        version as version_ 
    from
        test_entity 
    where
        id =?
=== 완료상태 :false

</pre></table></code></div></div><p>위 로직은 Optimistic Locking을 걸어주지 않아도 당연히 성공한다.</p><h4 id="실패사례">실패사례</h4><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">test_failure</span><span class="p">(){</span>
    <span class="kd">val</span> <span class="py">em1</span> <span class="p">=</span> <span class="n">emf</span><span class="p">.</span><span class="nf">createEntityManager</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">em2</span> <span class="p">=</span> <span class="n">emf</span><span class="p">.</span><span class="nf">createEntityManager</span><span class="p">()</span>

    <span class="kd">val</span> <span class="py">tx1</span> <span class="p">=</span> <span class="n">em1</span><span class="p">.</span><span class="n">transaction</span>
    <span class="kd">val</span> <span class="py">tx2</span> <span class="p">=</span> <span class="n">em2</span><span class="p">.</span><span class="n">transaction</span>

    <span class="n">tx1</span><span class="p">.</span><span class="nf">begin</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">entity1</span> <span class="p">=</span> <span class="n">em1</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="nc">TestEntity</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="mi">1L</span><span class="p">,</span> <span class="nc">LockModeType</span><span class="p">.</span><span class="nc">NONE</span><span class="p">)</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"=== 초기상태: ${entity1.isActive}"</span><span class="p">)</span>
    <span class="n">tx2</span><span class="p">.</span><span class="nf">begin</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">entity2</span> <span class="p">=</span> <span class="n">em2</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="nc">TestEntity</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="mi">1L</span><span class="p">)</span>
    <span class="n">entity2</span><span class="p">.</span><span class="nf">updateActive</span><span class="p">()</span>
    <span class="n">tx2</span><span class="p">.</span><span class="nf">commit</span><span class="p">()</span>
    <span class="n">entity1</span><span class="p">.</span><span class="nf">updateActive</span><span class="p">()</span>
    <span class="n">tx1</span><span class="p">.</span><span class="nf">commit</span><span class="p">()</span>

    <span class="kd">val</span> <span class="py">finalEntity</span> <span class="p">=</span> <span class="n">service</span><span class="p">.</span><span class="nf">getOne</span><span class="p">()</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"=== 완료상태 :${finalEntity.isActive}"</span><span class="p">)</span>

<span class="p">}</span>
</pre></table></code></div></div><p>위 테스트는 반드시 실패해야한다. 2가지 트랜잭션이 서로 꼬여 있다. tx1이 커밋되기전, tx2가 이미 변경을 하고 지나간 상태이다.</p><ul><li>락킹적용 X</ul><p>엔티티의 <code class="language-plaintext highlighter-rouge">@Version</code>이 달린 칼럼과, 리포지토리의 <code class="language-plaintext highlighter-rouge">@Lock</code>을 모두 제거한 상태에서는 어떻게 바뀔까?</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/jpa/1.JPG" /></p><p>성공해버린다.. 완료 상태는 <code class="language-plaintext highlighter-rouge">false</code>가 나와야하지만 <code class="language-plaintext highlighter-rouge">true</code>가 당당히 찍힌 것으로 확인되었다.</p><blockquote><p>Locking이 이렇게 중요하구나…</p></blockquote><ul><li>락킹 적용(LockTypeMode.OPTIMISTIC)</ul><p>그럼 첫번째 옵션인 <code class="language-plaintext highlighter-rouge">LockTypeMode.OPTIMISTIC</code>을 적용해보자. 또한 엔티티에 <code class="language-plaintext highlighter-rouge">@Version</code>어노테이션을 적용한 칼럼도 추가하자.</p><p><br /></p><p>이후 테스트를 진행하면</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/jpa/2.JPG" /></p><p>에러가 잡힌다! 보이다 싶이 <code class="language-plaintext highlighter-rouge">OptimisticLockException</code>이 발생하며, 다른 트랜잭션에 의해 이 값이 변경되었다고 한다. 굿!</p><ul><li>락킹 적용(LockTypeMode.Optimistic_FORCE_INCREMENT)</ul><p><code class="language-plaintext highlighter-rouge">LockTypeMode.OPTIMISTIC_FORCE_INCREMENT</code>를 적용해도 위와 같은 에러가 잡히며 테스트가 실패한다.</p><h2 id="결론">결론</h2><p>두가지 방식 모두 결국엔 <code class="language-plaintext highlighter-rouge">Application에서 제공하는 Optimistic Locking</code>이라는 점이다. 그렇기에 트랜잭션 중간에 다른 트랜잭션이 개입하더라도 오류가 발생하지 않고, 이후에 버전 체크에서 오류를 뱉어내개 하는 것이다. 이 점은 다음 포스트에서 설명할 <code class="language-plaintext highlighter-rouge">Pessimistic Locking</code>과 큰 차이점에 해당한다. (실제 DB의 락 획득과는 무관하다.)</p><p><br /></p><p>초입 부분에 설명하였듯이 <code class="language-plaintext highlighter-rouge">LockTypeMode.OPTIMISITC</code>과 <code class="language-plaintext highlighter-rouge">LockTypeMode.OPTIMISTIC_FORCE_INCREMENT</code>모드는 각각 <code class="language-plaintext highlighter-rouge">READ</code>와 <code class="language-plaintext highlighter-rouge">WRITE</code>이라는 이름또한 가지고 있다. 이러한 SEMANTIC 으로부터 오는 차이점을 어느정도 이해하고 있는 것이 중요하다.</p><h1 id="출처">출처</h1><ul><li><a href="https://stackoverflow.com/questions/15293275/semantic-of-jpa-2-0-optimistic-force-increment">StackOverFlow</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/spring/'>Spring</a>, <a href='/categories/jpa/'>jpa</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring/" class="post-tag no-text-decoration" >spring</a> <a href="/tags/springboot/" class="post-tag no-text-decoration" >springboot</a> <a href="/tags/jpa/" class="post-tag no-text-decoration" >jpa</a> <a href="/tags/orm/" class="post-tag no-text-decoration" >orm</a> <a href="/tags/hibernate/" class="post-tag no-text-decoration" >hibernate</a> <a href="/tags/lock/" class="post-tag no-text-decoration" >lock</a> <a href="/tags/kotlin/" class="post-tag no-text-decoration" >kotlin</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=JPA와 낙관적 락 - Vitriol&url=https://vitriol95.github.io/posts/optimistic/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=JPA와 낙관적 락 - Vitriol&u=https://vitriol95.github.io/posts/optimistic/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=JPA와 낙관적 락 - Vitriol&url=https://vitriol95.github.io/posts/optimistic/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/batchbase1/">스프링 배치 - 1 스프링 배치란?</a><li><a href="/posts/batchbase2/">스프링 배치 - 2 DB 스키마에 대한 이해</a><li><a href="/posts/batchbase3/">스프링 배치 - 3 도메인 뜯어보기(JOB)</a><li><a href="/posts/batchbase4/">스프링 배치 - 4 도메인 뜯어보기(STEP)</a><li><a href="/posts/batchbase5/">스프링 배치 - 5 청크 지향 처리</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/transactional/"><div class="card-body"> <span class="timeago small" > Sep 30, 2021 <i class="unloaded">2021-09-30T14:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JPA의 @Transactional 어노테이션</h3><div class="text-muted small"><p> Transactional 애플리케이션 구현을 할때, 서비스나 리포지토리 단에서 @Transactional이라는 어노테이션을 붙히는 경우가 여럿 있었다. 오늘은 이 어노테이션에 대해 파고 들어가보려한다. 트랜잭션 격리성에 대한 이야기가 나오므로 이글을 보고오면 좋다! 기본 기능 Spring에서 JPA를 사용할 때, 빼놓을 수 없는 기능중 하...</p></div></div></a></div><div class="card"> <a href="/posts/multilang1/"><div class="card-body"> <span class="timeago small" > Oct 6, 2021 <i class="unloaded">2021-10-06T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 + 코틀린 다국어 메시지 관리 시스템 구축(1)</h3><div class="text-muted small"><p> 프로젝트 목표 공부하고 있던 코틀린과 스프링부트의 조합으로 다국어 메시지를 관리하는 시스템을 만들어 보려한다. 프로젝트에 대한 링크는 여기를 참고하면 된다.! 개요 구현해야할 사항은 아래와 같다. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 jdk 11, 빌드 툴 gradle사용 1. 어드민 API ...</p></div></div></a></div><div class="card"> <a href="/posts/multilang2/"><div class="card-body"> <span class="timeago small" > Oct 6, 2021 <i class="unloaded">2021-10-06T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 + 코틀린 다국어 메시지 관리 시스템 구축(2)</h3><div class="text-muted small"><p> 도메인 설계 가장 큰 주안점이 ‘새로운 로케일이 추가 될 수 있다’ 이므로 이에 대해 관계형으로 도메인을 설계했다. 도메인 - 메시지 메시지에서 컨텐츠로, 컨텐츠에서 메시지로 모두 조회를 할 수 있다고 판단하여 mappedBy 어노테이션을 이용해 양방향 매핑을 해주었다. 메시지 클래스는 다음과 같다. 1 2 3 4 5 6 7 8 9 10 1...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/transactional/" class="btn btn-outline-primary" prompt="Older"><p>JPA의 @Transactional 어노테이션</p></a> <a href="/posts/testContainer/" class="btn btn-outline-primary" prompt="Newer"><p>TestContainers</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">vitriol</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://vitriol95.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
