<!DOCTYPE html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="스프링 mvc 프로젝트 + AWS EC2에 빌드까지(8) / 요약 및 최종코드" /><meta property="og:locale" content="ko" /><meta name="description" content="이전 글" /><meta property="og:description" content="이전 글" /><link rel="canonical" href="https://vitriol95.github.io/posts/mvcproject8/" /><meta property="og:url" content="https://vitriol95.github.io/posts/mvcproject8/" /><meta property="og:site_name" content="Vitriol" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-08T11:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="스프링 mvc 프로젝트 + AWS EC2에 빌드까지(8) / 요약 및 최종코드" /><meta name="twitter:site" content="@" /><meta name="google-site-verification" content="QsbP4NOwVkaE8CnHpYOl-qNGhxB9m1RbsrBEefA92ao" /> <script type="application/ld+json"> {"headline":"스프링 mvc 프로젝트 + AWS EC2에 빌드까지(8) / 요약 및 최종코드","dateModified":"2021-07-03T23:20:01+09:00","datePublished":"2021-06-08T11:00:00+09:00","description":"이전 글","url":"https://vitriol95.github.io/posts/mvcproject8/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://vitriol95.github.io/posts/mvcproject8/"},"@context":"https://schema.org"}</script><title>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(8) / 요약 및 최종코드 | Vitriol</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Vitriol"><meta name="application-name" content="Vitriol"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-WSY4XYN711"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-WSY4XYN711'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Vitriol</a></div><div class="site-subtitle font-italic">기억을 적는 시간</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/vitriol95" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['vitriol951','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(8) / 요약 및 최종코드</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(8) / 요약 및 최종코드</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> vitriol </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Jun 8, 2021, 11:00 AM +0900" prep="on" > Jun 8, 2021 <i class="unloaded">2021-06-08T11:00:00+09:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Jul 3, 2021, 11:20 PM +0900" prefix="Updated " > Jul 3, 2021 <i class="unloaded">2021-07-03T23:20:01+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4519 words">25 min</span></div></div><div class="post-content"><h1 id="이전-글">이전 글</h1><p><a href="https://vitriol95.github.io/posts/mvcproject8/">이전글</a> 에서 게시글 삭제 쿼리 분석을 하던중, 관계가 잘못되었음 (엄밀히 따지면 불필요)을 깨닫고 이를 수정하려 한다.. Account의 양방향 매핑을 모두 끊고, count또한 세지 않는다. 각각 엔티티들의 최종 코드를 보면 다음과 같다.</p><hr /><h1 id="엔티티들-최종-코드">엔티티들 최종 코드</h1><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
</pre><td class="rouge-code"><pre><span class="c1">// Account.java</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"account"</span><span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@EqualsAndHashCode</span><span class="o">(</span><span class="n">of</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">,</span> <span class="n">callSuper</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="kd">extends</span> <span class="nc">LocalDateTimeEntity</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">nickname</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">bio</span><span class="o">;</span>

    <span class="nd">@Lob</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">profileImage</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">postCount</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">plusPostCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">postCount</span><span class="o">++;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">minusPostCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">postCount</span><span class="o">--;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Post.java</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"post"</span><span class="o">)</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Post</span> <span class="kd">extends</span> <span class="nc">LocalDateTimeEntity</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">introduction</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"post"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">replies</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">replyCount</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>

    <span class="nd">@Lob</span>
    <span class="nd">@Basic</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">EAGER</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">description</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">open</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setWriter</span><span class="o">(</span><span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">account</span> <span class="o">=</span> <span class="n">account</span><span class="o">;</span>
        <span class="n">account</span><span class="o">.</span><span class="na">plusPostCount</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unsetWriter</span><span class="o">(</span><span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">account</span><span class="o">.</span><span class="na">minusPostCount</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isWriter</span><span class="o">(</span><span class="nc">UserAccount</span> <span class="n">userAccount</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">account</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">userAccount</span><span class="o">.</span><span class="na">getAccount</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isWriter</span><span class="o">(</span><span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">account</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/** 양방향 매핑 with Reply*/</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">replyAdd</span><span class="o">(</span><span class="nc">Reply</span> <span class="n">reply</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">getReplies</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">reply</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">replyCount</span><span class="o">++;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">replyRemove</span><span class="o">(</span><span class="nc">Reply</span> <span class="n">reply</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">getReplies</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="n">reply</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">replyCount</span><span class="o">--;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">makeRepliesEmpty</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">replies</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Reply.java</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"reply"</span><span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Reply</span> <span class="kd">extends</span> <span class="nc">LocalDateTimeEntity</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Post</span> <span class="n">post</span><span class="o">;</span>

    <span class="nd">@Lob</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">description</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isWriter</span><span class="o">(</span><span class="nc">UserAccount</span> <span class="n">userAccount</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">account</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">userAccount</span><span class="o">.</span><span class="na">getAccount</span><span class="o">());</span>
    <span class="o">}</span>


    <span class="cm">/** 양방향 매핑 메서드 With Post */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postedOn</span><span class="o">(</span><span class="nc">Post</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">post</span> <span class="o">=</span> <span class="n">post</span><span class="o">;</span>
        <span class="n">post</span><span class="o">.</span><span class="na">replyAdd</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">depostedOn</span><span class="o">(</span><span class="nc">Post</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">post</span><span class="o">.</span><span class="na">replyRemove</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setWriter</span><span class="o">(</span><span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">account</span> <span class="o">=</span> <span class="n">account</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>변화된 점은 Account는 모두 단방향 매핑을 이어가며 Post와 Reply만 양방향 매핑을 유지한다는 점이다.</p><hr /><h1 id="최종-쿼리-효율-확인-변경-부분만">최종 쿼리 효율 확인 (변경 부분만)</h1><h2 id="게시글-삭제">게시글 삭제</h2><p>게시글 삭제의 경우 최종 로직은 다음과 같다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="c1">// PostController.java</span>
<span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/posts/{id}/delete"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">deletePostSubmit</span><span class="o">(</span><span class="nd">@LoggedInUser</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postService</span><span class="o">.</span><span class="na">getPostToDelete</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">account</span><span class="o">);</span>
    <span class="n">postService</span><span class="o">.</span><span class="na">deletePost</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"redirect:/"</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// PostService.java</span>
<span class="kd">public</span> <span class="nc">Post</span> <span class="nf">getPostToDelete</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">findDeletePostWithAccountAndRepliesById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="n">validateWriter</span><span class="o">(</span><span class="n">account</span><span class="o">,</span> <span class="n">post</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">post</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">deletePost</span><span class="o">(</span><span class="nc">Post</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">post</span><span class="o">.</span><span class="na">unsetWriter</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">getAccount</span><span class="o">());</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">targetReplies</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="na">getReplies</span><span class="o">();</span>

    <span class="n">replyRepository</span><span class="o">.</span><span class="na">bulkDeleteByRemovePost</span><span class="o">(</span><span class="n">targetReplies</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="nl">Reply:</span><span class="o">:</span><span class="n">getId</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">()));</span>
    <span class="n">post</span><span class="o">.</span><span class="na">makeRepliesEmpty</span><span class="o">();</span>
    <span class="n">postRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// PostRepository.java</span>
<span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"select distinct p from Post p join fetch p.account left join fetch p.replies where p.id = :id"</span><span class="o">)</span>
<span class="nc">Post</span> <span class="nf">findDeletePostWithAccountAndRepliesById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>

<span class="c1">// ReplyRepository.java</span>
<span class="nd">@Transactional</span>
<span class="nd">@Modifying</span><span class="o">(</span><span class="n">flushAutomatically</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@Query</span><span class="o">(</span><span class="s">"delete from Reply r where r.id in (:ids)"</span><span class="o">)</span>
<span class="kt">int</span> <span class="nf">bulkDeleteByRemovePost</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"ids"</span><span class="o">)</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">ids</span><span class="o">);</span>

<span class="c1">// Post.java</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">unsetWriter</span><span class="o">(</span><span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">account</span><span class="o">.</span><span class="na">minusPostCount</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">makeRepliesEmpty</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">replies</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="o">}</span>

<span class="c1">// Account.java</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">minusPostCount</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">postCount</span><span class="o">--;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>이 흐름대로 어플리케이션이 진행될때 나가는 쿼리 흐름을 한번 살펴보자. <br /></p><ol><li>가장 먼저 <code class="language-plaintext highlighter-rouge">postService.getPostToDelete</code>를 호출한다. 이는 <code class="language-plaintext highlighter-rouge">postRepository.findDeletePostWithAccountAndRepliesById</code>메서드를 호출하게 되는데, 이를 JPQL쿼리로 구현하였다.<li>이 쿼리는 게시글과 함께 글쓴이, 댓글(들)을 페치조인하여 가져온다. 이때 <strong>SELECT</strong> 쿼리가 한개 나갈것이다.<blockquote><p>댓글쓴이는 정보가 필요없다. 왜냐하면 댓글(Reply)과 댓글쓴이(Account)는 더이상 양방향 매핑 관계가 아니기 때문이다.</p></blockquote><li>이후, 글쓴이가 맞는지에 대한 확인을 위한 <code class="language-plaintext highlighter-rouge">validateWriter</code>메서드를 부른다. 이 메서드는 시큐리티 컨텍스트에 있는 principal 내 account와 Post의 account를 비교한다. 우리는 이미 SELECT쿼리에 의해 ‘post.account’를 가져왔으므로 추가쿼리는 없다.<li>이후 <code class="language-plaintext highlighter-rouge">postService.deletePost</code>로 들어가게 된다. 가장 먼저 <code class="language-plaintext highlighter-rouge">post.unsetwriter</code>를 호출하고 이는 <code class="language-plaintext highlighter-rouge">account.minusPostCount</code>로 인해 글쓴이의 postCount를 1 내린다. 이때 <strong>UPDATE</strong> 쿼리가 발생한다.<blockquote><p>이미 페치조인하여 가져왔으므로 SELECT 쿼리는 당연히 필요없다.</p></blockquote><li>다음으로는 <code class="language-plaintext highlighter-rouge">replyRepository.bulkDeleteByRemovePost</code>를 호출한다. 이는 JPQL의 @Query로 작성된 Bulk Delete문에 해당한다. 이때 Where절이 id in (?) 형태인 <strong>DELETE</strong> 쿼리가 발생하게 된다.<blockquote><p>ReplyRepository.java는 @Transactional(readOnly=true)이므로 @Transactional 어노테이션을 써주어야 하며, 삭제가 이루어지므로 @Modifying 어노테이션도 필요하다.</p></blockquote><li>마지막으로 <code class="language-plaintext highlighter-rouge">postRepository.delete</code>라는 SpringDataJpa 메서드에 의해 실제 post가 삭제된다. 이때 <strong>DELETE</strong> 쿼리가 발생한다.</ol><p><br /> 즉, 총 1개의 SELECT문과 1개의 UPDATE, 2개의 DELETE문이 발생하게 된다. 실제 쿼리도 아래와 같았다.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        distinct post0_.id as id1_1_0_,
        account1_.id as id1_0_1_,
        replies2_.id as id1_2_2_,
        post0_.created_date as created_2_1_0_,
        post0_.modified_date as modified3_1_0_,
        post0_.account_id as account_9_1_0_,
        post0_.description as descript4_1_0_,
        post0_.introduction as introduc5_1_0_,
        post0_.open as open6_1_0_,
        post0_.reply_count as reply_co7_1_0_,
        post0_.title as title8_1_0_,
        account1_.created_date as created_2_0_1_,
        account1_.modified_date as modified3_0_1_,
        account1_.bio as bio4_0_1_,
        account1_.email as email5_0_1_,
        account1_.nickname as nickname6_0_1_,
        account1_.password as password7_0_1_,
        account1_.post_count as post_cou8_0_1_,
        account1_.profile_image as profile_9_0_1_,
        replies2_.created_date as created_2_2_2_,
        replies2_.modified_date as modified3_2_2_,
        replies2_.account_id as account_5_2_2_,
        replies2_.description as descript4_2_2_,
        replies2_.post_id as post_id6_2_2_,
        replies2_.post_id as post_id6_2_0__,
        replies2_.id as id1_2_0__ 
    from
        post post0_ 
    inner join
        account account1_ 
            on post0_.account_id=account1_.id 
    left outer join
        reply replies2_ 
            on post0_.id=replies2_.post_id 
    where
        post0_.id=?
Hibernate: 
    update
        account 
    set
        created_date=?,
        modified_date=?,
        bio=?,
        email=?,
        nickname=?,
        password=?,
        post_count=?,
        profile_image=? 
    where
        id=?
Hibernate:
    delete 
    from
        reply 
    where
        id in (
            ? , ? , ?
        )
Hibernate:
    delete 
    from
        post 
    where
        id=?

</pre></table></code></div></div><p>이 로직을 어떻게 구현할것인가 정말 고민이 많았다. 이 부분은 프로젝트 진행중에 가장 많이 고민을 한 부분이므로 수정과정을 잠시만 적어보려한다.</p><h3 id="bulk-delete문을-작성한-이유">Bulk Delete문을 작성한 이유</h3><p>가장 먼저 이렇게 시도해보았다. post와 reply는 양방향 매핑이 되어있으며 이때, 연관관계의 주인은 reply이다. 현재와 같은 상황에서 post객체를 지우게 되면 DB의 <strong>참조 무결성 제약조건</strong> 에 어긋나게 되어 오류를 뱉어내게 된다.</p><p><br /> 따라서 Post.java를 다음과 같이 수정해 delete를 진행하려고 했었다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// Post.java</span>
<span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"post"</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="nc">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">replies</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
</pre></table></code></div></div><p>참조 무결성 제약조건을 cascade로 설정하여 부모 릴레이션인 post가 삭제되면 replies가 따라서 삭제되게 된다. 또한 orphanRemoval을 true로 주어 참조가 끊어진 자식객체를 삭제하도록한다. 이렇게되면 post와 거기에 연관된 reply들은 생명주기가 같아진다. <br /> 이렇게 설정해주면 reply를 delete할 필요없이 post만 delete해주면 된다. 하지만 <strong>이때는 딸려있는 reply각각을 delete하게 된다</strong> 즉, 댓글이 3개인경우 delete문이 3개가 나가게 되는 것이다.</p><blockquote><p>일종의 1+N 문제라고 봐도 되려나..</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>Hibernate: 
    delete 
    from
        reply 
    where
        id=?
@@ -352,4 +353,466 @@
@Query("delete from Reply r where r.id in (:ids)")
int bulkDeleteByRemovePost(@Param("ids") Set&lt;Long&gt; ids);
</pre></table></code></div></div><p>``` 따라서 delete 문을 where ~ in 조건을 이용해 bulkDelete 할 수 있다. 이때 in안에 들어가는 객체 사이즈의 최대값 또한 조절해 줄 수 있다. 필자는 아래와 같이 설정해 주었다.</p></blockquote><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>  <span class="na">jpa</span><span class="pi">:</span>
    <span class="na">properties</span><span class="pi">:</span>
      <span class="na">hibernate</span><span class="pi">:</span>
        <span class="na">format_sql</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">default_batch_fetch_size</span><span class="pi">:</span> <span class="m">1000</span>
</pre></table></code></div></div><p><br /></p><p>그리고 이후에 @Modifying 어노테이션에 주목해보자. 이 쿼리는 조회쿼리를 제외한 변경, 삭제, 삽입등의 작업이 일어날 때 작성해주어야 하는 어노테이션에 해당한다. 옵션은 두가지가 존재한다. clear / flushAutomatically가 그것이다.</p><blockquote><p>둘다 default는 false이다. <br /> 이 두가지는 ‘동기화’를 위해 존재한다고 봐도 무방하다. 많은 경우 두가지를 true로 놓는 경우가 안전하지만, 필자는 여기서 clearAutomatically는 false로 설정하였다. 이를 true로 놓게되면 영속성 컨텍스트를 모두 비워두게 된다.</p></blockquote><p><br /> 비워 놓게되면 어떤 일이 발생할까. 우리는 이 작업이후, post의 delete를 수행해야 한다는 점을 생각해보자. 영속성 컨텍스트가 비어있으므로 다시 post를 id를 통해 검색해오는 쿼리가 발생하게 될 것이다. 즉 다음의 쿼리가 Delete 쿼리 이전에 나갈 것이다.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        post0_.id as id1_1_0_,
        post0_.created_date as created_2_1_0_,
        post0_.modified_date as modified3_1_0_,
        post0_.account_id as account_9_1_0_,
        post0_.description as descript4_1_0_,
        post0_.introduction as introduc5_1_0_,
        post0_.open as open6_1_0_,
        post0_.reply_count as reply_co7_1_0_,
        post0_.title as title8_1_0_,
    from
        post post0_ 
    where
        post0_.id=?
</pre></table></code></div></div><h2 id="댓글-등록">댓글 등록</h2><p>댓글 등록의 경우 Ajax방식으로 Json 객체를 Post요청으로 보내며 로직은 다음을 따른다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="c1">// PostController.java</span>
<span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/posts/{id}/reply"</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="nc">ResponseEntity</span> <span class="nf">replyFormSubmit</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nd">@LoggedInUser</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="nd">@RequestBody</span> <span class="nc">NewReplyForm</span> <span class="n">newReplyForm</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postService</span><span class="o">.</span><span class="na">getVanillaPost</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="n">postService</span><span class="o">.</span><span class="na">createNewReply</span><span class="o">(</span><span class="n">modelMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">newReplyForm</span><span class="o">,</span> <span class="nc">Reply</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">post</span><span class="o">,</span> <span class="n">account</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">ok</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
<span class="c1">// PostService.java</span>
<span class="kd">public</span> <span class="nc">Post</span> <span class="nf">getVanillaPost</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">findPostById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">createNewReply</span><span class="o">(</span><span class="nc">Reply</span> <span class="n">reply</span><span class="o">,</span> <span class="nc">Post</span> <span class="n">post</span><span class="o">,</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Account</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getEmail</span><span class="o">());</span>
    <span class="n">reply</span><span class="o">.</span><span class="na">setWriter</span><span class="o">(</span><span class="n">writer</span><span class="o">);</span>
    <span class="n">reply</span><span class="o">.</span><span class="na">postedOn</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
    <span class="n">replyRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">reply</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">// PostRepository.java</span>
<span class="nc">Post</span> <span class="nf">findPostById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>
<span class="c1">// Reply.java</span>
<span class="cm">/** 양방향 매핑 메서드 With Post */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">postedOn</span><span class="o">(</span><span class="nc">Post</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">post</span> <span class="o">=</span> <span class="n">post</span><span class="o">;</span>
    <span class="n">post</span><span class="o">.</span><span class="na">replyAdd</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setWriter</span><span class="o">(</span><span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">account</span> <span class="o">=</span> <span class="n">account</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>바로 실제 쿼리를 살펴보도록 하자.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        post0_.id as id1_1_,
        post0_.created_date as created_2_1_,
        post0_.modified_date as modified3_1_,
        post0_.account_id as account_9_1_,
        post0_.description as descript4_1_,
        post0_.introduction as introduc5_1_,
        post0_.open as open6_1_,
        post0_.reply_count as reply_co7_1_,
        post0_.title as title8_1_ 
    from
        post post0_ 
    where
        post0_.id=?
Hibernate: 
    select
        account0_.id as id1_0_,
        account0_.created_date as created_2_0_,
        account0_.modified_date as modified3_0_,
        account0_.bio as bio4_0_,
        account0_.email as email5_0_,
        account0_.nickname as nickname6_0_,
        account0_.password as password7_0_,
        account0_.post_count as post_cou8_0_,
        account0_.profile_image as profile_9_0_ 
    from
        account account0_ 
    where
        account0_.email=?
Hibernate: 
    insert 
    into
        reply
        (id, created_date, modified_date, account_id, description, post_id) 
    values
        (null, ?, ?, ?, ?, ?)
Hibernate: 
    update
        post 
    set
        created_date=?,
        modified_date=?,
        account_id=?,
        description=?,
        introduction=?,
        open=?,
        reply_count=?,
        title=? 
    where
        id=?
</pre></table></code></div></div><ol><li>가장 먼저, <code class="language-plaintext highlighter-rouge">postService.getVanillaPost</code> 메서드로 연관관계 매핑이 없는 순수 post를 가져온다. 따라서 <strong>SELECT</strong> 문이 나가게 된다.<li>이후 <code class="language-plaintext highlighter-rouge">postService.createNewReply</code>를 호출한다. 이때 댓글의 작성자는 시큐리티 컨텍스트에 담겨있는 Account에 해당하며 이는 Detached상태에 해당한다. 따라서 이를 Managed 상태로 만들어주는 <code class="language-plaintext highlighter-rouge">accountRepository.findByEmail</code> <strong>SELECT</strong> 쿼리가 나가게 된다.<li>Reply의 <strong>INSERT</strong> 쿼리가 실행된다. 이때 account(댓글쓴이)와 post는 매핑이 되어있다.<li>마지막으로 post의 replyCount를 1 증가시켜주고 있으므로 이에 대한 <strong>UPDATE</strong> 쿼리가 나간다. 또한 양방향 매핑을 해놓는다.</ol><hr /><h2 id="댓글-삭제">댓글 삭제</h2><p>댓글 삭제의 경우는 다음과 같은 로직을 따르게 된다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="c1">// PostController.java</span>
<span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/posts/{postId}/reply/{replyId}/delete"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">deleteReplySubmit</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"postId"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"replyId"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">replyId</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postService</span><span class="o">.</span><span class="na">getVanillaPost</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="nc">Reply</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">replyRepository</span><span class="o">.</span><span class="na">findReplyById</span><span class="o">(</span><span class="n">replyId</span><span class="o">);</span>
    <span class="n">postService</span><span class="o">.</span><span class="na">deleteReply</span><span class="o">(</span><span class="n">reply</span><span class="o">,</span> <span class="n">post</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"redirect:/posts/"</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">// PostService.java</span>
<span class="kd">public</span> <span class="nc">Post</span> <span class="nf">getVanillaPost</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">findPostById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteReply</span><span class="o">(</span><span class="nc">Reply</span> <span class="n">reply</span><span class="o">,</span> <span class="nc">Post</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">reply</span><span class="o">.</span><span class="na">depostedOn</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
    <span class="n">replyRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">reply</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">// PostRepository.java</span>
<span class="nc">Reply</span> <span class="nf">findReplyById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>
<span class="c1">// Reply.java</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">depostedOn</span><span class="o">(</span><span class="nc">Post</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">post</span><span class="o">.</span><span class="na">replyRemove</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">// Post.java</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">replyRemove</span><span class="o">(</span><span class="nc">Reply</span> <span class="n">reply</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">getReplies</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="n">reply</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">replyCount</span><span class="o">--;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>이의 쿼리는 다음과 같았다.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        post0_.id as id1_1_,
        post0_.created_date as created_2_1_,
        post0_.modified_date as modified3_1_,
        post0_.account_id as account_9_1_,
        post0_.description as descript4_1_,
        post0_.introduction as introduc5_1_,
        post0_.open as open6_1_,
        post0_.reply_count as reply_co7_1_,
        post0_.title as title8_1_ 
    from
        post post0_ 
    where
        post0_.id=?
Hibernate: 
    select
        reply0_.id as id1_2_,
        reply0_.created_date as created_2_2_,
        reply0_.modified_date as modified3_2_,
        reply0_.account_id as account_5_2_,
        reply0_.description as descript4_2_,
        reply0_.post_id as post_id6_2_ 
    from
        reply reply0_ 
    where
        reply0_.id=?
Hibernate: ---------------------(*)
    select
        replies0_.post_id as post_id6_2_1_,
        replies0_.id as id1_2_1_,
        replies0_.id as id1_2_0_,
        replies0_.created_date as created_2_2_0_,
        replies0_.modified_date as modified3_2_0_,
        replies0_.account_id as account_5_2_0_,
        replies0_.description as descript4_2_0_,
        replies0_.post_id as post_id6_2_0_ 
    from
        reply replies0_ 
    where
        replies0_.post_id=?
Hibernate: 
    update
        post 
    set
        created_date=?,
        modified_date=?,
        account_id=?,
        description=?,
        introduction=?,
        open=?,
        reply_count=?,
        title=? 
    where
        id=?
Hibernate: 
    delete 
    from
        reply 
    where
        id=?
</pre></table></code></div></div><p>쿼리는 다음과 같은 순서로 나가게 된다.</p><ol><li>앞서 댓글등록과 같은 <code class="language-plaintext highlighter-rouge">postService.getVanillaPost</code>에 의해 댓글이 속한 Post에 대한 <strong>SELECT</strong> 쿼리가 하나 나가게 된다.<li>이후 삭제할 Reply를 <code class="language-plaintext highlighter-rouge">replyRepository.findReplyById</code>를 통해 가져오게 된다. Reply에 대한 <strong>SELECT</strong> 쿼리가 나간다.<li>세번째 쿼리는 (*)처리가 되어있다. 이는 <code class="language-plaintext highlighter-rouge">reply.depostedOn</code> 메서드를 따라가면 알 수 있다. 이는 양방향 매핑을 해제하기 위해서 존재하며, post가 가지고있는 replies 목록중에 지울 reply를 제거한다. 이 과정에서 3번째 SELECT문이 나가게 된다. Post와 reply는 fetchType이 Lazy이므로 발생하는 현상이다.<blockquote><p>이는 더 좋은 방법으로 수정할 수 있을 것 같다.</p></blockquote><li>이후, post의 replyCount를 1내려주는 <strong>UPDATE</strong> 쿼리가 나가며 댓글을 삭제하는 <strong>DELETE</strong> 쿼리가 나가게 된다.</ol><h3 id="더-효율적인-방법으로-바꾸어보자">더 효율적인 방법으로 바꾸어보자.</h3><p>(*)표시되어있는 쿼리이자, 3번 상황을 좀 더 효율적으로 바꿀 수 있을 것 같다. 처음 Post객체를 가져올때 가지고 있는 reply를 모두 페치조인하여 가져오면 저 불필요한 SELECT쿼리를 없앨 수 있다. 아래와 같이 Post를 가져오는 쿼리를 수정해 보았다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// PostRepository.java</span>
<span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"select p from Post p left join fetch p.replies where p.id = :id"</span><span class="o">)</span>
<span class="nc">Post</span> <span class="nf">findPostToDeleteReplyById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>
</pre></table></code></div></div><p>변경 이후 쿼리는 다음과 같았다.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        post0_.id as id1_1_0_,
        replies1_.id as id1_2_1_,
        post0_.created_date as created_2_1_0_,
        post0_.modified_date as modified3_1_0_,
        post0_.account_id as account_9_1_0_,
        post0_.description as descript4_1_0_,
        post0_.introduction as introduc5_1_0_,
        post0_.open as open6_1_0_,
        post0_.reply_count as reply_co7_1_0_,
        post0_.title as title8_1_0_,
        replies1_.created_date as created_2_2_1_,
        replies1_.modified_date as modified3_2_1_,
        replies1_.account_id as account_5_2_1_,
        replies1_.description as descript4_2_1_,
        replies1_.post_id as post_id6_2_1_,
        replies1_.post_id as post_id6_2_0__,
        replies1_.id as id1_2_0__ 
    from
        post post0_ 
    left outer join
        reply replies1_ 
            on post0_.id=replies1_.post_id 
    where
        post0_.id=?
Hibernate: 
    select
        reply0_.id as id1_2_,
        reply0_.created_date as created_2_2_,
        reply0_.modified_date as modified3_2_,
        reply0_.account_id as account_5_2_,
        reply0_.description as descript4_2_,
        reply0_.post_id as post_id6_2_ 
    from
        reply reply0_ 
    where
        reply0_.id=?
Hibernate: 
    update
        post 
    set
        created_date=?,
        modified_date=?,
        account_id=?,
        description=?,
        introduction=?,
        open=?,
        reply_count=?,
        title=? 
    where
        id=?
Hibernate: 
    delete 
    from
        reply 
    where
        id=?
</pre></table></code></div></div><p>불필요한 쿼리 하나를 줄여보았다.</p><hr /><h2 id="유저-목록-보기">유저 목록 보기</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/35.JPG" /></p><p>로직은 다음과 같다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/accounts"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">allAccountView</span><span class="o">(</span><span class="nd">@PageableDefault</span><span class="o">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">20</span><span class="o">,</span> <span class="n">sort</span> <span class="o">=</span> <span class="s">"postCount"</span><span class="o">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">)</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">,</span> <span class="nd">@LoggedInUser</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Account</span><span class="o">&gt;</span> <span class="n">accountPage</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">pageable</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"account"</span><span class="o">,</span> <span class="n">account</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"accountPage"</span><span class="o">,</span> <span class="n">accountPage</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"account/all"</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>단순하다. findAll메서드는 JpaRepository를 그대로 사용하였다. 쿼리는 카운트를 포함한 2개가 나가게 된다.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        count(*) as col_0_0_ 
    from
        account account0_
Hibernate: 
    select
        account0_.id as id1_0_,
        account0_.created_date as created_2_0_,
        account0_.modified_date as modified3_0_,
        account0_.bio as bio4_0_,
        account0_.email as email5_0_,
        account0_.nickname as nickname6_0_,
        account0_.password as password7_0_,
        account0_.post_count as post_cou8_0_,
        account0_.profile_image as profile_9_0_ 
    from
        account account0_ 
    order by
        account0_.post_count desc limit ?
</pre></table></code></div></div><p>정렬을 게시글 개수의 내림차순으로 진행한것도 잘 적용이 되어있다.</p><hr /><h2 id="게시글-검색">게시글 검색</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/36.JPG" /></p><p>게시글 검색의 경우 다음의 로직을 따른다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">// MainController.java</span>
<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/search/post"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">searchPost</span><span class="o">(</span><span class="nd">@PageableDefault</span><span class="o">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">12</span><span class="o">,</span> <span class="n">sort</span> <span class="o">=</span> <span class="s">"createdDate"</span><span class="o">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">)</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">,</span> <span class="nd">@LoggedInUser</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="nc">String</span> <span class="n">keyword</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="n">postPage</span> <span class="o">=</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">findByKeyword</span><span class="o">(</span><span class="n">keyword</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"postPage"</span><span class="o">,</span> <span class="n">postPage</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">,</span> <span class="n">keyword</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"sortProperty"</span><span class="o">,</span> <span class="n">pageable</span><span class="o">.</span><span class="na">getSort</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"createdDate"</span><span class="o">)</span> <span class="o">?</span> <span class="s">"createdDate"</span> <span class="o">:</span> <span class="s">"replyCount"</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"search"</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">// PostRepositoryExImpl.java</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="nf">findByKeyword</span><span class="o">(</span><span class="nc">String</span> <span class="n">keyword</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">QPost</span> <span class="n">post</span> <span class="o">=</span> <span class="nc">QPost</span><span class="o">.</span><span class="na">post</span><span class="o">;</span>
    <span class="nc">JPQLQuery</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">from</span><span class="o">(</span><span class="n">post</span><span class="o">).</span><span class="na">where</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">open</span><span class="o">.</span><span class="na">isTrue</span><span class="o">()</span>
            <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">title</span><span class="o">.</span><span class="na">containsIgnoreCase</span><span class="o">(</span><span class="n">keyword</span><span class="o">)))</span>
            <span class="o">.</span><span class="na">leftJoin</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">account</span><span class="o">,</span> <span class="nc">QAccount</span><span class="o">.</span><span class="na">account</span><span class="o">).</span><span class="na">fetchJoin</span><span class="o">();</span>
    <span class="nc">JPQLQuery</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="n">pageableQuery</span> <span class="o">=</span> <span class="n">getQuerydsl</span><span class="o">().</span><span class="na">applyPagination</span><span class="o">(</span><span class="n">pageable</span><span class="o">,</span> <span class="n">query</span><span class="o">);</span>
    <span class="nc">QueryResults</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="n">fetchResults</span> <span class="o">=</span> <span class="n">pageableQuery</span><span class="o">.</span><span class="na">fetchResults</span><span class="o">();</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">PageImpl</span><span class="o">&lt;&gt;(</span><span class="n">fetchResults</span><span class="o">.</span><span class="na">getResults</span><span class="o">(),</span> <span class="n">pageable</span><span class="o">,</span> <span class="n">fetchResults</span><span class="o">.</span><span class="na">getTotal</span><span class="o">());</span>
<span class="o">}</span>
</pre></table></code></div></div><p>QueryDsl을 사용하여 메서드를 구현했었다. 이는 페이지에 대한 쿼리와 카운트 쿼리를 가져오게 될 것이다.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre>Hibernate: 
    select
        count(post0_.id) as col_0_0_ 
    from
        post post0_ 
    left outer join
        account account1_ 
            on post0_.account_id=account1_.id 
    where
        post0_.open=? 
        and (
            lower(post0_.title) like ? escape '!'
        )
Hibernate: 
    select
        post0_.id as id1_1_0_,
        account1_.id as id1_0_1_,
        post0_.created_date as created_2_1_0_,
        post0_.modified_date as modified3_1_0_,
        post0_.account_id as account_9_1_0_,
        post0_.description as descript4_1_0_,
        post0_.introduction as introduc5_1_0_,
        post0_.open as open6_1_0_,
        post0_.reply_count as reply_co7_1_0_,
        post0_.title as title8_1_0_,
        account1_.created_date as created_2_0_1_,
        account1_.modified_date as modified3_0_1_,
        account1_.bio as bio4_0_1_,
        account1_.email as email5_0_1_,
        account1_.nickname as nickname6_0_1_,
        account1_.password as password7_0_1_,
        account1_.post_count as post_cou8_0_1_,
        account1_.profile_image as profile_9_0_1_ 
    from
        post post0_ 
    left outer join
        account account1_ 
            on post0_.account_id=account1_.id 
    where
        post0_.open=? 
        and (
            lower(post0_.title) like ? escape '!'
        ) 
    order by
        post0_.created_date desc limit ?
</pre></table></code></div></div><h1 id="db를-mysql로-교체하기">DB를 MySQL로 교체하기</h1><p>가장 먼저, build.gradle을 다음처럼 수정하였다.</p><div class="language-groovy highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre><td class="rouge-code"><pre><span class="n">plugins</span> <span class="o">{</span>
    <span class="n">id</span> <span class="s1">'org.springframework.boot'</span> <span class="n">version</span> <span class="s1">'2.4.7'</span>
    <span class="n">id</span> <span class="s1">'io.spring.dependency-management'</span> <span class="n">version</span> <span class="s1">'1.0.11.RELEASE'</span>
    <span class="n">id</span> <span class="s1">'java'</span>
<span class="o">}</span>

<span class="n">group</span> <span class="o">=</span> <span class="s1">'vitriol'</span>
<span class="n">version</span> <span class="o">=</span> <span class="s1">'0.0.1-SNAPSHOT'</span>
<span class="n">sourceCompatibility</span> <span class="o">=</span> <span class="s1">'11'</span>

<span class="n">configurations</span> <span class="o">{</span>
    <span class="n">compileOnly</span> <span class="o">{</span>
        <span class="n">extendsFrom</span> <span class="n">annotationProcessor</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">repositories</span> <span class="o">{</span>
    <span class="n">mavenCentral</span><span class="o">()</span>
    <span class="n">jcenter</span><span class="o">()</span>
<span class="o">}</span>

<span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-data-jpa'</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-thymeleaf'</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-web'</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-security'</span>
    <span class="n">implementation</span> <span class="s1">'org.thymeleaf.extras:thymeleaf-extras-springsecurity5'</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-validation:2.4.0'</span>
    <span class="n">implementation</span> <span class="s1">'org.modelmapper:modelmapper:2.3.7'</span>
    <span class="n">compileOnly</span> <span class="s1">'org.projectlombok:lombok'</span>

    <span class="c1">// Lombok for Test</span>
    <span class="n">testCompileOnly</span> <span class="s1">'org.projectlombok:lombok'</span>
    <span class="n">testAnnotationProcessor</span> <span class="s1">'org.projectlombok:lombok'</span>

    <span class="c1">// MySQL</span>
    <span class="n">runtimeOnly</span> <span class="s1">'mysql:mysql-connector-java'</span>

    <span class="n">developmentOnly</span> <span class="s1">'org.springframework.boot:spring-boot-devtools'</span>
    <span class="n">annotationProcessor</span> <span class="s1">'org.projectlombok:lombok'</span>
    <span class="n">testImplementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-test'</span>
    <span class="n">testImplementation</span> <span class="s1">'org.springframework.security:spring-security-test'</span>

    <span class="cm">/** query DSL*/</span>
    <span class="n">compile</span> <span class="s2">"com.querydsl:querydsl-jpa"</span>
    <span class="n">compile</span> <span class="s2">"com.querydsl:querydsl-core"</span>
    <span class="n">annotationProcessor</span> <span class="s2">"com.querydsl:querydsl-apt:${dependencyManagement.importedProperties['querydsl.version']}:jpa"</span>
    <span class="n">annotationProcessor</span> <span class="s2">"jakarta.persistence:jakarta.persistence-api:2.2.3"</span>
    <span class="n">annotationProcessor</span> <span class="s2">"jakarta.annotation:jakarta.annotation-api:1.3.5"</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="n">generated</span><span class="o">=</span><span class="s1">'src/main/generated'</span>
<span class="n">sourceSets</span> <span class="o">{</span>
    <span class="n">main</span><span class="o">.</span><span class="na">java</span><span class="o">.</span><span class="na">srcDirs</span> <span class="o">+=</span> <span class="o">[</span> <span class="n">generated</span> <span class="o">]</span>
<span class="o">}</span>

<span class="n">tasks</span><span class="o">.</span><span class="na">withType</span><span class="o">(</span><span class="n">JavaCompile</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">options</span><span class="o">.</span><span class="na">annotationProcessorGeneratedSourcesDirectory</span> <span class="o">=</span> <span class="n">file</span><span class="o">(</span><span class="n">generated</span><span class="o">)</span>
<span class="o">}</span>

<span class="n">clean</span><span class="o">.</span><span class="na">doLast</span> <span class="o">{</span>
    <span class="n">file</span><span class="o">(</span><span class="n">generated</span><span class="o">).</span><span class="na">deleteDir</span><span class="o">()</span>
<span class="o">}</span>

<span class="n">test</span> <span class="o">{</span>
    <span class="n">useJUnitPlatform</span><span class="o">()</span>
<span class="o">}</span>

</pre></table></code></div></div><p>기존의 runtimeOnly였던 h2설정을 지우고, mysql을 넣어주었다.</p><p><br /> 이후 application.yml을 다음과 같이 수정해 주었다.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="na">spring</span><span class="pi">:</span>
  <span class="na">datasource</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">jdbc:mysql://localhost:3306/mvcservice?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;allowPubilcKeyRetrieval=true</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">계정 이름</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">비밀번호</span>
    <span class="na">driver-class-name</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
  <span class="na">jpa</span><span class="pi">:</span>
    <span class="na">hibernate</span><span class="pi">:</span>
      <span class="na">ddl-auto</span><span class="pi">:</span> <span class="s">validate</span>
    <span class="na">show-sql</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">properties</span><span class="pi">:</span>
      <span class="na">hibernate</span><span class="pi">:</span>
        <span class="na">format_sql</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">default_batch_fetch_size</span><span class="pi">:</span> <span class="m">1000</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">database-platform</span><span class="pi">:</span> <span class="s">org.hibernate.dialect.MySQL8Dialect</span>

<span class="na">server</span><span class="pi">:</span>
  <span class="na">tomcat</span><span class="pi">:</span>
    <span class="na">max-http-form-post-size</span><span class="pi">:</span> <span class="s">5MB</span>
</pre></table></code></div></div><p>이제 모든 로컬환경에서의 준비를 끝냈다. 다음시간 부터는 직접 AWS에 빌드해보자!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/spring/'>Spring</a>, <a href='/categories/spring-project/'>spring_project</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring/" class="post-tag no-text-decoration" >spring</a> <a href="/tags/spring-mvc/" class="post-tag no-text-decoration" >spring mvc</a> <a href="/tags/springboot/" class="post-tag no-text-decoration" >springboot</a> <a href="/tags/springframework/" class="post-tag no-text-decoration" >springframework</a> <a href="/tags/java/" class="post-tag no-text-decoration" >java</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(8) / 요약 및 최종코드 - Vitriol&url=https://vitriol95.github.io/posts/mvcproject8/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(8) / 요약 및 최종코드 - Vitriol&u=https://vitriol95.github.io/posts/mvcproject8/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(8) / 요약 및 최종코드 - Vitriol&url=https://vitriol95.github.io/posts/mvcproject8/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/batchbase1/">스프링 배치 - 1 스프링 배치란?</a><li><a href="/posts/batchbase2/">스프링 배치 - 2 DB 스키마에 대한 이해</a><li><a href="/posts/batchbase3/">스프링 배치 - 3 도메인 뜯어보기(JOB)</a><li><a href="/posts/batchbase4/">스프링 배치 - 4 도메인 뜯어보기(STEP)</a><li><a href="/posts/batchbase5/">스프링 배치 - 5 청크 지향 처리</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/mvcproject1/"><div class="card-body"> <span class="timeago small" > Jun 1, 2021 <i class="unloaded">2021-06-01T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(1)</h3><div class="text-muted small"><p> 프로젝트 목표 스프링 부트를 이용하여 간단한 게시판 페이지를 만들어 보려한다. 그리고 이를 AWS의 EC2를 이용하여 직접 라이브 서버에 띄워보는 것을 목표로 한다. 초기 설정 JDK 버전은 11에 해당하며, 스프링 부트의 버전은 2.4.7을 사용했다. 불러온 라이브러리들은 lombok, devtool, web, dataJpa 마지막으로 템플...</p></div></div></a></div><div class="card"> <a href="/posts/mvcporject2/"><div class="card-body"> <span class="timeago small" > Jun 2, 2021 <i class="unloaded">2021-06-02T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(2)</h3><div class="text-muted small"><p> 이전 글 이전글 에서는 Account 클래스를 만들고 이에 Spring Security를 적용하여 로그인과 회원가입을 진행해보았다. 이번시간에는 Account와 관련된 기능들을 좀 더 다듬고, MockMvc를 이용해 테스트를 진행해 보려한다. Account 다듬기 회원가입 - 추가 1 지난 시간, 회원가입에 추가하지 않은 로직이 존재한다. 바로...</p></div></div></a></div><div class="card"> <a href="/posts/mvcproject3/"><div class="card-body"> <span class="timeago small" > Jun 3, 2021 <i class="unloaded">2021-06-03T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(3)</h3><div class="text-muted small"><p> 이전 글 이전글 에서는 Account와 관련된 기능들을 좀 더 다듬고, MockMvc를 이용해 테스트를 진행해 보았다. 이번 시간에는 Account의 정보 수정을 구현하고 Post라는 엔티티를 정의해보려한다. Account 정보 수정 정보변경에 대한 기능은 프론트뷰에선 다음과 같이 위치해 있으며 클릭시 URI는 “/settings”에 해당한다...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/boj1786/" class="btn btn-outline-primary" prompt="Older"><p>백준 1786 찾기 with Python</p></a> <a href="/posts/boj4354/" class="btn btn-outline-primary" prompt="Newer"><p>백준 4354 문자열 제곱 with Python</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">vitriol</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://vitriol95.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
