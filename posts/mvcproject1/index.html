<!DOCTYPE html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="스프링 mvc 프로젝트 + AWS EC2에 빌드까지(1)" /><meta property="og:locale" content="ko" /><meta name="description" content="프로젝트 목표 스프링 부트를 이용하여 간단한 게시판 페이지를 만들어 보려한다. 그리고 이를 AWS의 EC2를 이용하여 직접 라이브 서버에 띄워보는 것을 목표로 한다." /><meta property="og:description" content="프로젝트 목표 스프링 부트를 이용하여 간단한 게시판 페이지를 만들어 보려한다. 그리고 이를 AWS의 EC2를 이용하여 직접 라이브 서버에 띄워보는 것을 목표로 한다." /><link rel="canonical" href="https://vitriol95.github.io/posts/mvcproject1/" /><meta property="og:url" content="https://vitriol95.github.io/posts/mvcproject1/" /><meta property="og:site_name" content="Vitriol" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-01T11:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="스프링 mvc 프로젝트 + AWS EC2에 빌드까지(1)" /><meta name="twitter:site" content="@" /><meta name="google-site-verification" content="QsbP4NOwVkaE8CnHpYOl-qNGhxB9m1RbsrBEefA92ao" /> <script type="application/ld+json"> {"headline":"스프링 mvc 프로젝트 + AWS EC2에 빌드까지(1)","dateModified":"2021-06-01T11:00:00+09:00","datePublished":"2021-06-01T11:00:00+09:00","description":"프로젝트 목표 스프링 부트를 이용하여 간단한 게시판 페이지를 만들어 보려한다. 그리고 이를 AWS의 EC2를 이용하여 직접 라이브 서버에 띄워보는 것을 목표로 한다.","url":"https://vitriol95.github.io/posts/mvcproject1/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://vitriol95.github.io/posts/mvcproject1/"},"@context":"https://schema.org"}</script><title>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(1) | Vitriol</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Vitriol"><meta name="application-name" content="Vitriol"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-WSY4XYN711"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-WSY4XYN711'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Vitriol</a></div><div class="site-subtitle font-italic">기억을 적는 시간</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/vitriol95" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['vitriol951','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(1)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(1)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> vitriol </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Jun 1, 2021, 11:00 AM +0900" prep="on" > Jun 1, 2021 <i class="unloaded">2021-06-01T11:00:00+09:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3677 words">20 min</span></div></div><div class="post-content"><h1 id="프로젝트-목표">프로젝트 목표</h1><hr /><p>스프링 부트를 이용하여 간단한 게시판 페이지를 만들어 보려한다. 그리고 이를 AWS의 EC2를 이용하여 직접 라이브 서버에 띄워보는 것을 목표로 한다.</p><h1 id="초기-설정">초기 설정</h1><hr /><p>JDK 버전은 11에 해당하며, 스프링 부트의 버전은 2.4.7을 사용했다. 불러온 라이브러리들은 <strong>lombok, devtool, web, dataJpa</strong> 마지막으로 템플릿으로 사용할 <strong>thymeleaf</strong> 까지 가져오도록 하였다.</p><blockquote><p>개발단계에서는 데이터베이스로 h2를 사용하고, 이를 실제로 띄울 때에는 MySQL이나 MariaDB를 사용할 예정이다.</p></blockquote><div class="language-groovy highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="c1">// build.gradle</span>
<span class="n">plugins</span> <span class="o">{</span>
    <span class="n">id</span> <span class="s1">'org.springframework.boot'</span> <span class="n">version</span> <span class="s1">'2.4.7'</span>
    <span class="n">id</span> <span class="s1">'io.spring.dependency-management'</span> <span class="n">version</span> <span class="s1">'1.0.11.RELEASE'</span>
    <span class="n">id</span> <span class="s1">'java'</span>
<span class="o">}</span>

<span class="n">group</span> <span class="o">=</span> <span class="s1">'vitriol'</span>
<span class="n">version</span> <span class="o">=</span> <span class="s1">'0.0.1-SNAPSHOT'</span>
<span class="n">sourceCompatibility</span> <span class="o">=</span> <span class="s1">'11'</span>

<span class="n">configurations</span> <span class="o">{</span>
    <span class="n">compileOnly</span> <span class="o">{</span>
        <span class="n">extendsFrom</span> <span class="n">annotationProcessor</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">repositories</span> <span class="o">{</span>
    <span class="n">mavenCentral</span><span class="o">()</span>
    <span class="n">jcenter</span><span class="o">()</span>
<span class="o">}</span>

<span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-data-jpa'</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-thymeleaf'</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-web'</span>
    <span class="n">compileOnly</span> <span class="s1">'org.projectlombok:lombok'</span>
    <span class="n">developmentOnly</span> <span class="s1">'org.springframework.boot:spring-boot-devtools'</span>
    <span class="n">annotationProcessor</span> <span class="s1">'org.projectlombok:lombok'</span>
    <span class="n">testImplementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-test'</span>
<span class="o">}</span>

<span class="n">test</span> <span class="o">{</span>
    <span class="n">useJUnitPlatform</span><span class="o">()</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>Repository에 jcenter()또한 추가해 주었다. Intellij 사용시 Enable Annotation Processor를 체크해주는 것 또한 잊지 말자.</p></blockquote><h2 id="index-확인">index 확인</h2><p>이후, 컨트롤러 체크를 위해 index페이지를 만들어 보았고(resources -&gt; templates -&gt; index.html) 간단한 컨트롤러를 만들어 실행시켜 보았다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">vitriol.mvcservice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainController</span> <span class="o">{</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">main</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"index"</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><div class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c">&lt;!-- index.html 파일에 해당한다. 자주쓸 head나 네비게이션들은 fragment처리를 해두었다. --&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span>
      <span class="na">xmlns:sec=</span><span class="s">"http://thymeleaf.org/extras/spring-security"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head</span> <span class="na">th:replace=</span><span class="s">"fragments.html :: head"</span><span class="nt">&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;nav</span> <span class="na">th:replace=</span><span class="s">"fragments.html :: main-nav"</span><span class="nt">&gt;&lt;/nav&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></table></code></div></div><blockquote><p>프론트에 관련된 프로젝트가 아니기에, 이에 대한 설명은 최소화 하고 넘어가도록 하겠다. 나중에 spring Security적용을 할것이므로 이에 대한 프론트 태그(4라인)도 미리 추가해 두었다.</p></blockquote><p><br /> 어플리케이션을 시작하고, 메인화면(“/”)이 잘 실행되는지 확인해보자.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/1.JPG" /></p><blockquote><p>순조롭게 진행됨을 확인할 수 있다. 아직은 main-nav만 보인다.</p></blockquote><hr /><h1 id="엔티티-만들기---사용자">엔티티 만들기 - 사용자</h1><p>‘사용자’ 즉, Account 엔티티는 다음과 같은 역할을 한다.</p><ol><li>로그인된 사용자만 글을 작성하고, 볼 수 있다. 댓글도 마찬가지이다.<li>가입할때는 이메일 주소와 비밀번호, 사용할 닉네임을 작성해야한다.<li>다른 프로퍼티로는 ,프로필 이미지를 지정할 수 있으며 짧은 소개글 또한 적을 수 있다.</ol><blockquote><p>사용자의 ‘Authentication’과정이 필요하게 되므로 Spring security가 필요하게 된다. 또한 이를 저장해둘 h2의 플러그인도 필요하다.</p></blockquote><p>Account 객체를 만들기 전 다음과 같이 build.gradle 설정을 추가해준다.</p><div class="language-groovy highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">dependencies</span> <span class="o">{</span>
    <span class="c1">// 이전 build.gradle에 추가</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-security'</span>
    <span class="n">implementation</span> <span class="s1">'org.thymeleaf.extras:thymeleaf-extras-springsecurity5'</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-validation:2.4.0'</span>
    <span class="n">implementation</span> <span class="s1">'org.modelmapper:modelmapper:2.3.7'</span>
    <span class="n">runtimeOnly</span> <span class="s1">'com.h2database:h2:1.3.176'</span> <span class="c1">// h2</span>
    <span class="n">testImplementation</span> <span class="s1">'org.springframework.security:spring-security-test'</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>클래스간의 변환을 자유롭게 해주는 model mapper또한 가져왔다.</p></blockquote><p><br /> 그리고 h2데이터베이스에 관한 설정을 해줄 application.yml파일도 다음과 같이 맞추어준다.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1"># application.yml</span>
<span class="na">spring</span><span class="pi">:</span>
  <span class="na">h2</span><span class="pi">:</span>
    <span class="na">console</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">settings</span><span class="pi">:</span>
        <span class="na">web-allow-others</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">/h2-console</span>
  <span class="na">jpa</span><span class="pi">:</span>
    <span class="na">hibernate</span><span class="pi">:</span>
      <span class="na">ddl-auto</span><span class="pi">:</span> <span class="s">create</span>
    <span class="na">show-sql</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">datasource</span><span class="pi">:</span>
    <span class="na">driver-class-name</span><span class="pi">:</span> <span class="s">org.h2.Driver</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">sa</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">jdbc:h2:mem:testdb</span>
    <span class="na">password</span><span class="pi">:</span>
</pre></table></code></div></div><p><br /> 준비는 모두 끝났으므로, 앞서 이야기한 사항들을 적용해 Account 객체를 만들어보자.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">vitriol.mvcservice.modules.account</span><span class="o">;</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"account"</span><span class="o">)</span>
<span class="nd">@EqualsAndHashCode</span><span class="o">(</span><span class="n">of</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">nickname</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">bio</span><span class="o">;</span>

    <span class="nd">@Lob</span>
    <span class="nd">@Basic</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">EAGER</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">profileImage</span><span class="o">;</span>
    
<span class="o">}</span>
</pre></table></code></div></div><p>특별한 점이 있다면 31번째 라인인 profileImage 프로퍼티에 대한 설정이다. 프로필이미지는 대용량값에 해당하기에 @Lob 을 붙혀주었으며, 이는 항상 사용자를 보일때 같이 보여줄 예정이므로 Eager로 Fetch하도록 하였다.</p><blockquote><p>그리고, 중복된 이메일이나 닉네임으로 가입할 수 없도록 unique옵션을 주었다.</p></blockquote><hr /><h2 id="회원가입-기능-구현">회원가입 기능 구현</h2><p>가장 먼저, 회원가입에 해당하는 뷰는 다음과 같다. URI는 /sign-up에 해당한다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/2.JPG" /></p><p>여기에서는 사용자의 이메일, 닉네임 패스워드를 입력받아야한다. 이메일과 패스워드는 로그인을 할 때에 사용되는 정보에 해당하며, 중복된 이메일과 닉네임이 있을시에는 가입을 못하게 막아야한다.</p><p><br /> 뷰에서 보여지는 폼으로부터 전달될 정보를 담을 객체가 필요하게 된다. 즉 Dto가 필요하다. 필자는 이를 ‘SignUpForm’이라는 클래스로 만들어보았다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">vitriol.mvcservice.modules.account.form</span><span class="o">;</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SignUpForm</span> <span class="o">{</span>

    <span class="nd">@Email</span>
    <span class="nd">@NotBlank</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="nd">@NotEmpty</span>
    <span class="nd">@Length</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">3</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="o">)</span>
    <span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">"^[ㄱ-ㅎ가-힣a-z0-9_-]{3,20}$"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">nickname</span><span class="o">;</span>

    <span class="nd">@NotBlank</span>
    <span class="nd">@Length</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">8</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">50</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>javax.validation 의 기능들을 이용하여 제약을 두고있다. 각각의 형식이나 길이를 제한하고 있으며, 닉네임의 경우엔 정규표현식을 이용하여 ‘한글,영어,숫자,언더바 및 스코어’까지 3~20글자 허용한다.</p></blockquote><p><br /> 이제 실제 /sign-up 으로 Post요청이 들어올 시 컨트롤러를 구현해보자.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">vitriol.mvcservice.modules.account</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AccountService</span> <span class="n">accountService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/sign-up"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">signUpForm</span><span class="o">(</span><span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"signUpForm"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SignUpForm</span><span class="o">());</span>
        <span class="k">return</span> <span class="s">"account/sign-up"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/sign-up"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">signUpFormSubmit</span><span class="o">(</span><span class="nd">@Valid</span> <span class="nd">@ModelAttribute</span> <span class="nc">SignUpForm</span> <span class="n">signUpForm</span><span class="o">,</span> <span class="nc">Errors</span> <span class="n">errors</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">errors</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"account/sign-up"</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span><span class="na">createNewAccount</span><span class="o">(</span><span class="n">signUpForm</span><span class="o">);</span>
        <span class="n">accountService</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"redirect:/"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>@PostMapping으로 받아와야하는 인자들은 www-form-urlencoded의 형태로 들어오는 것에 해당하기에 @ModelAttribute를 사용해주었고, 이 과정에서 입력값으로 인해 발생하는 오류를 바인딩 해주는 validation의 Error를 함께 가져와주었다.</p></blockquote><p><br /> 에러가 없다면 폼을 서비스단으로 넘겨 회원가입을 진행시키고, 이후에 자동으로 로그인 되도록 하였다. (32~33라인) 이제 서비스단의 메서드를 확인해보자.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">vitriol.mvcservice.modules.account</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AccountRepository</span> <span class="n">accountRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">BCryptPasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ModelMapper</span> <span class="n">modelMapper</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Account</span> <span class="nf">createNewAccount</span><span class="o">(</span><span class="nc">SignUpForm</span> <span class="n">signUpForm</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">signUpForm</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">signUpForm</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()));</span>
        <span class="nc">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">modelMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">signUpForm</span><span class="o">,</span> <span class="nc">Account</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>역시 AccountRepository또한 필요하다. 이는 JpaRepository를 extend한 인터페이스로 정의해 주었기에 기본 기능으로 save를 가지고 있다.</p></blockquote><p><br /> createNewMethod의 경우는 회원가입 폼을 전달받아 패스워드를 인코딩해주고, 이를 실제 Account클래스로 매핑시켜준뒤, 저장소에 저장하는 기능만 가지고 있다.</p><p><br /> 이때 BCrpytPasswordEncoder와 ModelMapper를 주입받고 있는데, 이 주입받는 객체 역시 스프링 빈으로 등록 되어 있어야 한다. 이는 AppConfig라는 클래스에 정의해 두었다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">vitriol.mvcservice.config</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">BCryptPasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ModelMapper</span> <span class="nf">modelMapper</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ModelMapper</span> <span class="n">modelMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ModelMapper</span><span class="o">();</span>
        <span class="n">modelMapper</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">()</span>
                <span class="o">.</span><span class="na">setDestinationNameTokenizer</span><span class="o">(</span><span class="nc">NameTokenizers</span><span class="o">.</span><span class="na">UNDERSCORE</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setSourceNameTokenizer</span><span class="o">(</span><span class="nc">NameTokenizers</span><span class="o">.</span><span class="na">UNDERSCORE</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">modelMapper</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>modelMapper의 경우를 보면 Tokenizer 단위를 “_” 단위로 끊고있다. 이는 데이터베이스의 네이밍 방식때문에 그렇다. 자바의 경우는 CamelCase와 다른방식에 해당한다.</p></blockquote><p><br /> 다시 서비스로 돌아와서 이번엔 로그인 시켜주는 메서드를 만들어보자.</p><hr /><h2 id="로그인-기능-구현">로그인 기능 구현</h2><p>로그인 기능을 구현할 때, 가장 먼저 스프링 시큐리티 설정을 진행해주어야 한다. 이에 대한 Configuration을 해주는 클래스인 SecurityConfig라는 클래스를 다음과 같이 생성하였다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">vitriol.mvcservice.config</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">WebSecurity</span> <span class="n">web</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="n">web</span>
                <span class="o">.</span><span class="na">ignoring</span><span class="o">()</span>
                <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">"/img/**"</span><span class="o">,</span><span class="s">"/h2-console/**"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nc">PathRequest</span><span class="o">.</span><span class="na">toStaticResources</span><span class="o">().</span><span class="na">atCommonLocations</span><span class="o">());</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="n">http</span>
                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">"/"</span><span class="o">,</span> <span class="s">"/login"</span><span class="o">,</span> <span class="s">"/sign-up"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">()</span>
                <span class="o">.</span><span class="na">authenticated</span><span class="o">();</span>

        <span class="n">http</span>
                <span class="o">.</span><span class="na">formLogin</span><span class="o">()</span>
                <span class="o">.</span><span class="na">loginPage</span><span class="o">(</span><span class="s">"/login"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">();</span>

        <span class="n">http</span>
                <span class="o">.</span><span class="na">logout</span><span class="o">()</span>
                <span class="o">.</span><span class="na">logoutSuccessUrl</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>

        <span class="n">http</span>
                <span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">frameOptions</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>가장먼저 메인페이지(“/”)와 로그인, 회원가입 기능은 모두 접근가능하도록 열어두었다. 이외에는 모두 인증과정(로그인)이 필요하다.</p></blockquote><p><br /> 필자의 경우는 시큐리티가 제공하는 로그인 페이지말고, 직접 커스텀한 로그인페이지를 사용할 것이기에 26 ~ 28 라인에서 이를 직접 정의해주었다.</p><blockquote><p>추가로, 34~35라인은 /h2-console에 접근하기 위해 프레임옵션을 꺼둔것에 해당한다.</p></blockquote><p><br /> 또한 로그인 뷰 페이지는 다음과 같다. URI는 /login에 해당한다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/3.JPG" /></p><p>이때 전달받은 두 값으로 부터 실제 Account를 판별하는 과정이 필요하다. 우리는 Authentication 진행할 객체가 Account에 해당하므로 security.core.userdetails의 User를 상속받은 인증객체가 필요하다. 필자는 이를 ‘UserAccount’라는 클래스로 만들어 두었다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">vitriol.mvcservice.modules.account</span><span class="o">;</span>

<span class="nd">@Getter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserAccount</span> <span class="kd">extends</span> <span class="nc">User</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">Account</span> <span class="n">account</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">UserAccount</span><span class="o">(</span><span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getEmail</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleGrantedAuthority</span><span class="o">(</span><span class="s">"ROLE_USER"</span><span class="o">)));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">account</span> <span class="o">=</span> <span class="n">account</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>User 클래스를 상속받았으므로, 이것이 Principal 객체에 해당하게 된다.</p></blockquote><p><br /> 이후, 실제 Authentication을 진행할 때 이러한 principal을 가져오기 위한 메서드가 필요하다. 우리는 로그인시 입력한 email값을 기준으로 이러한 principal들을 불러와야 한다. 이 기능은 UserDetailService의 loadByUsername에 해당하며, 필자는 이를 AccountService에 오버라이딩 하여 진행하였다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountService</span> <span class="kd">implements</span> <span class="nc">UserDetailsService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AccountRepository</span> <span class="n">accountRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">BCryptPasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ModelMapper</span> <span class="n">modelMapper</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Account</span> <span class="nf">createNewAccount</span><span class="o">(</span><span class="nc">SignUpForm</span> <span class="n">signUpForm</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">signUpForm</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">signUpForm</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()));</span>
        <span class="nc">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">modelMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">signUpForm</span><span class="o">,</span> <span class="nc">Account</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="nc">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">account</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UsernameNotFoundException</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">UserAccount</span><span class="o">(</span><span class="n">account</span><span class="o">);</span> <span class="c1">// principal</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">login</span><span class="o">(</span><span class="nc">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">UsernamePasswordAuthenticationToken</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserAccount</span><span class="o">(</span><span class="n">account</span><span class="o">),</span> <span class="n">account</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleGrantedAuthority</span><span class="o">(</span><span class="s">"ROLE_USER"</span><span class="o">)));</span>
        <span class="nc">SecurityContext</span> <span class="n">context</span> <span class="o">=</span> <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
        <span class="n">context</span><span class="o">.</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>리포지토리는 다음과 같은 메서드들을 가지고 있다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">vitriol.mvcservice.modules.account</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>

<span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Account</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kt">boolean</span> <span class="nf">existsByEmail</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="nf">existsByNickname</span><span class="o">(</span><span class="nc">String</span> <span class="n">nickname</span><span class="o">);</span>
    <span class="nc">Account</span> <span class="nf">findByEmail</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">);</span>
<span class="o">}</span>

</pre></table></code></div></div><p><br /> 17라인부터 시작하는 loadByUsername 메서드를 한번 살펴보자. 패스워드가 맞는지에 대한 여부는 스프링 시큐리티가 진행해주고 있으므로 우리는 그에 맞는 principal 객체를 전달해주어야 한다.</p><ol><li>로그인 폼으로부터 입력받은 이메일 정보를 accountRepository에서 찾게 된다.<li>만약 그러한 이메일이 존재하지 않을시, 예외를 던져준다.<li>그러한 이메일이 있고, 패스워드가 맞다면 Principal 객체를 반환한다. 이는 앞서 우리가 만들어둔 UserAccount 클래스에 해당한다.<blockquote><p>이 Principal 객체는 내부에 Account를 가지고있다. 따라서 우리는 SecurityContextHolder를 통해 로그인된 유저의 이메일, 닉네임등을 가져올 수 있다.</p></blockquote></ol><p><br /> 이후 25라인부터 시작되는 로그인을 살펴보자.</p><ol><li>SecurityContext에 넣을 Token 객체를 생성해 주어야 한다. 이때의 파라미터는 Principal과 패스워드, Role(Authorization)에 해당한다.<li>SecurityContextHolder에 이 Token을 넣어주어 Authentication 과정을 끝낸다.</ol><p><br /> 🤥 이때, 이러한 생각이 들 수 있다. 지금의 과정은 회원가입 이후 자동으로 로그인 되는 로직에 해당한다. 따라서 login메서드로 오기전에는 이미 ‘회원가입을 할 수 있는 객체’라는 인증이 되어있는 상태에 해당한다. 그런데, 우리가 만든뷰(‘/login’)으로 Post요청이 들어올 땐 어떻게 될까?</p><p><br /> 결론적으로 말하자면, 이는 <strong>스프링 시큐리티가 알아서 처리를 해준다</strong> 이다. 우리가 직접 구현해야할 코드를 줄여주는 매우 훌륭한 기능을 제공한다. 로그인폼으로 이메일과 패스워드를 입력받으면 오버라이딩한 loadUserByUsername으로 해당 이메일에 해당하는 Account가 있는지 탐색하고, 이에 대한 Password Matching까지 시켜주는 것이다.</p><p><br /> 하지만, 아주 주의해야할 점이 존재한다. 우리는 시큐리티가 제공하는 login 폼이 아닌 새롭게 정의한 login폼을 사용하고 있다. 이때, 폼을 다음과 같이 주어야한다.</p><div class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c">&lt;!-- login.html 중 일부--&gt;</span>

<span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"needs-validation col-sm-6"</span> <span class="na">action=</span><span class="s">"#"</span> <span class="na">th:action=</span><span class="s">"@{/login}"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">novalidate</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"username"</span><span class="nt">&gt;</span>이메일<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"username"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">class=</span><span class="s">"form-control"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"password"</span><span class="nt">&gt;</span>패스워드<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"password"</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">class=</span><span class="s">"form-control"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"btn btn-success btn-block"</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
        로그인
        <span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></table></code></div></div><p>바로 form의 input자식들에 대한 id 값인데 반드시 username과 password로 설정해주어야 한다(7, 11라인). 스프링 시큐리티는 이 두가지값을 파싱하여 앞선 절차를 진행해준다.</p><p><br /> 여기까지 진행되었다면 간단히 확인만 해보자. 이메일을 vitriol95@snu.ac.kr, 닉네임을 vitriol95로 설정하고 회원가입을 진행했다. 이후 h2-console로 들어가서 이 값이 제대로 있는지 확인해보자.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/4.JPG" /></p><p>잘 전달되었다. 비밀번호 또한 해싱되어 저장되있는 것을 확인할 수 있다.</p><p><br /> 다음편에서는 Account와 관련된 클래스들을 좀 더 다듬고, 이들의 테스트를 진행해 볼 예정이다.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/spring/'>Spring</a>, <a href='/categories/spring-project/'>spring_project</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring/" class="post-tag no-text-decoration" >spring</a> <a href="/tags/spring-mvc/" class="post-tag no-text-decoration" >spring mvc</a> <a href="/tags/springboot/" class="post-tag no-text-decoration" >springboot</a> <a href="/tags/springframework/" class="post-tag no-text-decoration" >springframework</a> <a href="/tags/java/" class="post-tag no-text-decoration" >java</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(1) - Vitriol&url=https://vitriol95.github.io/posts/mvcproject1/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(1) - Vitriol&u=https://vitriol95.github.io/posts/mvcproject1/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(1) - Vitriol&url=https://vitriol95.github.io/posts/mvcproject1/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/batchbase1/">스프링 배치 - 1 스프링 배치란?</a><li><a href="/posts/batchbase2/">스프링 배치 - 2 DB 스키마에 대한 이해</a><li><a href="/posts/batchbase3/">스프링 배치 - 3 도메인 뜯어보기(JOB)</a><li><a href="/posts/batchbase4/">스프링 배치 - 4 도메인 뜯어보기(STEP)</a><li><a href="/posts/batchbase5/">스프링 배치 - 5 청크 지향 처리</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/mvcporject2/"><div class="card-body"> <span class="timeago small" > Jun 2, 2021 <i class="unloaded">2021-06-02T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(2)</h3><div class="text-muted small"><p> 이전 글 이전글 에서는 Account 클래스를 만들고 이에 Spring Security를 적용하여 로그인과 회원가입을 진행해보았다. 이번시간에는 Account와 관련된 기능들을 좀 더 다듬고, MockMvc를 이용해 테스트를 진행해 보려한다. Account 다듬기 회원가입 - 추가 1 지난 시간, 회원가입에 추가하지 않은 로직이 존재한다. 바로...</p></div></div></a></div><div class="card"> <a href="/posts/mvcproject3/"><div class="card-body"> <span class="timeago small" > Jun 3, 2021 <i class="unloaded">2021-06-03T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(3)</h3><div class="text-muted small"><p> 이전 글 이전글 에서는 Account와 관련된 기능들을 좀 더 다듬고, MockMvc를 이용해 테스트를 진행해 보았다. 이번 시간에는 Account의 정보 수정을 구현하고 Post라는 엔티티를 정의해보려한다. Account 정보 수정 정보변경에 대한 기능은 프론트뷰에선 다음과 같이 위치해 있으며 클릭시 URI는 “/settings”에 해당한다...</p></div></div></a></div><div class="card"> <a href="/posts/mvcproject4/"><div class="card-body"> <span class="timeago small" > Jun 4, 2021 <i class="unloaded">2021-06-04T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(4)</h3><div class="text-muted small"><p> 이전 글 이전글 에서는 Post 엔티티를 정의하고 이를 등록, 수정, 삭제하는 과정을 진행하였다. 이번 시간에는 저번 시간에 이어 부족한 부분들을 채워보고, 테스트를 진행한뒤, Reply엔티티까지 만들어 보겠다. Account 정보 수정관련 추가 이전 닉네임을 변경할 때, ProfileFormValidator 라는 클래스의 validate (...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/boj6198/" class="btn btn-outline-primary" prompt="Older"><p>백준 6198 옥상 정원 꾸미기 with Python</p></a> <a href="/posts/boj2098/" class="btn btn-outline-primary" prompt="Newer"><p>백준 2098 외판원 순회 with Python</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">vitriol</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://vitriol95.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
