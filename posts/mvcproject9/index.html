<!DOCTYPE html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="스프링 mvc 프로젝트 + AWS EC2에 빌드까지(9) 배포시작" /><meta property="og:locale" content="ko" /><meta name="description" content="이전 글" /><meta property="og:description" content="이전 글" /><link rel="canonical" href="https://vitriol95.github.io/posts/mvcproject9/" /><meta property="og:url" content="https://vitriol95.github.io/posts/mvcproject9/" /><meta property="og:site_name" content="Vitriol" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-09T11:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="스프링 mvc 프로젝트 + AWS EC2에 빌드까지(9) 배포시작" /><meta name="twitter:site" content="@" /><meta name="google-site-verification" content="QsbP4NOwVkaE8CnHpYOl-qNGhxB9m1RbsrBEefA92ao" /> <script type="application/ld+json"> {"headline":"스프링 mvc 프로젝트 + AWS EC2에 빌드까지(9) 배포시작","dateModified":"2021-06-09T11:00:00+09:00","datePublished":"2021-06-09T11:00:00+09:00","description":"이전 글","url":"https://vitriol95.github.io/posts/mvcproject9/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://vitriol95.github.io/posts/mvcproject9/"},"@context":"https://schema.org"}</script><title>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(9) 배포시작 | Vitriol</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Vitriol"><meta name="application-name" content="Vitriol"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-WSY4XYN711"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-WSY4XYN711'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Vitriol</a></div><div class="site-subtitle font-italic">기억을 적는 시간</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/vitriol95" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['vitriol951','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(9) 배포시작</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(9) 배포시작</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> vitriol </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Jun 9, 2021, 11:00 AM +0900" prep="on" > Jun 9, 2021 <i class="unloaded">2021-06-09T11:00:00+09:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2441 words">13 min</span></div></div><div class="post-content"><h1 id="이전-글">이전 글</h1><p><a href="https://vitriol95.github.io/posts/mvcproject8/">이전글</a> 에서는 최종 코드를 정리해 보았고, 이번시간부터는 직접 AWS EC2에 빌드해보도록 하겠다. AMI는 아마존 Linux 2를 사용하였다.</p><hr /><h1 id="ec2-생성-및-접속">EC2 생성 및 접속</h1><p>Amazon Linux 2 를 인스턴스 AMI로 사용하였고, 필자의 OS는 윈도우 이므로(맥을 꼭 사야겠다..) SSH로 원격 터미널 접속을 도와주는 putty프로그램을 이용해 조작할 예정이다.</p><p><br /> 접속에 성공하였다면, 가장 먼저 리눅스 내부에 자바를 설치해주어야 한다. 프로젝트의 jdk 버전은 11에 해당하므로 이에 맞는 버전을 설치해주어야 한다. 따라서 리눅스 콘솔창에 다음과 같이 입력해준다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>sudo amazon-linux-extras install open-jdk11
</pre></table></code></div></div><p>이후에, 혹시 amazon linux에서 제공하는 다른 jdk가 깔려있는지 확인하기 위해 자바 버전을 살펴보도록 하자. (java 환경 변수를 지금 설치한 jdk11으로 바꾸어놓자.)</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>sudo /usr/sbin/alternatives --config java
</pre></table></code></div></div><p>다음과 같이 창이 뜬다. 아까 설치한 1개의 Java만이 깔려있었고, 이는 이미 현재 버전값으로 사용하고 있으므로 넘어가면 된다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/37.JPG" /></p><p>마지막으로 버전을 확인해 보자</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>java -version
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/38.JPG" /></p><p>성공적으로 설치및 적용이 되었다.</p><h2 id="타임존-설정">타임존 설정</h2><p>이후, EC2 서버의 타임존을 한국으로 변경해야 한다. 현재 Ec2내 시각을 확인하고 싶다면 <code class="language-plaintext highlighter-rouge">date</code>명령어만 입력하면 바로 알 수 있다. 이를 변경하기 위해 다음과 같은 작업을 실시하였다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>sudo vi /etc/sysconfig/clock

ZONE="Asia/Seoul" 로 변경
</pre></table></code></div></div><blockquote><p>관리자 권한으로 들어가야 하는 이유는 clock이라는 파일은 readonly이기 때문이다.</p></blockquote><p>이후 표준 시간대 파일을 찾을 수 있도록 원본 대상파일을 대상 디렉토리에 링크파일을 생성해 둔다. 바로가기 같은 개념이라 볼 수 있다. 마지막으로 적용을 위해 재부팅 해준다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>sudo ln -sf /usr/share/zoneinfo/Asia/Seoul /etc/localtime 
sudo reboot
</pre></table></code></div></div><blockquote><p>다시 켜서 date명령어를 이용해 확인하면 시간대가 변경된 것을 확인할 수 있다.</p></blockquote><hr /><h2 id="호스트-네임-변경">호스트 네임 변경</h2><p><a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/set-hostname.html">AWS EC2 공식유저가이드</a> 를 참조하였다.</p><p><br /> 가장 먼저 호스트 이름 업데이트를 유지하기 위해 다음과 같은 명령어를 수행해준다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>sudo vi /etc/cloud/cloud.cfg

preserve_hostname: true &lt;&lt; 추가
</pre></table></code></div></div><p>이후 실제 호스트네임을 변경해 보겠다. 이때 아마존 리눅스2에서 제공하는 hostnamectl 명령을 이용하여 진행한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>sudo hostnamectl set-hostname 쓰고싶은이름.localdomain

sudo vi /etc/hosts

127.0.0.1 쓰고싶은이름.localdomain 쓰고싶은이름 localhost4 localhost4.localdomain4

sudo reboot
</pre></table></code></div></div><blockquote><p>etc/hosts를 에디터로 열고 항목을 수정해주어야 한다. 이후 재부팅한다. 필자의 경우는 이름을 mvcservice라고 하였다.</p></blockquote><p><br /> 재부팅이 완료되었다면 hostname을 이용해 정규화된 도메인 이름이 표시되는지 까지 확인해 보자</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/39.JPG" /></p><p>잘 적용이 되었다.</p><hr /><h1 id="rds-인스턴스-생성-및-적용">RDS 인스턴스 생성 및 적용</h1><p>RDS인스턴스의 엔진 옵션으로 MariaDB를 적용하도록 하겠다. 이는 Amazon Aurora와도 호환이 잘 되기에 MySQL보다 훨씬 범용적이다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/40.JPG" /></p><p>생성이 되었다면 파라미터 그룹을 할당해준다. 필자는 전에 사용하던 파라미터 그룹을 재사용하겠다. 중요한것은 character 항목들을 utf8mb4로 맞추어 주어야 한다는 것이다. (mariaDB는 항상 이게 골칫거리이긴 하다.)</p><p><br /> 또한 보안그룹을 편집하여 현재 IP와 EC2에서 접근이 가능하게 끔 설정해둔다. 이후, 로컬에서 잘 열리는지 테스트 해보겠다. 이때는 RDS의 엔드포인트로 접근해야한다.</p><p><br /> 필자는 인텔리제이의 database 플러그인을 통해 접속해 보았고, 커넥션이 잘 되고있었다. 이후 새로운 데이터 베이스인 mvcservice를 만들고 이를 use해준다.</p><p><br /> <code class="language-plaintext highlighter-rouge">show variables like 'c%'</code>을 해보면 아직도 char set이 적용되지 않았다.. 따라서 필자는 다음과 같이 세부적인 수정을 해주었다.</p><div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">alter</span> <span class="k">database</span> <span class="n">mvcservice</span>
<span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="o">=</span> <span class="s1">'utf8mb4'</span>
<span class="k">COLLATE</span> <span class="o">=</span> <span class="s1">'utf8mb4_general_ci'</span><span class="p">;</span>

<span class="k">show</span> <span class="n">variables</span> <span class="k">like</span> <span class="s1">'c%'</span><span class="p">;</span>

<span class="k">SET</span> <span class="n">character_set_filesystem</span> <span class="o">=</span> <span class="s1">'utf8mb4'</span><span class="p">;</span>
<span class="k">SET</span> <span class="n">character_set_server</span> <span class="o">=</span> <span class="s1">'utf8mb4'</span><span class="p">;</span>
<span class="k">SET</span> <span class="n">collation_server</span> <span class="o">=</span> <span class="s1">'utf8mb4_general_ci'</span><span class="p">;</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/42.JPG" /></p><p>이제야 모두 설정되었다..</p><hr /><h2 id="ec2에서-rds접근">EC2에서 RDS접근</h2><p>가장 먼저 EC2에 mysql을 설치해 주어야 한다. 이후 접근해보자.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>sudo yum install mysql

mysql -u 계정 -p -h 엔드포인트
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/43.JPG" /></p><p>접근이 잘되고 있었으며, 앞서 생성한 mvcservice라는 스키마도 존재한다.</p><hr /><h1 id="프로젝트-배포하기">프로젝트 배포하기</h1><p>필자는 현재 git을 이용해 버전관리를 하고 있으므로, git pull로 파일을 받기 위해 EC2에 git 설치가 필요하다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>sudo yum install git
</pre></table></code></div></div><p>이후 잘 받아졌는지, 버전확인을 진행한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>git --version
</pre></table></code></div></div><p>모두 완료가 되었다면, 프로젝트파일이 위치할 디렉토리를 만들어두자. 필자의 경우에는 /app/vanilla 로 진행하였다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>mkdir ~/app &amp;&amp; mkdir ~/app/vanilla
cd ~/app/vanilla
</pre></table></code></div></div><p>이후 git clone을 따오면 된다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>git clone https://github.com/vitriol95/mvc-service.git
</pre></table></code></div></div><p>이제 배포용 스크립트를 만들어보도록 하자. 여기서는 .sh형식의 쉘스크립트 파일을 vim에디터를 이용해 작성해 보겠다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>vim ~/app/vanilla/deploy.sh
</pre></table></code></div></div><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>
<span class="nv">REPOSITORY</span><span class="o">=</span>/home/ec2-user/app/vanilla
<span class="nv">PROJECT_NAME</span><span class="o">=</span>mvc-service

<span class="nb">cd</span> <span class="nv">$REPOSITORY</span>/<span class="nv">$PROJECT_NAME</span>/
git pull origin master
./gradlew build

<span class="nb">cd</span> <span class="nv">$REPOSITORY</span>
<span class="nb">cp</span> <span class="nv">$REPOSITORY</span>/<span class="nv">$PROJECT_NAME</span>/build/libs/<span class="k">*</span>.jar <span class="nv">$REPOSITORY</span>/

<span class="nv">CURRENT_PID</span><span class="o">=</span><span class="si">$(</span>pgrep <span class="nt">-f</span> <span class="k">${</span><span class="nv">PROJECT_NAME</span><span class="k">}</span>.<span class="k">*</span>.jar<span class="si">)</span>

<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$CURRENT_PID</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"어플리케이션 시작"</span>
<span class="k">else
        </span><span class="nb">kill</span> <span class="nt">-15</span> <span class="nv">$CURRENT_PID</span>
        <span class="nb">sleep </span>5
<span class="k">fi

</span><span class="nv">JAR_NAME</span><span class="o">=</span><span class="si">$(</span><span class="nb">ls</span> <span class="nt">-tr</span> <span class="nv">$REPOSITORY</span>/ | <span class="nb">grep </span>jar | <span class="nb">tail</span> <span class="nt">-n</span> 1<span class="si">)</span>
<span class="nb">nohup </span>java <span class="nt">-jar</span> <span class="nv">$REPOSITORY</span>/<span class="nv">$JAR_NAME</span> 2&gt;&amp;1 &amp;
</pre></table></code></div></div><p>이 배포 스크립트의 흐름은 다음과 같다.</p><ol><li>가장 먼저, 경로와 프로젝트 파일이름을 변수에 저장한다.<li>다음 폴더로 이동한뒤 git pull origin master 명령을 수행한다.<li>이후 jar파일로 build를 실시한다. 만들어진 jar파일을 프로젝트 경로 최상단에 복사하여 접근이 쉽도록 만들어 두었다.<li>이후 현재 다른 어플리케이션이 작동하고 있는지 pgrep 명령을 통해 확인해 본다. 이는 process id를 가져오게 되며 -f 옵션을 주게 되면 프로세스 이름으로 검색한다.<li>분기문으로 들어가게 된다. if 안에 -z 라는 옵션을 주어 현재 스트링이 비어있는 값이면 true에 해당한다. 즉, true가 되는 상황은 “CURRENT_PID”가 없는 상황이므로 바로 실행시키면 된다.<blockquote><p>else인 경우 kill 명령어를 이용해 현재 구동중인 프로세스를 종료시키고 실행하도록 한다.</p></blockquote><li>다음으로는 $()를 이용해 정의된 명령을 수행하고 리턴값을 JAR_NAME에 담아오게 된다. 이때 정의된 명령은 ls이며 -t와 -r옵션을 줌으로써 생성(수정)시간의 역순으로 출력하게 한다.<blockquote><p>이후 grep 명령어를 통해 jar이라는 문자가 포함된 파일을 가져온다. 이어서 tail명령어를 통해 뒤에서 1개줄을 가져오게 된다.</p></blockquote><li>위의 과정을 통해 얻어진 jar 파일을 java명령어를 이용해 실행한다. 터미널세션 연결이 끊어져도 지속적인 동작을 위해 nohup명령어도 넣어주었다. 이때 로그는 nohup.out이라는 파일에 찍히게 된다.<blockquote><p>따라서 맨 뒤에 &amp; 명령을 넣어 background 실행을 할 수 있게 해야하며, 2&gt;&amp;1 옵션을 주어 표준에러(2)를 로그의 표준 출력(1)에 넣어준다. 이렇게 되면 에러메세지는 로그파일에만 남게된다.</p></blockquote></ol><p><br /> 이후 application-real-db.yml 파일을 vim에디터를 이용해 작성해준다. 최상위 디렉토리인 /app에 만들어 주었다.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="s">// application-real-db.yml</span>
<span class="na">spring</span><span class="pi">:</span>
  <span class="na">datasource</span><span class="pi">:</span> 
    <span class="na">url</span><span class="pi">:</span> <span class="s">엔드포인트 및 포트, DB</span>
    <span class="na">username</span><span class="pi">:</span> 
    <span class="na">password</span><span class="pi">:</span> 
    <span class="na">driver-class-name</span><span class="pi">:</span> <span class="s">org.mariadb.jdbc.Driver</span>
  <span class="na">jpa</span><span class="pi">:</span>
    <span class="na">hibernate</span><span class="pi">:</span>
      <span class="na">ddl-auto</span><span class="pi">:</span> <span class="s">none</span>
    <span class="na">properties</span><span class="pi">:</span>
      <span class="na">hibernate</span><span class="pi">:</span>
        <span class="na">default_batch_fetch_size</span><span class="pi">:</span> <span class="m">1000</span>

<span class="na">server</span><span class="pi">:</span>
  <span class="na">tomcat</span><span class="pi">:</span>
    <span class="na">max-http-form-post-size</span><span class="pi">:</span> <span class="s">5MB</span>

</pre></table></code></div></div><p>그리고 deploy.sh 파일을 다음과 같이 수정해 준다.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>vim deploy.sh

<span class="c"># previous code</span>
<span class="nb">nohup </span>java <span class="nt">-jar</span> <span class="nt">-Dsping</span>.config.location<span class="o">=</span>classpath:/application.yml,/home/ec2-user/app/application-real-db.yml <span class="nt">-Dspring</span>.profiles.active<span class="o">=</span>real-db <span class="nt">-jar</span> <span class="nv">$REPOSITORY</span>/<span class="nv">$JAR_NAME</span> 2&gt;&amp;1 &amp;
</pre></table></code></div></div><p>config 파일에 원래있던 application.yml과 함께 vim 에디터를 이용해 만든 yml파일을 추가해준다. 이후, active를 후자로 설정해 둔다.</p><blockquote><p>이 안에는 엔드포인트나, RDS의 이름과 패스워드가 들어가있는 비밀정보에 해당하므로 노출시켜선 안된다.</p></blockquote><p><br /> 이후 ./deploy.sh를 실행하여 실제 프로그램이 EC2 환경에서 잘 돌아가는지 확인하면 된다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/mvcproject/44.JPG" /></p><p>잘 된다!. (개발자가 가장 만족도를 느끼는 순간이 아닐까…) <br /> 다음시간에는 Travis CI를 이용하여 자동 배포를 해보고, 이후 Nginx를 이용하여 중단없는 배포까지 한번 실행해 볼 예정이다.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/spring/'>Spring</a>, <a href='/categories/spring-project/'>spring_project</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring/" class="post-tag no-text-decoration" >spring</a> <a href="/tags/spring-mvc/" class="post-tag no-text-decoration" >spring mvc</a> <a href="/tags/springboot/" class="post-tag no-text-decoration" >springboot</a> <a href="/tags/springframework/" class="post-tag no-text-decoration" >springframework</a> <a href="/tags/java/" class="post-tag no-text-decoration" >java</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(9) 배포시작 - Vitriol&url=https://vitriol95.github.io/posts/mvcproject9/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(9) 배포시작 - Vitriol&u=https://vitriol95.github.io/posts/mvcproject9/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=스프링 mvc 프로젝트 + AWS EC2에 빌드까지(9) 배포시작 - Vitriol&url=https://vitriol95.github.io/posts/mvcproject9/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/batchbase1/">스프링 배치 - 1 스프링 배치란?</a><li><a href="/posts/batchbase2/">스프링 배치 - 2 DB 스키마에 대한 이해</a><li><a href="/posts/batchbase3/">스프링 배치 - 3 도메인 뜯어보기(JOB)</a><li><a href="/posts/batchbase4/">스프링 배치 - 4 도메인 뜯어보기(STEP)</a><li><a href="/posts/batchbase5/">스프링 배치 - 5 청크 지향 처리</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/mvcproject1/"><div class="card-body"> <span class="timeago small" > Jun 1, 2021 <i class="unloaded">2021-06-01T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(1)</h3><div class="text-muted small"><p> 프로젝트 목표 스프링 부트를 이용하여 간단한 게시판 페이지를 만들어 보려한다. 그리고 이를 AWS의 EC2를 이용하여 직접 라이브 서버에 띄워보는 것을 목표로 한다. 초기 설정 JDK 버전은 11에 해당하며, 스프링 부트의 버전은 2.4.7을 사용했다. 불러온 라이브러리들은 lombok, devtool, web, dataJpa 마지막으로 템플...</p></div></div></a></div><div class="card"> <a href="/posts/mvcporject2/"><div class="card-body"> <span class="timeago small" > Jun 2, 2021 <i class="unloaded">2021-06-02T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(2)</h3><div class="text-muted small"><p> 이전 글 이전글 에서는 Account 클래스를 만들고 이에 Spring Security를 적용하여 로그인과 회원가입을 진행해보았다. 이번시간에는 Account와 관련된 기능들을 좀 더 다듬고, MockMvc를 이용해 테스트를 진행해 보려한다. Account 다듬기 회원가입 - 추가 1 지난 시간, 회원가입에 추가하지 않은 로직이 존재한다. 바로...</p></div></div></a></div><div class="card"> <a href="/posts/mvcproject3/"><div class="card-body"> <span class="timeago small" > Jun 3, 2021 <i class="unloaded">2021-06-03T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(3)</h3><div class="text-muted small"><p> 이전 글 이전글 에서는 Account와 관련된 기능들을 좀 더 다듬고, MockMvc를 이용해 테스트를 진행해 보았다. 이번 시간에는 Account의 정보 수정을 구현하고 Post라는 엔티티를 정의해보려한다. Account 정보 수정 정보변경에 대한 기능은 프론트뷰에선 다음과 같이 위치해 있으며 클릭시 URI는 “/settings”에 해당한다...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/boj4354/" class="btn btn-outline-primary" prompt="Older"><p>백준 4354 문자열 제곱 with Python</p></a> <a href="/posts/mvcproject10/" class="btn btn-outline-primary" prompt="Newer"><p>스프링 mvc 프로젝트 + AWS EC2에 빌드까지(10)</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">vitriol</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/python3/">python3</a> <a class="post-tag" href="/tags/boj/">boj</a> <a class="post-tag" href="/tags/problem/">problem</a> <a class="post-tag" href="/tags/%EB%B0%B1%EC%A4%80/">백준</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring-mvc/">spring mvc</a> <a class="post-tag" href="/tags/springframework/">springframework</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://vitriol95.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
